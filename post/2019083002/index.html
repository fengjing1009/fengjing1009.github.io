
<html>
  <head lang="zh">
        <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>
        <meta content="yes" name="apple-mobile-web-app-capable"/>
        <meta content="black" name="apple-mobile-web-app-status-bar-style"/>
        <meta content="telephone=no" name="format-detection"/>
        <meta name="renderer" content="webkit">
    <title>kubernetesèµ„æºé¢„ç•™ | PeterPan</title>
<link href="https://tomcat1009.coding.me/hexo/styles/main.css" type="text/css" rel="stylesheet"/>
<script type="text/javascript" src="https://tomcat1009.coding.me/hexo/media/scripts/jquery.js"></script>
<script type="text/javascript" src="https://tomcat1009.coding.me/hexo/media/scripts/basic.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  </head>

  <body>
     <div class="header">
      <div class="logo_title">
		  
        <div class="title animated fadeInDown"><img src="https://tomcat1009.coding.me/hexo/images/avatar.png?v=1576233831440"/>

          <h1 title="PeterPan" class="weaklink"><a href="/">PeterPan</a>

          </h1>

          <div class="navbar weaklink">
            <div class="normal_nav">

<div class="bitcron_nav_container">


  <div class="bitcron_nav">
    <div class="mixed_site_nav_wrap site_nav_wrap">
		
      <ul class="mixed_site_nav site_nav sm sm-base">
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/hexo" class="selected active current nav__item" >é¦–é¡µ</a>

  </li>
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/hexo/archives" class="selected active current nav__item" >å½’æ¡£</a>

  </li>
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/hexo/tags" class="selected active current nav__item" >æ ‡ç­¾</a>

  </li>
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="https://tomcat1009.coding.me/hexo/post/about/" class="selected active current nav__item" >å…³äº</a>

  </li>
 

      </ul>

      <div class="clear clear_nav_inline_end"></div>

    </div>

  </div>



  <div class="clear clear_nav_end"></div>

</div>

            </div>

            <div class="hamberger"><i class="fa fa-bars"></i>
<i class="fa fa-times"></i>

            </div>

          </div>

        </div>

      </div>

      <div class="hidden_nav animated fadeInDown">

<div class="bitcron_nav_container">


  <div class="bitcron_nav">
    <div class="mixed_site_nav_wrap site_nav_wrap">
      <ul class="mixed_site_nav site_nav sm sm-base">
		  
	
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/hexo" class="selected active current nav__item" >é¦–é¡µ</a>

  </li>


  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/hexo/archives" class="selected active current nav__item" >å½’æ¡£</a>

  </li>


  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/hexo/tags" class="selected active current nav__item" >æ ‡ç­¾</a>

  </li>


  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="https://tomcat1009.coding.me/hexo/post/about/" class="selected active current nav__item" >å…³äº</a>

  </li>





      </ul>

      <div class="clear clear_nav_inline_end"></div>

    </div>

  </div>



  <div class="clear clear_nav_end"></div>

</div>

      </div>

    </div>


    <div class="main">
      <div class="main-inner">


<div class="content">






  <div class="post_page" >

<div class="post">
  <div class="post_title sm_margin">
    <h2><a>kubernetesèµ„æºé¢„ç•™</a>



    </h2>
  </div>

  <div class="post_details">
    <div class="info"><i class="fa fa-clock-o"></i>
<span class="date_info">2019-08-30</span>
<i class="fa fa-eye"></i>

<span class="date_info"><span id="busuanzi_value_page_pv"></span> Views</span>


<i class="fa fa-bookmark-o"></i>
<span class="tags_info weaklink">
	
	<a href="https://tomcat1009.coding.me/hexo/tag/OzrDk-wrZ" class="tag">kubernetes</a>


</span>


    </div>

  </div>





  <div class="post_content markdown"><p class="md_block">
    <span class="md_line md_line_start md_line_end"><blockquote>
<p>ä¸‹é¢å†…å®¹è¿˜å¤„äºæµ‹è¯•é˜¶æ®µï¼Œç”Ÿäº§ä¸Šæ˜¯å¦èƒ½ä¿è¯é›†ç¾¤ç¨³å®šæš‚æ—¶è¿˜ä¸æ¸…æ¥šã€‚ğŸ˜ğŸ˜</p>
</blockquote>
<h2 id="äº‹æ•…">äº‹æ•…</h2>
<p>ä»Šå¤©æˆ‘ä»¬çš„å¼€å‘ç¯å¢ƒç”±äºjavaåº”ç”¨å†…å­˜æŠ¢å åŸå› å¯¼è‡´k8sé›†ç¾¤workerèŠ‚ç‚¹å…¨éƒ¨å®•æœºï¼Œä¸»è¦åŸå› æ˜¯ç¨‹åºå’Œèµ„æºæ²¡è¿›è¡Œé™åˆ¶è§„åˆ’ï¼Œä¸”kubeletä¹Ÿæ²¡é…ç½®èµ„æºé¢„ç•™ï¼Œé‚£hostä¸Šæ‰€æœ‰èµ„æºéƒ½æ˜¯å¯ä»¥ç»™podè°ƒé…ä½¿ç”¨çš„ï¼Œè¿™æ ·å°±å¼•èµ·é›†ç¾¤é›ªå´©æ•ˆåº”ï¼Œæ¯”å¦‚é›†ç¾¤å†…æœ‰ä¸€å°ä¸Šè·‘çš„podæ²¡åšresource limtå¯¼è‡´å ç”¨èµ„æºè¿‡å¤§å¯¼è‡´å°†å®¿ä¸»æœºå‹æ­»äº†ï¼Œæ­¤æ—¶è¿™ä¸ªèŠ‚ç‚¹åœ¨kuberneteså†…å°±æ˜¯ä¸€ä¸ªno readyçš„çŠ¶æ€äº†ï¼Œkubernetesä¼šå°†è¿™å°hostä¸Šæ‰€æœ‰çš„podåœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šé‡å»ºï¼Œä¹Ÿå°±æ„å‘³ç€é‚£ä¸ªæœ‰é—®é¢˜çš„podé‡æ–°è·‘åœ¨å…¶ä»–æ­£å¸¸çš„èŠ‚ç‚¹ä¸Šï¼Œå°†å¦å¤–æ­£å¸¸çš„èŠ‚ç‚¹å‹è·¨ã€‚å¾ªæ€€ä¸‹å»ç›´åˆ°é›†ç¾¤å†…æ‰€æœ‰ä¸»æœºéƒ½æŒ‚äº†ï¼Œè¿™å°±æ˜¯é›†ç¾¤é›ªå´©æ•ˆåº”ã€‚</p>
<h2 id="è§£å†³åŠæ³•">è§£å†³åŠæ³•</h2>
<p>åœ¨kubernetesä¸­å¯ä»¥é€šè¿‡ç»™kubeleté…ç½®å‚æ•°é¢„ç•™èµ„æºç»™ç³»ç»Ÿè¿›ç¨‹å’Œkubernetesè¿›ç¨‹ä¿è¯å®ƒä»¬ç¨³å®šè¿è¡Œã€‚ç›®å‰èƒ½å®ç°åˆ°cpuã€memoryã€ephemeral-storageå±‚é¢çš„èµ„æºé¢„ç•™ã€‚<br>
é‡ç‚¹æä¸¤ç‚¹<br>
cpuï¼šcpuæ˜¯é…ç½®cpu shareså®é™…ä¸Šå¯¹åº”çš„æ˜¯cpuçš„ä¼˜å…ˆçº§ï¼Œç®€å•æ¥è¯´ï¼Œè¿™ä¸ªåœ¨cpuç¹å¿™æ—¶ï¼Œå®ƒèƒ½æœ‰æ›´é«˜ä¼˜å…ˆçº§è·å–æ›´å¤šcpuèµ„æºã€‚</p>
<p>ephemeral-storageæ˜¯kubernetes1.8å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªèµ„æºé™åˆ¶çš„å¯¹è±¡ï¼Œkubernetes 1.10ç‰ˆæœ¬ä¸­kubeleté»˜è®¤å·²ç»æ‰“å¼€çš„äº†,ä¸»è¦æ˜¯ç”¨äºå¯¹æœ¬åœ°ä¸´æ—¶å­˜å‚¨ä½¿ç”¨ç©ºé—´å¤§å°çš„é™åˆ¶ï¼Œå¦‚å¯¹podçš„empty dirã€/var/lib/kubeletã€æ—¥å¿—ã€å®¹å™¨å¯è¯»å†™å±‚çš„ä½¿ç”¨å¤§å°çš„é™åˆ¶ã€‚</p>
<h2 id="é…ç½®">é…ç½®</h2>
<h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3>
<p>åœ¨è®²é…ç½®ä¹‹å‰æˆ‘ä»¬å…ˆäº†è§£å‡ ä¸ªæ¦‚å¿µï¼š</p>
<p>Node capacityï¼šèŠ‚ç‚¹æ€»å…±çš„èµ„æº<br>
kube-reservedï¼šç»™kubernetesè¿›ç¨‹é¢„ç•™çš„èµ„æº<br>
system-reservedï¼šç»™æ“ä½œç³»ç»Ÿé¢„ç•™çš„èµ„æº<br>
eviction-thresholdï¼škubelet evictionçš„é˜€å€¼<br>
allocatableï¼šç•™ç»™podä½¿ç”¨çš„èµ„æº</p>
<pre><code>node_allocatable=Node_capacity-(kube-reserved+system-reserved+hard-eviction)
</code></pre>
<pre><code>      Node Capacity
---------------------------
|     kube-reserved       |
|-------------------------|
|     system-reserved     |
|-------------------------|
|    eviction-threshold   |
|-------------------------|
|                         |
|      allocatable        |
|   (available for pods)  |
|                         |
|                         |
---------------------------
</code></pre>
<p>Kubernetes èŠ‚ç‚¹ä¸Šçš„ <code>Allocatable</code> è¢«å®šä¹‰ä¸º pod å¯ç”¨è®¡ç®—èµ„æºé‡ã€‚è°ƒåº¦å™¨ä¸ä¼šè¶…é¢ç”³è¯· <code>Allocatable</code>ã€‚ç›®å‰æ”¯æŒ <code>CPU</code>, <code>memory</code> å’Œ <code>storage</code> è¿™å‡ ä¸ªå‚æ•°ã€‚</p>
<p>Node Allocatable æš´éœ²ä¸º API ä¸­ <code>v1.Node</code> å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯ CLI ä¸­ <code>kubectl describe node</code> çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>åœ¨ <code>kubelet</code> ä¸­ï¼Œå¯ä»¥ä¸ºä¸¤ç±»ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹é¢„ç•™èµ„æºã€‚</p>
<h3 id="ä½¿ç”¨kubeletå‚æ•°è¿›è¡Œé™åˆ¶">ä½¿ç”¨kubeletå‚æ•°è¿›è¡Œé™åˆ¶</h3>
<p>æ­¤æ–¹æ³•é€‚ç”¨äºè€ç‰ˆæœ¬çš„kubernetesé›†ç¾¤ï¼Œåœ¨æ–°ç‰ˆæœ¬(1.11ä¹‹å‰)ä¸­å·²ç»ä¸é€‚ç”¨äº†ã€‚</p>
<p>https://k8smeetup.github.io/docs/tasks/administer-cluster/reserve-compute-resources/</p>
<p>https://www.bladewan.com/2018/01/26/k8s_resource_resver/</p>
<h3 id="ä½¿ç”¨kubelet-configè¿›è¡Œé™åˆ¶">ä½¿ç”¨kubelet configè¿›è¡Œé™åˆ¶</h3>
<p>kubelet è¾ƒæ–°çš„ç‰ˆæœ¬éƒ½é‡‡ç”¨kubelet configå¯¹é›†ç¾¤çš„kubeletè¿›è¡Œé…ç½®ï¼Œæ­¤å¤„é‡‡ç”¨é™æ€é…ç½®æ–¹å¼ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨åŠ¨æ€é…ç½®æ–¹å¼ã€‚</p>
<pre><code># ç¼–è¾‘æ–‡æ¡£kubelet config æ–‡ä»¶
vim /var/lib/kubelet/config
</code></pre>
<p><strong>é…ç½®èµ„æºé¢„ç•™</strong></p>
<pre><code># æ‰¾åˆ°enforceNodeAllocatable æ³¨é‡Šæ‰
#enforceNodeAllocatable:
#- pods

# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œç³»ç»Ÿå’Œkubeletå‡é¢„ç•™CPU500må†…å­˜500Miç£ç›˜5G
systemReserved:
  cpu: &quot;500m&quot;
  memory: &quot;500Mi&quot;
  ephemeral-storage: &quot;5Gi&quot;
kubeReserved:
  cpu: &quot;500m&quot;
  memory: &quot;500Mi&quot;
  ephemeral-storage: &quot;5Gi&quot;
systemReservedCgroup: /system.slice
kubeReservedCgroup: /kubelet.service
EnforceNodeAllocatable:
- pods
- kube-reserved
- system-reserved

</code></pre>
<p><strong>é…ç½®è½¯é©±é€ï¼ˆé»˜è®¤ä¸ºç¡¬é©±é€ï¼‰</strong></p>
<p>è½¯é©±é€æœ‰èµ„æºé©±é€ç­‰å¾…æ—¶é—´ï¼Œç¡¬é©±é€ä¸ºç«‹åˆ»é©±é€ã€‚</p>
<pre><code># evictionHard æ³¨é‡Šæ‰ï¼Œå¹¶åœ¨åé¢æ–°å¢ä»¥ä¸‹å†…å®¹

#evictionHard:
EvictionSoft:
  imagefs.available: 15%
  memory.available: 10%
  nodefs.available: 10%
  nodefs.inodesFree: 5%
EvictionSoftGracePeriod:
  memory.available: &quot;5m&quot;
  nodefs.available: &quot;2m&quot;
  nodefs.inodesFree: &quot;2m&quot;
  imagefs.available: &quot;2m&quot;
</code></pre>
<pre><code># å¦‚æœä½ ä½¿ç”¨çš„cgroup driveræ˜¯croupè¿˜éœ€è¦è¿›è¡Œä»¥ä¸‹æ“ä½œ
# cpusetå’Œhugetlb subsystemæ˜¯é»˜è®¤æ²¡æœ‰åˆå§‹åŒ–system.sliceæ‰‹åŠ¨åˆ›å»º,
mkdir -p /sys/fs/cgroup/hugetlb/system.slice/kubelet.service/
mkdir -p /sys/fs/cgroup/cpuset/system.slice/kubelet.service/

# é…ç½®åœ¨kubeletä¸­é¿å…é‡å¯å¤±æ•ˆ
ExecStartPre=/usr/bin/mkdir -p /sys/fs/cgroup/cpuset/system.slice/kubelet.service
ExecStartPre=/usr/bin/mkdir -p /sys/fs/cgroup/hugetlb/system.slice/kubelet.service
</code></pre>
<p><strong>é‡å¯kubelet</strong></p>
<pre><code>service kubelet restart
</code></pre>
<h2 id="éªŒè¯">éªŒè¯</h2>
<pre><code>[root@m3 pki]# kubectl  describe node m1
Name:               m1
Roles:              master
Labels:             beta.kubernetes.io/arch=amd64
....
CreationTimestamp:  Mon, 26 Aug 2019 20:35:35 -0400
...
Addresses:
  InternalIP:  172.27.100.13
  Hostname:    m1
Capacity:
 cpu:                4
 ephemeral-storage:  36678148Ki
 hugepages-1Gi:      0
 hugepages-2Mi:      0
 memory:             8010576Ki
 pods:               110
Allocatable:
 cpu:                3
 ephemeral-storage:  23065162901
 hugepages-1Gi:      0
 hugepages-2Mi:      0
 memory:             6884176Ki
 pods:               110
</code></pre>
<ul>
<li>å¯ä»¥çœ‹åˆ°é¢„ç•™åï¼Œå¯ç”¨CPUä¸º3ï¼Œä¸é¢„ç•™ä¸º4ï¼Œå†…å­˜æ˜¯ä¸€æ ·çš„è®¡ç®—æ–¹å¼ï¼Œæ­¤å¤„é¢„ç•™äº†1Gï¼ˆ500Mi+500Miï¼‰</li>
</ul>
<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2>
<p>https://github.com/rootsongjc/qa/issues/3</p>
<p>https://cloud.tencent.com/developer/article/1097002</p>
<p>https://blog.csdn.net/ahilll/article/details/82109008</p>
<p>http://dockone.io/article/4797</p>
<p>https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/</p>
<p>https://kubernetes.io/zh/docs/tasks/administer-cluster/kubelet-config-file/</p>
<p>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubelet/config/v1beta1/types.go</p>
<p>https://www.bladewan.com/2018/01/26/k8s_resource_resver/</p>
</p>

     <p class="md_block">
    <div class="reward"><div class="reward-button">èµ <span class="reward-code"> <span class="alipay-code"> <img class="alipay-img" src="https://tomcat1009.coding.me/hexo/media/images/alipay.png"><b>æ”¯ä»˜å®æ‰«ç æ‰“èµ</b> </span> <span class="wechat-code"> <img class="wechat-img" src="https://tomcat1009.coding.me/hexo/media/images/wechat.png"><b>å¾®ä¿¡æ‰“èµ</b> </span> </span></div></div>
</p> 
</div>

</div>



<link href="https://tomcat1009.coding.me/hexo/styles/main.css" type="text/css" rel="stylesheet"/>

<div class="doc_comments">

</div>



  </div>
</div>



      </div>




    </div>

   <div class="footer">
<link href="https://tomcat1009.coding.me/hexo/styles/main.css" type="text/css" rel="stylesheet"/><div class="site_footer_wrap"><div class="site_footer">

      <div class="mysocials"><div class="my_socials">
		   
			   
    
			   
    
			   
    
			   
    
</div><link href="https://tomcat1009.coding.me/hexo/styles/main.css" type="text/css" rel="stylesheet"/>

      </div>

      <div class="copyright"><ul class="links">
<li><a href="/" target="_blank" rel="noopener noreferrer">å°é£ä¾ çš„é£è¡Œæ—¥è®°</a></li>
</ul>
      </div>

</div></div>

    </div>


<style type="text/css">a.back_to_top {
    text-decoration: none;
    position: fixed;
    bottom: 40px;
    right: 30px;
    background: #f0f0f0;
    height: 40px;
    width: 40px;
    border-radius: 50%;
    line-height: 36px;
    font-size: 18px;
    text-align: center;
    transition-duration: .5s;
    transition-propety: background-color;
    display: none;
}

a.back_to_top span {
    color: #888;
}

a.back_to_top:hover {
    cursor: pointer;
    background: #dfdfdf;
}

a.back_to_top:hover span {
    color: #555;
}

@media print, screen and (max-width: 580px) {
    .back_to_top {
        display: none !important;
    }
}



</style><a id="back_to_top" href="#" class="back_to_top"><span>â–³</span>
</a>
<script type="text/javascript" src="https://tomcat1009.coding.me/hexo/media/scripts/jquery.js"></script>

<script>$(document).ready((function(_this) {
  return function() {
    var bt;
    bt = $('#back_to_top');
    if ($(document).width() > 480) {
      $(window).scroll(function() {
        var st;
        st = $(window).scrollTop();
        if (st > 30) {
          return bt.css('display', 'block');
        } else {
          return bt.css('display', 'none');
        }
      });
      return bt.click(function() {
        $('body,html').animate({
          scrollTop: 0
        }, 800);
        return false;
      });
    }
  };
})(this));
</script>

</body>

</html>
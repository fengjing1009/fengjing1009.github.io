<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://p.guipulp.top/</id>
    <title>PeterPan</title>
    <updated>2019-09-12T04:58:28.538Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://p.guipulp.top/"/>
    <link rel="self" href="https://p.guipulp.top//atom.xml"/>
    <subtitle>è´µæœ‰æ’ï¼Œä½•å¿…ä¸‰æ›´èµ·äº”æ›´ç¡ï¼›æœ€æ— ç›Šï¼Œåªæ€•ä¸€æ—¥æš´åå¯’ã€‚</subtitle>
    <logo>https://p.guipulp.top//images/avatar.png</logo>
    <icon>https://p.guipulp.top//favicon.ico</icon>
    <rights>All rights reserved 2019, PeterPan</rights>
    <entry>
        <title type="html"><![CDATA[ä½¿ç”¨kubeadm æ–°åŠ å…¥èŠ‚ç‚¹ï¼ˆåŸå§‹tokenè¿‡æœŸåï¼‰]]></title>
        <id>https://p.guipulp.top//post/2019091201</id>
        <link href="https://p.guipulp.top//post/2019091201">
        </link>
        <updated>2019-09-12T04:47:00.000Z</updated>
        <content type="html"><![CDATA[<h2 id="kubeadm-join">kubeadm join</h2>
<blockquote>
<p>kubeadm init å®‰è£…å®Œæˆåä½ ä¼šå¾—åˆ°ä»¥ä¸‹çš„è¾“å‡ºï¼Œä½¿ç”¨joinæŒ‡ä»¤å¯ä»¥æ–°å¢èŠ‚ç‚¹åˆ°é›†ç¾¤,æ­¤token æœ‰æ•ˆæœŸä¸º24å°æ—¶</p>
</blockquote>
<pre><code>You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of machines by running the following on each node
as root:

  kubeadm join 18.16.202.35:6443 --token zr8n5j.yfkanjio0lfsupc0 --discovery-token-ca-cert-hash sha256:380b775b7f9ea362d45e4400be92adc4f71d86793ba6aae091ddb53c489d218c
</code></pre>
<h2 id="kubeadm-token">kubeadm token</h2>
<blockquote>
<p>åœ¨æ–°èŠ‚ç‚¹æ²¡æœ‰æ‹¿åˆ°è¯ä¹¦ä»¥å‰ï¼Œæ–°èŠ‚ç‚¹å’Œapi serverçš„é€šä¿¡æ˜¯é€šè¿‡tokenå’Œcaçš„ç­¾åå®Œæˆçš„ï¼Œå…·ä½“çš„æ­¥éª¤å¦‚ä¸‹</p>
</blockquote>
<pre><code># ç”Ÿæˆtoken
[root@node1 flannel]# kubeadm  token create
kiyfhw.xiacqbch8o8fa8qj
[root@node1 flannel]# kubeadm  token list
TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION   EXTRA GROUPS
gvvqwk.hn56nlsgsv11mik6   &lt;invalid&gt;   2018-10-25T14:16:06+08:00   authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token
kiyfhw.xiacqbch8o8fa8qj   23h         2018-10-27T06:39:24+08:00   authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token
</code></pre>
<pre><code># ç”Ÿæˆcaçš„sha256 hashå€¼
[root@node1 flannel]# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
5417eb1b68bd4e7a4c82aded83abc55ec91bd601e45734d6aba85de8b1ebb057
</code></pre>
<pre><code># ç»„è£…joinå‘½ä»¤
kubeadm join 18.16.202.35:6443 --token kiyfhw.xiacqbch8o8fa8qj --discovery-token-ca-cert-hash sha256:5417eb1b68bd4e7a4c82aded83abc55ec91bd601e45734d6aba85de8b1ebb057
</code></pre>
<pre><code># ä¸€æ­¥å®Œæˆä»¥ä¸Šæ­¥éª¤
kubeadm token create --print-join-command
</code></pre>
<pre><code># æ‰‹åŠ¨ç”Ÿæˆtokenï¼Œå®Œæˆå‘½ä»¤æ‰“å°
token=$(kubeadm token generate)
kubeadm token create $token --print-join-command --ttl=0
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetes1.15.3ç¦»çº¿å®‰è£…]]></title>
        <id>https://p.guipulp.top//post/2019090901</id>
        <link href="https://p.guipulp.top//post/2019090901">
        </link>
        <updated>2019-09-09T10:09:51.000Z</updated>
        <content type="html"><![CDATA[<h1 id="kubeadm-k8sé›†ç¾¤ç¦»çº¿å®‰è£…">kubeadm k8sé›†ç¾¤ç¦»çº¿å®‰è£…</h1>
<h2 id="ä¸‹è½½è½¯ä»¶åŒ…">ä¸‹è½½è½¯ä»¶åŒ…</h2>
<pre><code>yum install --downloadonly --downloaddir=./  kubeadm-1.15.3-0 kubelet-1.15.3-0 kubectl-1.15.3-0 docker-ce-18.06.3.ce-3.el7 keepalived ipset ipvsadm   
</code></pre>
<h2 id="ä¸‹è½½é•œåƒå¹¶æ‰“åŒ…">ä¸‹è½½é•œåƒå¹¶æ‰“åŒ…</h2>
<pre><code>kubeadm  config images pull --image-repository=registry.cn-hangzhou.aliyuncs.com/google_conta iners

for x in $(docker images |awk  '{print $1&quot;:&quot;$2}'|grep -v REP);do docker save -o $(echo $x|awk -F '/' '{print $3}').tar $x;done

</code></pre>
<h2 id="æ¢å¤é•œåƒ">æ¢å¤é•œåƒ</h2>
<pre><code>cd images;for x in `ls`;do docker load -i $x;done
</code></pre>
<h2 id="å®‰è£…è„šæœ¬">å®‰è£…è„šæœ¬</h2>
<p>è½¯ä»¶åŒ…ä¸‹è½½åœ°å€ï¼š</p>
<pre><code>é“¾æ¥:https://pan.baidu.com/s/1Vw0geL4Pn9_cq0rLxw7dRQ  å¯†ç :3v4g
</code></pre>
<pre><code># hostname
#hostnamectl set-hostname $HOSTNAME

# disable swap
swapoff -a

# disable selinux
sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config
setenforce 0

# stop and disable firewalld
systemctl stop firewalld ; systemctl disable firewalld

# add ipvs modules
cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF
chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4

# change node kernel
cat &lt;&lt;EOF &gt;  /etc/sysctl.d/ceph.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system

# install rpm
cd /root/local/rpm ; yum localinstall ./*

# load images
systemctl start docker 
systemctl enable docker kubelet
cd /root/local/images ; for x in `ls`;do docker load -i $x;done

# install kubernetes
# kubeadm init --apiserver-advertise-address 172.16.10.101 --pod-network-cidr=10.244.0.0/16 --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers
echo &quot;172.16.10.101 api.k8s.com&quot; &gt;&gt; /etc/hosts
kubeadm init --config /root/local/kubeadm.conf

# install client env
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# install addons
cd /root/local/yaml; kubectl apply -f .

# remove taint
#kubectl  taint node lab1 node-role.kubernetes.io/master:NoSchedule-
kubectl  get nodes |grep master |awk '{print $1}' |xargs -i kubectl  taint node {} node-role.kubernetes.io/master:NoSchedule-
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[etcdæ•°æ®å¤‡ä»½å’Œæ¢å¤]]></title>
        <id>https://p.guipulp.top//post/2019090503</id>
        <link href="https://p.guipulp.top//post/2019090503">
        </link>
        <updated>2019-09-05T03:46:23.000Z</updated>
        <content type="html"><![CDATA[<h2 id="å¯¹äºetcd-api-v3æ•°æ®å¤‡ä»½ä¸æ¢å¤æ–¹æ³•">å¯¹äºetcd api v3æ•°æ®å¤‡ä»½ä¸æ¢å¤æ–¹æ³•</h2>
<pre><code> # export ETCDCTL_API=3
</code></pre>
<pre><code> # etcdctl --endpoints localhost:2379 snapshot save snapshot.db ï¼ˆå¤‡ä»½ï¼‰
</code></pre>
<pre><code> # etcdctl snapshot restore snapshot.db --name m3 --data-dir=/home/etcd_data ï¼ˆè¿˜åŸï¼‰
</code></pre>
<blockquote>
<p>æ¢å¤åçš„æ–‡ä»¶éœ€è¦ä¿®æ”¹æƒé™ä¸º etcd:etcd<br>
â€“name:é‡æ–°æŒ‡å®šä¸€ä¸ªæ•°æ®ç›®å½•ï¼Œå¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤ä¸º default.etcd<br>
â€“data-dirï¼šæŒ‡å®šæ•°æ®ç›®å½•<br>
å»ºè®®ä½¿ç”¨æ—¶ä¸æŒ‡å®š name ä½†æŒ‡å®š data-dirï¼Œå¹¶å°† data-dir å¯¹åº”äº etcd æœåŠ¡ä¸­é…ç½®çš„ data-dir</p>
</blockquote>
<h2 id="å®è·µæ–¹æ³•">å®è·µæ–¹æ³•</h2>
<p><strong>å•æœºå¤‡ä»½</strong></p>
<pre><code>[root@k8s-master1 ~]# etcdctl --endpoints 127.0.0.1:2379 snapshot save snashot.db
Snapshot saved at snashot.db
[root@k8s-master1 ~]# ll
-rw-r--r--   1 root root 3756064 Apr 18 10:38 snashot.db
[root@k8s-master1 ~]#
</code></pre>
<p><strong>é›†ç¾¤å¤‡ä»½</strong></p>
<pre><code>[root@k8s-master1 ~]# etcdctl --endpoints=&quot;https://192.168.32.129:2379,https://192.168.32.130:2379,192.168.32.128:2379&quot; --cacert=/etc/kubernetes/cert/ca.pem --key=/etc/etcd/cert/etcd-key.pem --cert=/etc/etcd/cert/etcd.pem  snapshot save snashot1.db
Snapshot saved at snashot1.db
[root@k8s-master1 ~]#
[root@k8s-master1 ~]# ll
-rw-r--r--   1 root root 3756064 Apr 18 10:53 snashot1.db
-rw-r--r--   1 root root 3756064 Apr 18 10:38 snashot.db
</code></pre>
<p><strong>æ•°æ®æ¢å¤</strong></p>
<p>åšä¸‹é¢çš„æ“ä½œ,è¯·æ…é‡,æœ‰å¯èƒ½é€ æˆé›†ç¾¤å´©æºƒæ•°æ®ä¸¢å¤±.è¯·åœ¨å®éªŒç¯å¢ƒæµ‹è¯•.</p>
<p>æ‰§è¡Œå‘½ä»¤:systemctl stop etcd<br>
æ‰€æœ‰èŠ‚ç‚¹çš„etcdæœåŠ¡å…¨éƒ¨åœæ­¢.</p>
<p>æ‰§è¡Œå‘½ä»¤:rm -rf /var/lib/etcd/<br>
æ‰€æœ‰èŠ‚ç‚¹åˆ é™¤etcdçš„æ•°æ®</p>
<p><strong>æ¢å¤v3çš„æ•°æ®</strong></p>
<pre><code>[root@k8s-master1 ~]#  etcdctl --name=k8s-master1 --endpoints=&quot;https://192.168.32.128:2379&quot; --cacert=/etc/kubernetes/cert/ca.pem --key=/etc/etcd/cert/etcd-key.pem --cert=/etc/etcd/cert/etcd.pem --initial-cluster-token=etcd-cluster-1 --initial-advertise-peer-urls=https://192.168.32.128:2380 --initial-cluster=k8s-master1=https://192.168.32.128:2380,k8s-master2=https://192.168.32.129:2380,k8s-master3=https://192.168.32.130:2380 --data-dir=/var/lib/etcd snapshot restore snashot1.db
2019-04-18 13:43:42.570882 I | mvcc: restore compact to 148651
2019-04-18 13:43:42.584194 I | etcdserver/membership: added member 4c99f52323a3e391 [https://192.168.32.129:2380] to cluster 2a0978507970d828
2019-04-18 13:43:42.584224 I | etcdserver/membership: added member 5a74b01f28ece933 [https://192.168.32.128:2380] to cluster 2a0978507970d828
2019-04-18 13:43:42.584234 I | etcdserver/membership: added member b29b94ace458096d [https://192.168.32.130:2380] to cluster 2a0978507970d828
</code></pre>
<pre><code>[root@k8s-master2 ~]# etcdctl --name=k8s-master2 --endpoints=&quot;https://192.168.32.129:2379&quot; --cacert=/etc/kubernetes/cert/ca.pem --key=/etc/etcd/cert/etcd-key.pem --cert=/etc/etcd/cert/etcd.pem --initial-cluster-token=etcd-cluster-1 --initial-advertise-peer-urls=https://192.168.32.129:2380 --initial-cluster=k8s-master1=https://192.168.32.128:2380,k8s-master2=https://192.168.32.129:2380,k8s-master3=https://192.168.32.130:2380 --data-dir=/var/lib/etcd snapshot restore snashot1.db
2019-04-18 13:43:56.313096 I | mvcc: restore compact to 148651
2019-04-18 13:43:56.324779 I | etcdserver/membership: added member 4c99f52323a3e391 [https://192.168.32.129:2380] to cluster 2a0978507970d828
2019-04-18 13:43:56.324806 I | etcdserver/membership: added member 5a74b01f28ece933 [https://192.168.32.128:2380] to cluster 2a0978507970d828
2019-04-18 13:43:56.324819 I | etcdserver/membership: added member b29b94ace458096d [https://192.168.32.130:2380] to cluster 2a0978507970d828
</code></pre>
<pre><code>[root@k8s-master3 ~]# etcdctl --name=k8s-master3 --endpoints=&quot;https://192.168.32.130:2379&quot; --cacert=/etc/kubernetes/cert/ca.pem --key=/etc/etcd/cert/etcd-key.pem --cert=/etc/etcd/cert/etcd.pem --initial-cluster-token=etcd-cluster-1 --initial-advertise-peer-urls=https://192.168.32.130:2380 --initial-cluster=k8s-master1=https://192.168.32.128:2380,k8s-master2=https://192.168.32.129:2380,k8s-master3=https://192.168.32.130:2380 --data-dir=/var/lib/etcd snapshot restore snashot1.db
2019-04-18 13:44:10.643115 I | mvcc: restore compact to 148651
2019-04-18 13:44:10.649920 I | etcdserver/membership: added member 4c99f52323a3e391 [https://192.168.32.129:2380] to cluster 2a0978507970d828
2019-04-18 13:44:10.649957 I | etcdserver/membership: added member 5a74b01f28ece933 [https://192.168.32.128:2380] to cluster 2a0978507970d828
2019-04-18 13:44:10.649973 I | etcdserver/membership: added member b29b94ace458096d [https://192.168.32.130:2380] to cluster 2a0978507970d828
</code></pre>
<p>æœåŠ¡èµ·ä¸æ¥</p>
<pre><code>[root@k8s-master1 ~]# tail -n 30 /var/log/messages
Apr 18 13:46:41 k8s-master1 systemd: Starting Etcd Server...
Apr 18 13:46:41 k8s-master1 etcd: etcd Version: 3.3.7
Apr 18 13:46:41 k8s-master1 etcd: Git SHA: 56536de55
Apr 18 13:46:41 k8s-master1 etcd: Go Version: go1.9.6
Apr 18 13:46:41 k8s-master1 etcd: Go OS/Arch: linux/amd64
Apr 18 13:46:41 k8s-master1 etcd: setting maximum number of CPUs to 1, total number of available CPUs is 1
Apr 18 13:46:41 k8s-master1 etcd: error listing data dir: /var/lib/etcd
Apr 18 13:46:41 k8s-master1 systemd: etcd.service: main process exited, code=exited, status=1/FAILURE
Apr 18 13:46:41 k8s-master1 systemd: Failed to start Etcd Server.
Apr 18 13:46:41 k8s-master1 systemd: Unit etcd.service entered failed state.
Apr 18 13:46:41 k8s-master1 systemd: etcd.service failed.
Apr 18 13:46:41 k8s-master1 flanneld: timed out
Apr 18 13:46:41 k8s-master1 flanneld: E0418 13:46:41.858283   63943 main.go:349] Couldn't fetch network config: client: etcd cluster is unavailable or misconfigured; error #0: EOF
Apr 18 13:46:41 k8s-master1 flanneld: ; error #1: EOF
Apr 18 13:46:41 k8s-master1 flanneld: ; error #2: EOF
[root@k8s-master1 ~]#
</code></pre>
<p>ä¿®æ”¹æ•°æ®ç›®å½•æƒé™,é»˜è®¤æ˜¯root:root<br>
chown -R etcd:etcd /var/lib/etcd<br>
æ¢å¤æ­£å¸¸.</p>
<pre><code>[root@k8s-master1 ~]# etcdctl member list
4c99f52323a3e391, started, k8s-master2, https://192.168.32.129:2380, https://192.168.32.129:2379
5a74b01f28ece933, started, k8s-master1, https://192.168.32.128:2380, https://192.168.32.128:2379
b29b94ace458096d, started, k8s-master3, https://192.168.32.130:2380, https://192.168.32.130:2379
[root@k8s-master1 ~]#
</code></pre>
<p>å¯ä»¥çœ‹åˆ°v3çš„æ•°æ®æ¢å¤æˆåŠŸ.</p>
<h2 id="å‚è€ƒåœ°å€">å‚è€ƒåœ°å€</h2>
<p>https://blog.csdn.net/liukuan73/article/details/78986652</p>
<p>https://blog.51cto.com/goome/2380854</p>
<p>https://yq.aliyun.com/articles/336781</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Centos7ä¸‹çš„æ—¥å¿—åˆ‡å‰²]]></title>
        <id>https://p.guipulp.top//post/2019090502</id>
        <link href="https://p.guipulp.top//post/2019090502">
        </link>
        <updated>2019-09-05T03:27:49.000Z</updated>
        <content type="html"><![CDATA[<h2 id="logrotate">logrotate</h2>
<p>/etc/logrotate.conf æ˜¯ Logrotate å·¥å…·çš„ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªå·¥å…·ç”¨æ¥è‡ªåŠ¨åˆ‡å‰²ç³»ç»Ÿæ—¥å¿—ï¼ŒLogrotate æ˜¯åŸºäº cron æ¥è¿è¡Œçš„ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code>[root@localhost ~]$ cat /etc/cron.daily/logrotate    # æ¯å¤©è¿è¡Œ
#!/bin/sh

/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;&amp;1
EXITVALUE=$?
if [ $EXITVALUE != 0 ]; then
    /usr/bin/logger -t logrotate &quot;ALERT exited abnormally with [$EXITVALUE]&quot;
fi
exit 0
</code></pre>
<p>å®é™…è¿è¡Œæ—¶ï¼ŒLogrotate ä¼šè°ƒç”¨é…ç½®æ–‡ä»¶ /etc/logrotate.conf ï¼Œé»˜è®¤çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code>[root@localhost ~]$ cat /etc/logrotate.conf 

weekly                      # æ¯å‘¨åˆ‡å‰²ä¸€æ¬¡
rotate 4                    # åªä¿ç•™å››ä»½æ–‡ä»¶
create                      # åˆ‡å‰²åä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶
dateext                     # æŒ‡å®šåˆ‡å‰²æ–‡ä»¶çš„åç¼€åï¼Œè¿™é‡Œä»¥æ—¥æœŸä¸ºåç¼€å
include /etc/logrotate.d    # åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶çš„ç›®å½•

/var/log/wtmp {             # å¯¹å“ªä¸ªæ–‡ä»¶è¿›è¡Œåˆ‡å‰²
    monthly                 # æ¯ä¸ªæœˆåˆ‡å‰²ä¸€æ¬¡
    create 0664 root utmp   # æŒ‡å®šåˆ›å»ºçš„æ–°æ–‡ä»¶çš„æƒé™ï¼Œå±ä¸»ï¼Œå±ç»„
        minsize 1M          # æ–‡ä»¶å®¹é‡è¶…è¿‡è¿™ä¸ªå€¼æ—¶æ‰è¿›è¡Œåˆ‡å‰²
    rotate 1                # åªä¿ç•™ä¸€ä»½æ–‡ä»¶
}

/var/log/btmp {
    missingok
    monthly
    create 0600 root utmp
    rotate 1
}
</code></pre>
<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>
<p>https://blog.51cto.com/linuxblind/1269458</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetesé‡Œé¢çš„GC]]></title>
        <id>https://p.guipulp.top//post/2019090501</id>
        <link href="https://p.guipulp.top//post/2019090501">
        </link>
        <updated>2019-09-05T03:02:08.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯gc">ä»€ä¹ˆæ˜¯GC</h2>
<p>GC æ˜¯ Garbage Collector çš„ç®€ç§°ã€‚ä»åŠŸèƒ½å±‚é¢ä¸Šæ¥è¯´ï¼Œå®ƒå’Œç¼–ç¨‹è¯­è¨€å½“ä¸­çš„ã€ŒGCã€ åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ã€‚å®ƒæ¸…ç† Kubernetes ä¸­ã€Œç¬¦åˆç‰¹å®šæ¡ä»¶ã€çš„ Resource Objectã€‚</p>
<p>Kubeletçš„GCåŠŸèƒ½å°†æ¸…ç†æœªä½¿ç”¨çš„imageå’Œcontainerã€‚Kubeletæ¯åˆ†é’Ÿå¯¹containeræ‰§è¡Œä¸€æ¬¡GCï¼Œæ¯5åˆ†é’Ÿå¯¹imageæ‰§è¡Œä¸€æ¬¡GCã€‚ä¸å»ºè®®ä½¿ç”¨å¤–éƒ¨åƒåœ¾æ”¶é›†å·¥å…·ï¼Œå› ä¸ºè¿™äº›å·¥å…·å¯èƒ½ç ´åKubeletã€‚</p>
<h2 id="kubernetesé‡Œé¢çš„åŸºæœ¬å¸¸è¯†">kubernetesé‡Œé¢çš„åŸºæœ¬å¸¸è¯†</h2>
<ul>
<li>åœ¨ k8s ä¸­ï¼Œä½ å¯ä»¥è®¤ä¸ºä¸‡ç‰©çš†èµ„æºï¼Œå¾ˆå¤šé€»è¾‘çš„æ“ä½œå¯¹è±¡éƒ½æ˜¯ Resource Objectã€‚</li>
<li>Kubernetes åœ¨ä¸åŒçš„ Resource Objects ä¸­ç»´æŠ¤ä¸€å®šçš„ã€Œä»å±å…³ç³»ã€ã€‚å†…ç½®çš„ Resource Objects ä¸€èˆ¬ä¼šé»˜è®¤åœ¨ä¸€ä¸ª Resource Object å’Œå®ƒçš„åˆ›å»ºè€…ä¹‹é—´å»ºç«‹ä¸€ä¸ªã€Œä»å±å…³ç³»ã€ã€‚</li>
<li>ä½ ä¹Ÿå¯ä»¥åˆ©ç”¨<code>ObjectMeta.OwnerReferences</code>è‡ªç”±çš„å»ç»™ä¸¤ä¸ª Resource Object å»ºç«‹å…³ç³»ï¼Œå‰ææ˜¯è¢«å»ºç«‹å…³ç³»çš„ä¸¤ä¸ªå¯¹è±¡å¿…é¡»åœ¨ä¸€ä¸ª Namespace ä¸‹ã€‚</li>
<li>K8s å®ç°äº†ä¸€ç§ã€ŒCascading deletionã€ï¼ˆçº§è”åˆ é™¤ï¼‰çš„æœºåˆ¶ï¼Œå®ƒåˆ©ç”¨å·²ç»å»ºç«‹çš„ã€Œä»å±å…³ç³»ã€è¿›è¡Œèµ„æºå¯¹è±¡çš„æ¸…ç†å·¥ä½œã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ª dependent èµ„æºçš„ owner å·²ç»è¢«åˆ é™¤æˆ–è€…ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œä»æŸç§è§’åº¦å°±å¯ä»¥åˆ¤å®šï¼Œè¿™ä¸ª dependent çš„å¯¹è±¡å·²ç»æ˜¯å¼‚å¸¸ï¼ˆæ— äººç®¡è¾–ï¼‰çš„äº†ï¼Œéœ€è¦è¿›è¡Œæ¸…ç†ã€‚è€Œ ã€Œcascading deletionã€åˆ™æ˜¯è¢« k8s ä¸­çš„ä¸€ä¸ª controller ç»„ä»¶å®ç°çš„ï¼š<code>Garbage Collector</code></li>
<li>k8s æ˜¯é€šè¿‡ <code>Garbage Collector</code> å’Œ <code>ownerReference</code> ä¸€èµ·é…åˆå®ç°äº†ã€Œåƒåœ¾å›æ”¶ã€çš„åŠŸèƒ½ã€‚</li>
</ul>
<h2 id="kubernetesçš„gcç»„æˆ">kubernetesçš„gcç»„æˆ</h2>
<p><img src="http://img.blog.csdn.net/20161225115013410?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2FsdG9uV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="kubernetes GC architecture in v1.3"></p>
<p>ä¸€ä¸ª Garbage Collector é€šå¸¸ç”±ä¸‰éƒ¨åˆ†å®ç°ï¼š</p>
<ul>
<li>
<p>Scannerï¼š å®ƒè´Ÿè´£æ”¶é›†ç›®å‰ç³»ç»Ÿä¸­å·²å­˜åœ¨çš„ Resourceï¼Œå¹¶ä¸”å‘¨æœŸæ€§çš„å°†è¿™äº›èµ„æºå¯¹è±¡æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å¤„ç†ï¼ˆæ£€æµ‹æ˜¯å¦è¦å¯¹æŸä¸€ä¸ªResource Object è¿›è¡Œ GC æ“ä½œï¼‰</p>
</li>
<li>
<p>Garbage Processor: Garbage Processor ç”±ä¸¤éƒ¨åˆ†ç»„æˆ</p>
</li>
<li>
<ul>
<li>
<p>Dirty Queueï¼š Scanner ä¼šå°†å‘¨æœŸæ€§æ‰«æåˆ°çš„ Resource Object æ”¾å…¥è¿™ä¸ªé˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†</p>
</li>
<li>
<p>Workerï¼šworker è´Ÿè´£ä»è¿™ä¸ªé˜Ÿåˆ—ä¸­å–å‡ºå…ƒç´ è¿›è¡Œå¤„ç†</p>
</li>
<li>
<ul>
<li>
<p>æ£€æŸ¥ Object çš„ metaData éƒ¨åˆ†ï¼ŒæŸ¥çœ‹<code>ownerReference</code>å­—æ®µæ˜¯å¦ä¸ºç©º</p>
</li>
<li>
<ul>
<li>
<p>å¦‚æœä¸ºç©ºï¼Œåˆ™æœ¬æ¬¡å¤„ç†ç»“æŸ</p>
</li>
<li>
<p>å¦‚æœä¸ä¸ºç©ºï¼Œæ£€æµ‹<code>ownerReference</code>å­—æ®µå†…æ ‡è¯†çš„ Owner Resource Objectæ˜¯å¦å­˜åœ¨</p>
</li>
<li>
<ul>
<li>å­˜åœ¨ï¼šåˆ™æœ¬æ¬¡å¤„ç†ç»“æŸ</li>
<li>ä¸å­˜åœ¨ï¼šåˆ é™¤è¿™ä¸ª Object</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Propagatorï¼š Propagator ç”±ä¸‰ä¸ªéƒ¨åˆ†æ„æˆ</p>
</li>
<li>
<ul>
<li>
<p>EventQueueï¼šè´Ÿè´£å­˜å‚¨ k8s ä¸­èµ„æºå¯¹è±¡çš„äº‹ä»¶ï¼ˆEgï¼šADDï¼ŒUPDATEï¼ŒDELETEï¼‰</p>
</li>
<li>
<p>DAG(æœ‰å‘æ— ç¯å›¾)ï¼šè´Ÿè´£å­˜å‚¨ k8s ä¸­æ‰€æœ‰èµ„æºå¯¹è±¡çš„ã€Œowner-dependentã€ å…³ç³»</p>
</li>
<li>
<p>Workerï¼šä» EventQueue ä¸­ï¼Œå–å‡ºèµ„æºå¯¹è±¡çš„äº‹ä»¶ï¼Œæ ¹æ®äº‹ä»¶çš„ç±»å‹ä¼šé‡‡å–ä»¥ä¸‹ä¸¤ç§æ“ä½œ</p>
</li>
<li>
<ul>
<li>ADD/UPDATE: å°†è¯¥äº‹ä»¶å¯¹åº”çš„èµ„æºå¯¹è±¡åŠ å…¥ DAGï¼Œä¸”å¦‚æœè¯¥å¯¹è±¡æœ‰ owner ä¸” owner ä¸åœ¨ DAG ä¸­ï¼Œå°†å®ƒåŒæ—¶åŠ å…¥ Garbage Processor çš„ Dirty Queue ä¸­</li>
<li>DELETEï¼šå°†è¯¥äº‹ä»¶å¯¹åº”çš„èµ„æºå¯¹è±¡ä» DAG ä¸­åˆ é™¤ï¼Œå¹¶ä¸”å°†å…¶ã€Œç®¡è¾–ã€çš„å¯¹è±¡ï¼ˆåªå‘ä¸‹å¯»æ‰¾ä¸€çº§ï¼Œå¦‚åˆ é™¤ Deploymentï¼Œé‚£ä¹ˆåªæ“ä½œ ReplicaSet ï¼‰åŠ å…¥ Garbage Processor çš„ Dirty Queue ä¸­</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å…¶å®ï¼Œåœ¨æœ‰äº† Scanner å’Œ Garbage Processor ä¹‹åï¼ŒGarbage Collector å°±å·²ç»èƒ½å¤Ÿå®ç°ã€Œåƒåœ¾å›æ”¶ã€çš„åŠŸèƒ½äº†ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼šScanner çš„æ‰«æé¢‘ç‡è®¾ç½®å¤šå°‘å¥½å‘¢ï¼Ÿå¤ªé•¿äº†ï¼Œk8s å†…éƒ¨å°±ä¼šç§¯ç´¯è¿‡å¤šçš„ã€ŒåºŸå¼ƒèµ„æºã€ï¼›å¤ªçŸ­äº†ï¼Œå°¤å…¶æ˜¯åœ¨é›†ç¾¤å†…éƒ¨èµ„æºå¯¹è±¡è¾ƒå¤šçš„æ—¶å€™ï¼Œé¢‘ç¹çš„æ‹‰å–ä¿¡æ¯å¯¹ API-Server ä¹Ÿæ˜¯ä¸€ä¸ªä¸å°çš„å‹åŠ›ã€‚</p>
<p>k8s ä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼çš„æœåŠ¡ç¼–æ’ç³»ç»Ÿï¼Œå…¶å†…éƒ¨æ‰§è¡Œä»»ä½•ä¸€é¡¹é€»è¾‘æˆ–è€…è¡Œä¸ºï¼Œéƒ½ä¾èµ–ä¸€ç§æœºåˆ¶ï¼šã€Œäº‹ä»¶é©±åŠ¨ã€ã€‚è¯´çš„ç®€å•ç‚¹ï¼Œk8s ä¸­ä¸€äº›çœ‹èµ·æ¥ã€Œè‡ªåŠ¨ã€çš„è¡Œä¸ºï¼Œå…¶å®éƒ½æ˜¯ç”±ä¸€äº›ç¥ç§˜çš„ã€ŒåŠ›é‡ã€åœ¨é©±åŠ¨ç€ã€‚è€Œè¿™ä¸ªã€ŒåŠ›é‡ã€å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ã€ŒEventã€ã€‚ä»»æ„ä¸€ä¸ª Resource Object å‘ç”Ÿå˜åŠ¨çš„æ—¶å€™ï¼ˆæ–°å»ºï¼Œæ›´æ–°ï¼Œåˆ é™¤ï¼‰ï¼Œéƒ½ä¼šè§¦å‘ä¸€ä¸ª k8s çš„äº‹ä»¶ï¼ˆEventï¼‰ï¼Œè¿™ä¸ªäº‹ä»¶åœ¨ k8s çš„å†…éƒ¨æ˜¯å…¬å¼€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªåœ°æ–¹ç›‘å¬è¿™äº›äº‹ä»¶ã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼Œæ— è®ºæ˜¯ã€Œäº‹ä»¶çš„ç›‘å¬æœºåˆ¶ã€è¿˜æ˜¯ã€Œå‘¨æœŸæ€§è®¿é—® API-Server æ‰¹é‡è·å– Resource Object ä¿¡æ¯ã€ï¼Œå…¶ç›®çš„éƒ½æ˜¯ä¸ºäº†èƒ½å¤ŸæŒæ¡ Resource Object çš„æœ€æ–°ä¿¡æ¯ã€‚ä¸¤è€…æ˜¯å„æœ‰ä¼˜åŠ¿çš„ï¼š</p>
<ol>
<li>æ‰¹é‡æ‹‰å–ï¼šä¸€æ¬¡æ€§æ‹‰å–æ‰€æœ‰çš„ Resource Objectï¼Œå…¨é¢</li>
<li>ç›‘å¬ Resource çš„ Eventï¼šå®æ—¶æ€§å¼ºï¼Œ ä¸”å¯¹ APIâ€”SERVER ä¸ä¼šé€ æˆå¤ªå¤§çš„å‹åŠ›</li>
</ol>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨å®ç° Garbage Collector çš„è¿‡ç¨‹ä¸­ï¼Œk8s å‘å…¶æ·»åŠ äº†ä¸€ä¸ªã€Œå¢å¼ºå‹ã€çš„ç»„ä»¶ï¼šPropagator</p>
<p>åœ¨æœ‰äº† Propagator çš„åŠ å…¥ä¹‹åï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ä»…åœ¨ GC å¼€å§‹è¿è¡Œçš„æ—¶å€™ï¼Œè®© Scanner æ‰«æä¸€ä¸‹ç³»ç»Ÿä¸­æ‰€æœ‰çš„ Objectï¼Œç„¶åå°†è¿™äº›ä¿¡æ¯ä¼ é€’ç»™ Propagator å’Œ Dirty Queueã€‚åªè¦ DAG ä¸€å»ºç«‹èµ·æ¥ä¹‹åï¼Œé‚£ä¹ˆ Scanner å…¶å®å°±æ²¡æœ‰å†å·¥ä½œçš„å¿…è¦äº†ã€‚ã€Œäº‹ä»¶é©±åŠ¨ã€çš„æœºåˆ¶æä¾›äº†ä¸€ç§å¢é‡çš„æ–¹å¼è®© GC æ¥ç›‘æ§ k8s é›†ç¾¤å†…éƒ¨çš„èµ„æºå¯¹è±¡å˜åŒ–æƒ…å†µã€‚</p>
<h2 id="å‚è€ƒåœ°å€">å‚è€ƒåœ°å€</h2>
<p>https://mp.weixin.qq.com/s/6b5jdDkvmtywvcRa4MMjQA</p>
<p>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubelet/config/v1beta1/types.go</p>
<p>https://yq.aliyun.com/articles/679728</p>
<p>https://zhuanlan.zhihu.com/p/50101300</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[linux cgroupsç®€ä»‹]]></title>
        <id>https://p.guipulp.top//post/2019090202</id>
        <link href="https://p.guipulp.top//post/2019090202">
        </link>
        <updated>2019-09-02T07:54:27.000Z</updated>
        <content type="html"><![CDATA[<p>https://blog.csdn.net/ahilll/article/details/82109008<br>
https://blog.csdn.net/chenleiking/article/details/87988851</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetes æ¸…ç†å­¤å„¿POD]]></title>
        <id>https://p.guipulp.top//post/2019090201</id>
        <link href="https://p.guipulp.top//post/2019090201">
        </link>
        <updated>2019-09-02T07:53:25.000Z</updated>
        <content type="html"><![CDATA[<h3 id="å­¤å„¿podçš„äº§ç”Ÿ">å­¤å„¿podçš„äº§ç”Ÿ</h3>
<p>èŠ‚ç‚¹OOMä»¥åæˆ–è€…èŠ‚ç‚¹å¼‚å¸¸å´©æºƒçš„æƒ…å†µä¸‹ï¼Œpodæœªèƒ½è¢«æ­£å¸¸çš„æ¸…ç†è€Œå¯¼è‡´çš„å­¤å„¿è¿›ç¨‹ã€‚</p>
<p><strong>æç¤ºå¦‚ä¸‹</strong></p>
<pre><code>Orphaned pod found - but volume paths are still present on disk
</code></pre>
<p><strong>è¿›å…¥k8sçš„podç›®å½•</strong></p>
<pre><code>cd /var/lib/kubelet/pods/
</code></pre>
<h3 id="è§£å†³é—®é¢˜">è§£å†³é—®é¢˜</h3>
<p>è¿‡æ»¤æ—¥å¿—ä¸­çš„å­¤å„¿podï¼Œåˆ é™¤podã€‚</p>
<pre><code class="language-js">#!/bin/bash
num=$(grep &quot;errors similar to this. Turn up verbosity to see them.&quot;  /var/log/messages |tail -1 | awk '{print $12}' |sed 's/&quot;//g')
echo $num

while [ $num ]
do
   [ -d &quot;/var/lib/kubelet/pods/${num}&quot; ] &amp;&amp; rm -rf /var/lib/kubelet/pods/${num}

  sleep 2s
  num=$(grep &quot;errors similar to this. Turn up verbosity to see them.&quot;  /var/log/messages |tail -1 | awk '{print $12}' |sed 's/&quot;//g')
  [ -d &quot;/var/lib/kubelet/pods/${num}&quot; ] || num=

  echo &quot;$num remaining&quot;

done
</code></pre>
<p>ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æœ‰ä¸€å®šçš„<code>å±é™©æ€§</code>ï¼Œè¿˜ä¸ç¡®è®¤æ˜¯å¦æœ‰<code>æ•°æ®ä¸¢å¤±</code>çš„é£é™©ï¼Œå¦‚æœå¯ä»¥ç¡®è®¤ï¼Œå†æ‰§è¡Œã€‚</p>
<p>å¦‚æœå·²ç»æŒ‚è½½äº†PVCç­‰ç›¸å…³å­˜å‚¨ï¼Œå…ˆæ‰§è¡Œumountå†æ‰§è¡Œåˆ é™¤ã€‚</p>
<p>å†å»æŸ¥çœ‹æ—¥å¿—ï¼Œå°±ä¼šå‘ç°syslogä¸ä¼šå†åˆ·ç±»ä¼¼çš„æ—¥å¿—äº†ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetesèµ„æºé¢„ç•™]]></title>
        <id>https://p.guipulp.top//post/2019083002</id>
        <link href="https://p.guipulp.top//post/2019083002">
        </link>
        <updated>2019-08-30T09:25:37.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>ä¸‹é¢å†…å®¹è¿˜å¤„äºæµ‹è¯•é˜¶æ®µï¼Œç”Ÿäº§ä¸Šæ˜¯å¦èƒ½ä¿è¯é›†ç¾¤ç¨³å®šæš‚æ—¶è¿˜ä¸æ¸…æ¥šã€‚ğŸ˜ğŸ˜</p>
</blockquote>
<h2 id="äº‹æ•…">äº‹æ•…</h2>
<p>ä»Šå¤©æˆ‘ä»¬çš„å¼€å‘ç¯å¢ƒç”±äºjavaåº”ç”¨å†…å­˜æŠ¢å åŸå› å¯¼è‡´k8sé›†ç¾¤workerèŠ‚ç‚¹å…¨éƒ¨å®•æœºï¼Œä¸»è¦åŸå› æ˜¯ç¨‹åºå’Œèµ„æºæ²¡è¿›è¡Œé™åˆ¶è§„åˆ’ï¼Œä¸”kubeletä¹Ÿæ²¡é…ç½®èµ„æºé¢„ç•™ï¼Œé‚£hostä¸Šæ‰€æœ‰èµ„æºéƒ½æ˜¯å¯ä»¥ç»™podè°ƒé…ä½¿ç”¨çš„ï¼Œè¿™æ ·å°±å¼•èµ·é›†ç¾¤é›ªå´©æ•ˆåº”ï¼Œæ¯”å¦‚é›†ç¾¤å†…æœ‰ä¸€å°ä¸Šè·‘çš„podæ²¡åšresource limtå¯¼è‡´å ç”¨èµ„æºè¿‡å¤§å¯¼è‡´å°†å®¿ä¸»æœºå‹æ­»äº†ï¼Œæ­¤æ—¶è¿™ä¸ªèŠ‚ç‚¹åœ¨kuberneteså†…å°±æ˜¯ä¸€ä¸ªno readyçš„çŠ¶æ€äº†ï¼Œkubernetesä¼šå°†è¿™å°hostä¸Šæ‰€æœ‰çš„podåœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šé‡å»ºï¼Œä¹Ÿå°±æ„å‘³ç€é‚£ä¸ªæœ‰é—®é¢˜çš„podé‡æ–°è·‘åœ¨å…¶ä»–æ­£å¸¸çš„èŠ‚ç‚¹ä¸Šï¼Œå°†å¦å¤–æ­£å¸¸çš„èŠ‚ç‚¹å‹è·¨ã€‚å¾ªæ€€ä¸‹å»ç›´åˆ°é›†ç¾¤å†…æ‰€æœ‰ä¸»æœºéƒ½æŒ‚äº†ï¼Œè¿™å°±æ˜¯é›†ç¾¤é›ªå´©æ•ˆåº”ã€‚</p>
<h2 id="è§£å†³åŠæ³•">è§£å†³åŠæ³•</h2>
<p>åœ¨kubernetesä¸­å¯ä»¥é€šè¿‡ç»™kubeleté…ç½®å‚æ•°é¢„ç•™èµ„æºç»™ç³»ç»Ÿè¿›ç¨‹å’Œkubernetesè¿›ç¨‹ä¿è¯å®ƒä»¬ç¨³å®šè¿è¡Œã€‚ç›®å‰èƒ½å®ç°åˆ°cpuã€memoryã€ephemeral-storageå±‚é¢çš„èµ„æºé¢„ç•™ã€‚<br>
é‡ç‚¹æä¸¤ç‚¹<br>
cpuï¼šcpuæ˜¯é…ç½®cpu shareså®é™…ä¸Šå¯¹åº”çš„æ˜¯cpuçš„ä¼˜å…ˆçº§ï¼Œç®€å•æ¥è¯´ï¼Œè¿™ä¸ªåœ¨cpuç¹å¿™æ—¶ï¼Œå®ƒèƒ½æœ‰æ›´é«˜ä¼˜å…ˆçº§è·å–æ›´å¤šcpuèµ„æºã€‚</p>
<p>ephemeral-storageæ˜¯kubernetes1.8å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªèµ„æºé™åˆ¶çš„å¯¹è±¡ï¼Œkubernetes 1.10ç‰ˆæœ¬ä¸­kubeleté»˜è®¤å·²ç»æ‰“å¼€çš„äº†,ä¸»è¦æ˜¯ç”¨äºå¯¹æœ¬åœ°ä¸´æ—¶å­˜å‚¨ä½¿ç”¨ç©ºé—´å¤§å°çš„é™åˆ¶ï¼Œå¦‚å¯¹podçš„empty dirã€/var/lib/kubeletã€æ—¥å¿—ã€å®¹å™¨å¯è¯»å†™å±‚çš„ä½¿ç”¨å¤§å°çš„é™åˆ¶ã€‚</p>
<h2 id="é…ç½®">é…ç½®</h2>
<h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3>
<p>åœ¨è®²é…ç½®ä¹‹å‰æˆ‘ä»¬å…ˆäº†è§£å‡ ä¸ªæ¦‚å¿µï¼š</p>
<p>Node capacityï¼šèŠ‚ç‚¹æ€»å…±çš„èµ„æº<br>
kube-reservedï¼šç»™kubernetesè¿›ç¨‹é¢„ç•™çš„èµ„æº<br>
system-reservedï¼šç»™æ“ä½œç³»ç»Ÿé¢„ç•™çš„èµ„æº<br>
eviction-thresholdï¼škubelet evictionçš„é˜€å€¼<br>
allocatableï¼šç•™ç»™podä½¿ç”¨çš„èµ„æº</p>
<pre><code>node_allocatable=Node_capacity-(kube-reserved+system-reserved+hard-eviction)
</code></pre>
<pre><code>      Node Capacity
---------------------------
|     kube-reserved       |
|-------------------------|
|     system-reserved     |
|-------------------------|
|    eviction-threshold   |
|-------------------------|
|                         |
|      allocatable        |
|   (available for pods)  |
|                         |
|                         |
---------------------------
</code></pre>
<p>Kubernetes èŠ‚ç‚¹ä¸Šçš„ <code>Allocatable</code> è¢«å®šä¹‰ä¸º pod å¯ç”¨è®¡ç®—èµ„æºé‡ã€‚è°ƒåº¦å™¨ä¸ä¼šè¶…é¢ç”³è¯· <code>Allocatable</code>ã€‚ç›®å‰æ”¯æŒ <code>CPU</code>, <code>memory</code> å’Œ <code>storage</code> è¿™å‡ ä¸ªå‚æ•°ã€‚</p>
<p>Node Allocatable æš´éœ²ä¸º API ä¸­ <code>v1.Node</code> å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯ CLI ä¸­ <code>kubectl describe node</code> çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>åœ¨ <code>kubelet</code> ä¸­ï¼Œå¯ä»¥ä¸ºä¸¤ç±»ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹é¢„ç•™èµ„æºã€‚</p>
<h3 id="ä½¿ç”¨kubeletå‚æ•°è¿›è¡Œé™åˆ¶">ä½¿ç”¨kubeletå‚æ•°è¿›è¡Œé™åˆ¶</h3>
<p>æ­¤æ–¹æ³•é€‚ç”¨äºè€ç‰ˆæœ¬çš„kubernetesé›†ç¾¤ï¼Œåœ¨æ–°ç‰ˆæœ¬(1.11ä¹‹å‰)ä¸­å·²ç»ä¸é€‚ç”¨äº†ã€‚</p>
<p>https://k8smeetup.github.io/docs/tasks/administer-cluster/reserve-compute-resources/</p>
<p>https://www.bladewan.com/2018/01/26/k8s_resource_resver/</p>
<h3 id="ä½¿ç”¨kubelet-configè¿›è¡Œé™åˆ¶">ä½¿ç”¨kubelet configè¿›è¡Œé™åˆ¶</h3>
<p>kubelet è¾ƒæ–°çš„ç‰ˆæœ¬éƒ½é‡‡ç”¨kubelet configå¯¹é›†ç¾¤çš„kubeletè¿›è¡Œé…ç½®ï¼Œæ­¤å¤„é‡‡ç”¨é™æ€é…ç½®æ–¹å¼ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨åŠ¨æ€é…ç½®æ–¹å¼ã€‚</p>
<pre><code># ç¼–è¾‘æ–‡æ¡£kubelet config æ–‡ä»¶
vim /var/lib/kubelet/config
</code></pre>
<p><strong>é…ç½®èµ„æºé¢„ç•™</strong></p>
<pre><code># æ‰¾åˆ°enforceNodeAllocatable æ³¨é‡Šæ‰
#enforceNodeAllocatable:
#- pods

# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œç³»ç»Ÿå’Œkubeletå‡é¢„ç•™CPU500må†…å­˜500Miç£ç›˜5G
systemReserved:
  cpu: &quot;500m&quot;
  memory: &quot;500Mi&quot;
  ephemeral-storage: &quot;5Gi&quot;
kubeReserved:
  cpu: &quot;500m&quot;
  memory: &quot;500Mi&quot;
  ephemeral-storage: &quot;5Gi&quot;
systemReservedCgroup: /system.slice
kubeReservedCgroup: /kubelet.service
EnforceNodeAllocatable:
- pods
- kube-reserved
- system-reserved

</code></pre>
<p><strong>é…ç½®è½¯é©±é€ï¼ˆé»˜è®¤ä¸ºç¡¬é©±é€ï¼‰</strong></p>
<p>è½¯é©±é€æœ‰èµ„æºé©±é€ç­‰å¾…æ—¶é—´ï¼Œç¡¬é©±é€ä¸ºç«‹åˆ»é©±é€ã€‚</p>
<pre><code># evictionHard æ³¨é‡Šæ‰ï¼Œå¹¶åœ¨åé¢æ–°å¢ä»¥ä¸‹å†…å®¹

#evictionHard:
EvictionSoft:
  imagefs.available: 15%
  memory.available: 10%
  nodefs.available: 10%
  nodefs.inodesFree: 5%
EvictionSoftGracePeriod:
  memory.available: &quot;5m&quot;
  nodefs.available: &quot;2m&quot;
  nodefs.inodesFree: &quot;2m&quot;
  imagefs.available: &quot;2m&quot;
</code></pre>
<pre><code># å¦‚æœä½ ä½¿ç”¨çš„cgroup driveræ˜¯croupè¿˜éœ€è¦è¿›è¡Œä»¥ä¸‹æ“ä½œ
# cpusetå’Œhugetlb subsystemæ˜¯é»˜è®¤æ²¡æœ‰åˆå§‹åŒ–system.sliceæ‰‹åŠ¨åˆ›å»º,
mkdir -p /sys/fs/cgroup/hugetlb/system.slice/kubelet.service/
mkdir -p /sys/fs/cgroup/cpuset/system.slice/kubelet.service/

# é…ç½®åœ¨kubeletä¸­é¿å…é‡å¯å¤±æ•ˆ
ExecStartPre=/usr/bin/mkdir -p /sys/fs/cgroup/cpuset/system.slice/kubelet.service
ExecStartPre=/usr/bin/mkdir -p /sys/fs/cgroup/hugetlb/system.slice/kubelet.service
</code></pre>
<p><strong>é‡å¯kubelet</strong></p>
<pre><code>service kubelet restart
</code></pre>
<h2 id="éªŒè¯">éªŒè¯</h2>
<pre><code>[root@m3 pki]# kubectl  describe node m1
Name:               m1
Roles:              master
Labels:             beta.kubernetes.io/arch=amd64
....
CreationTimestamp:  Mon, 26 Aug 2019 20:35:35 -0400
...
Addresses:
  InternalIP:  172.27.100.13
  Hostname:    m1
Capacity:
 cpu:                4
 ephemeral-storage:  36678148Ki
 hugepages-1Gi:      0
 hugepages-2Mi:      0
 memory:             8010576Ki
 pods:               110
Allocatable:
 cpu:                3
 ephemeral-storage:  23065162901
 hugepages-1Gi:      0
 hugepages-2Mi:      0
 memory:             6884176Ki
 pods:               110
</code></pre>
<ul>
<li>å¯ä»¥çœ‹åˆ°é¢„ç•™åï¼Œå¯ç”¨CPUä¸º3ï¼Œä¸é¢„ç•™ä¸º4ï¼Œå†…å­˜æ˜¯ä¸€æ ·çš„è®¡ç®—æ–¹å¼ï¼Œæ­¤å¤„é¢„ç•™äº†1Gï¼ˆ500Mi+500Miï¼‰</li>
</ul>
<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2>
<p>https://github.com/rootsongjc/qa/issues/3</p>
<p>https://cloud.tencent.com/developer/article/1097002</p>
<p>https://blog.csdn.net/ahilll/article/details/82109008</p>
<p>http://dockone.io/article/4797</p>
<p>https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/</p>
<p>https://kubernetes.io/zh/docs/tasks/administer-cluster/kubelet-config-file/</p>
<p>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubelet/config/v1beta1/types.go</p>
<p>https://www.bladewan.com/2018/01/26/k8s_resource_resver/</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä¿®æ”¹kubernetesè¯ä¹¦è¿‡æœŸæ—¶é—´çš„éªšæ“ä½œ]]></title>
        <id>https://p.guipulp.top//post/2019083001</id>
        <link href="https://p.guipulp.top//post/2019083001">
        </link>
        <updated>2019-08-30T08:50:14.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>ç®€å•éªŒè¯ï¼ˆéšæœºä¿®æ”¹ç³»ç»Ÿæ—¶é—´ï¼‰æ˜¯æœ‰æ•ˆçš„ï¼ˆ10å¹´å†…ï¼‰ï¼Œå…·ä½“ç”¨èµ·æ¥æ€æ ·ï¼Œè‡ªå·±å»æµ‹è¯•å§ã€‚</p>
</blockquote>
<p>æœ€è¿‘å…¬å¸æ—©æœŸéƒ¨ç½²çš„kubernetesçš„é›†ç¾¤è¯ä¹¦è¿‡æœŸï¼Œç ”ç©¶äº†ä¸‹kubernetesçš„è¯ä¹¦æ—¶é—´ï¼Œå¤§è‡´ä¸Šæ˜¯è¯´ä¿®æ”¹kubeadmçš„æºä»£ç ï¼Œè‡ªå·±ç¼–è¯‘kubeadmï¼Œå®ç°è¯ä¹¦99å¹´ã€‚</p>
<p>kubernetesé»˜è®¤CAè¯ä¹¦10å¹´ï¼Œå¾ˆå°‘æœ‰ä¼ä¸šçš„ä¸€ä¸ªæœåŠ¡èƒ½è·‘10å¹´ä¸æ›´æ¢ï¼Œå› æ­¤æƒ³åˆ°ä»¥ä¸‹æ–¹æ³•è¿›è¡Œäº†ä»¥ä¸‹å®éªŒã€‚æµ‹è¯•æš‚æ—¶æ²¡å‘ç°ä»€ä¹ˆé—®é¢˜ã€‚</p>
<p>å¦‚æœæœ‰å¤šmasterï¼Œéœ€è¦åœ¨æ¯ä¸ªmasterä¸Šè¿›è¡Œä»¥ä¸‹æ“ä½œã€‚</p>
<pre><code>[root@m2 pki]# date -s 8/30/2028
2028å¹´ 08æœˆ 30æ—¥ æ˜ŸæœŸä¸‰ 00:00:00 EDT
[root@m2 pki]# kubectl get pods
Unable to connect to the server: x509: certificate has expired or is not yet valid
[root@m2 pki]# kubectl get pods
Unable to connect to the server: x509: certificate has expired or is not yet valid
[root@m2 pki]# kubeadm alpha certs renew all
certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed
certificate for serving the Kubernetes API renewed
certificate the apiserver uses to access etcd renewed
certificate for the API server to connect to kubelet renewed
certificate embedded in the kubeconfig file for the controller manager to use renewed
certificate for liveness probes to healtcheck etcd renewed
certificate for etcd nodes to communicate with each other renewed
certificate for serving etcd renewed
certificate for the front proxy client renewed
certificate embedded in the kubeconfig file for the scheduler manager to use renewed
[root@m2 pki]# ntpdate 0.cn.pool.ntp.org
30 Aug 04:51:35 ntpdate[9983]: step time server 203.107.6.88 offset -284065763.328437 sec
[root@m2 pki]# cp /etc/kubernetes/admin.conf ~/.kube/config
cpï¼šæ˜¯å¦è¦†ç›–&quot;/root/.kube/config&quot;ï¼Ÿ y
[root@m2 pki]# openssl x509 -in apiserver.crt -noout -text
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 6495439138002669247 (0x5a246f7b50d18ebf)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=kubernetes
        Validity
            Not Before: Aug 27 00:34:59 2019 GMT
            Not After : Aug 30 04:00:30 2029 GMT
        Subject: CN=kube-apiserver
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:d5:c5:1a:60:e3:dd:5c:68:c6:a0:38:df:06:54:
                    7b:87:73:3f:6d:1b:bc:65:4e:8e:1a:e0:a7:13:a9:
                    df:a6:67:65:13:cb:c6:e7:c8:5e:60:3e:14:7d:c4:
                    e0:91:d5:de:8b:91:bd:9c:59:2b:35:87:62:87:c9:
                    97:c4:f6:c6:41:b4:6a:80:25:34:1a:d2:b4:ad:e0:
                    bc:d0:af:18:35:68:b9:46:7b:1e:af:da:24:ce:79:
                    94:75:77:3d:ae:67:ac:b9:08:5a:74:87:fd:c0:33:
                    ec:d9:d5:ba:71:ee:23:9e:39:69:fa:2f:76:3f:e1:
                    80:a4:89:a3:39:40:f9:ef:a6:f5:4c:27:3a:7c:60:
                    aa:83:ce:cf:48:2a:e9:6c:15:88:21:8b:fb:53:f8:
                    05:15:bf:35:10:9d:4e:63:f9:09:ae:9c:45:b2:75:
                    4f:8f:4e:a9:9f:bc:f8:c0:9f:29:bc:5d:a3:8f:a9:
                    c7:d1:ea:85:d4:79:32:e1:e3:b7:2f:08:eb:47:99:
                    af:db:b4:5d:a7:d9:c0:7f:29:63:ec:f4:bb:ba:9b:
                    16:f4:c1:11:28:37:7c:c8:f9:13:7b:38:86:83:ba:
                    f7:e8:dd:fd:05:9e:7c:46:4a:1e:d9:9e:8e:0c:ad:
                    86:09:70:da:40:46:e7:e8:5c:82:26:08:3a:4e:ad:
                    8a:a3
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Extended Key Usage:
                TLS Web Server Authentication
            X509v3 Subject Alternative Name:
                DNS:m2, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:10.96.0.1, IP Address:172.27.100.14, IP Address:172.27.100.211, IP Address:172.29.100.211
    Signature Algorithm: sha256WithRSAEncryption
         ab:31:c7:2a:a2:52:40:e2:b5:c6:a4:fc:d7:f5:35:2c:c9:28:
         8d:ba:6a:1d:c3:06:d0:85:4e:bf:43:0c:27:a2:2f:13:62:97:
         89:cc:4e:0c:17:86:11:ef:21:2a:01:9d:1c:25:f2:48:c5:31:
         95:63:41:2c:57:2a:1c:1f:40:00:2f:1a:b1:90:7b:3d:6a:2b:
         7c:6f:33:9a:c8:09:44:4d:a4:ff:fa:06:de:77:66:e1:0f:59:
         29:bd:76:d1:52:b9:63:81:b4:ae:27:0f:ed:54:93:b1:21:8b:
         bf:4f:16:9e:b2:4d:dd:2f:ac:81:e8:86:38:c8:2d:d9:38:1b:
         ac:56:23:5e:8c:dc:96:ae:24:3f:dd:7f:ce:ba:97:b5:e7:07:
         05:df:f2:fd:ba:51:6d:94:13:c5:2d:a8:75:32:21:ad:e9:07:
         13:04:64:e9:c5:f9:3c:46:39:9a:16:59:3b:ff:91:af:7b:fb:
         14:6d:2e:66:2d:52:0d:1b:45:ba:e4:0c:42:23:1c:2c:ea:53:
         6a:20:88:87:24:b1:55:39:d0:93:7b:44:46:bc:46:16:37:d6:
         ff:e6:2f:dd:05:53:03:bc:d6:ba:32:1c:8a:7c:74:4b:cc:4d:
         3b:20:b6:80:a0:a8:28:a5:da:fb:0b:3a:43:c3:b7:79:86:a8:
         2e:cc:91:48

</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[iptablesçš„å››è¡¨äº”é“¾]]></title>
        <id>https://p.guipulp.top//post/2019082802</id>
        <link href="https://p.guipulp.top//post/2019082802">
        </link>
        <updated>2019-08-28T04:44:56.000Z</updated>
        <content type="html"><![CDATA[<h2 id="netfilterä»‹ç»">netfilterä»‹ç»</h2>
<ul>
<li>å®ƒæ˜¯iptablesçš„ä¸»è¦çš„å·¥ä½œæ¨¡å—ï¼Œä½äºå†…æ ¸ä¸­ï¼Œåœ¨ç½‘ç»œå±‚çš„äº”ä¸ªä½ç½®ï¼ˆä¹Ÿå°±æ˜¯é˜²ç«å¢™å››è¡¨äº”é“¾ä¸­çš„äº”é“¾ï¼‰æ³¨å†Œäº†ä¸€äº›é’©å­å‡½æ•°ï¼Œç”¨æ¥æŠ“å–æ•°æ®åŒ…ï¼›</li>
<li>æŠŠæ•°æ®åŒ…çš„ä¿¡æ¯æ‹¿å‡ºæ¥åŒ¹é…å„ä¸ªé“¾ä½ç½®åœ¨å¯¹åº”è¡¨ä¸­çš„è§„åˆ™ï¼›</li>
<li>åŒ¹é…ä¹‹åï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ACCEPTã€DROPç­‰ç­‰ï¼›</li>
</ul>
<h3 id="netfilterå’Œiptablesçš„å…³ç³»å›¾">netfilterå’Œiptablesçš„å…³ç³»å›¾</h3>
<p><img src="https://img.mubu.com/document_image/e0653c59-e432-40d9-a8bd-38558599a4da-1235096.jpg" alt="img"></p>
<h2 id="å››è¡¨äº”é“¾">å››è¡¨äº”é“¾</h2>
<ul>
<li>é“¾å°±æ˜¯ä½ç½®ï¼šå…±æœ‰äº”ä¸ªï¼Œè¿›è·¯ç”±(PREROUTING)ã€è¿›ç³»ç»Ÿ(INPUT) ã€è½¬å‘(FORWARD)ã€å‡ºç³»ç»Ÿ(OUTPUT)ã€å‡ºè·¯ç”±(POSTROUTING)ï¼›</li>
<li>è¡¨å°±æ˜¯å­˜å‚¨çš„è§„åˆ™ï¼›æ•°æ®åŒ…åˆ°äº†è¯¥é“¾å¤„ï¼Œä¼šå»å¯¹åº”è¡¨ä¸­æŸ¥è¯¢è®¾ç½®çš„è§„åˆ™ï¼Œç„¶åå†³å®šæ˜¯å¦æ”¾è¡Œã€ä¸¢å¼ƒã€è½¬å‘è¿˜æ˜¯ä¿®æ”¹ç­‰ç­‰æ“ä½œã€‚</li>
</ul>
<h3 id="å››è¡¨">å››è¡¨</h3>
<ul>
<li>filterè¡¨â€”â€”è¿‡æ»¤æ•°æ®åŒ…</li>
<li>Natè¡¨â€”â€”ç”¨äºç½‘ç»œåœ°å€è½¬æ¢ï¼ˆIPã€ç«¯å£ï¼‰</li>
<li>Mangleè¡¨â€”â€”ä¿®æ”¹æ•°æ®åŒ…çš„æœåŠ¡ç±»å‹ã€TTLã€å¹¶ä¸”å¯ä»¥é…ç½®è·¯ç”±å®ç°QOS</li>
<li>Rawè¡¨â€”â€”å†³å®šæ•°æ®åŒ…æ˜¯å¦è¢«çŠ¶æ€è·Ÿè¸ªæœºåˆ¶å¤„ç†</li>
</ul>
<h3 id="äº”é“¾">äº”é“¾</h3>
<ul>
<li>INPUTé“¾â€”â€”è¿›æ¥çš„æ•°æ®åŒ…åº”ç”¨æ­¤è§„åˆ™é“¾ä¸­çš„ç­–ç•¥</li>
<li>OUTPUTé“¾â€”â€”å¤–å‡ºçš„æ•°æ®åŒ…åº”ç”¨æ­¤è§„åˆ™é“¾ä¸­çš„ç­–ç•¥</li>
<li>FORWARDé“¾â€”â€”è½¬å‘æ•°æ®åŒ…æ—¶åº”ç”¨æ­¤è§„åˆ™é“¾ä¸­çš„ç­–ç•¥</li>
<li>PREROUTINGé“¾â€”â€”å¯¹æ•°æ®åŒ…ä½œè·¯ç”±é€‰æ‹©å‰åº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™ï¼ˆæ‰€æœ‰çš„æ•°æ®åŒ…è¿›æ¥çš„æ—¶ä¾¯éƒ½å…ˆç”±è¿™ä¸ªé“¾å¤„ç†ï¼‰</li>
<li>POSTROUTINGé“¾â€”â€”å¯¹æ•°æ®åŒ…ä½œè·¯ç”±é€‰æ‹©ååº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™ï¼ˆæ‰€æœ‰çš„æ•°æ®åŒ…å‡ºæ¥çš„æ—¶ä¾¯éƒ½å…ˆç”±è¿™ä¸ªé“¾å¤„ç†ï¼‰</li>
</ul>
<h3 id="é“¾è¡¨å…³ç³»å›¾">é“¾è¡¨å…³ç³»å›¾</h3>
<p><img src="https://img2018.cnblogs.com/blog/1479220/201809/1479220-20180926150504012-1967719887.png" alt="image-20190828125115128"></p>
<h3 id="æ•°æ®å¤„ç†æµç¨‹">æ•°æ®å¤„ç†æµç¨‹</h3>
<p>æˆ‘ä»¬ç»“åˆä¸‹é¢çš„å›¾ä¸¾ä¸ªä¾‹å­ï¼š<br>
å‡å¦‚æœ‰æ•°æ®åŒ…ä»Network INè¦é€šè¿‡iptablesï¼Œæ•°æ®åŒ…æµå‘å¦‚ä¸‹ï¼š<br>
1.Network INæ•°æ®åŒ…åˆ°è¾¾æœåŠ¡å™¨çš„ç½‘ç»œæ¥å£<br>
2.è¿›å…¥rawè¡¨çš„ PREROUTING é“¾ï¼Œè¿™ä¸ªé“¾çš„ä½œç”¨æ˜¯å†³å®šæ•°æ®åŒ…æ˜¯å¦è¢«çŠ¶æ€è·Ÿè¸ªã€‚<br>
è¿›å…¥ mangle è¡¨çš„ PREROUTING é“¾ï¼Œåœ¨æ­¤å¯ä»¥ä¿®æ”¹æ•°æ®åŒ…ï¼Œæ¯”å¦‚ TOS ç­‰ã€‚<br>
è¿›å…¥ nat è¡¨çš„ PREROUTING é“¾ï¼Œå¯ä»¥åœ¨æ­¤åšDNAT(ç›®æ ‡åœ°å€è½¬æ¢)<br>
3.å†³å®šè·¯ç”±ï¼ŒæŸ¥çœ‹ç›®æ ‡åœ°å€æ˜¯äº¤ç»™æœ¬åœ°ä¸»æœºè¿˜æ˜¯è½¬å‘ç»™å…¶å®ƒä¸»æœºã€‚</p>
<p>4.åˆ°è¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æƒ…å†µæ˜¯æ•°æ®åŒ…è¦è½¬å‘ç»™å…¶å®ƒä¸»æœºï¼ˆä¸€èˆ¬æƒ…å†µä¸‹å®ƒæ˜¯åœ¨æ‹…ä»»ç½‘å…³æœåŠ¡å™¨ï¼‰ï¼Œæ•°æ®åŒ…ä¼šä¾æ¬¡ç»è¿‡ï¼š<br>
5.è¿›å…¥ mangle è¡¨çš„ FORWARD é“¾ï¼Œ<br>
è¿›å…¥ filter è¡¨çš„ FORWARD é“¾ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¯¹æ‰€æœ‰è½¬å‘çš„æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤ã€‚<br>
6.è¿›å…¥ mangle è¡¨çš„ POSTROUTING é“¾<br>
è¿›å…¥ nat è¡¨çš„ POSTROUTING é“¾ï¼Œåœ¨è¿™é‡Œä¸€èˆ¬éƒ½æ˜¯ç”¨æ¥åš SNAT ï¼ˆæºåœ°å€è½¬æ¢ï¼‰<br>
7.æ•°æ®åŒ…æµå‡ºç½‘ç»œæ¥å£ï¼Œå‘å¾€network outã€‚</p>
<p>8.å¦ä¸€ç§æƒ…å†µï¼Œæ•°æ®åŒ…çš„ç›®æ ‡åœ°å€å°±æ˜¯å‘ç»™æœ¬åœ°ä¸»æœºçš„ï¼Œå®ƒä¼šä¾æ¬¡ç©¿è¿‡ï¼š<br>
9.è¿›å…¥ mangle è¡¨çš„ INPUT é“¾ï¼Œ<br>
è¿›å…¥ filter è¡¨çš„ INPUT é“¾ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¯¹æµå…¥çš„æ‰€æœ‰æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤ï¼Œ<br>
æ•°æ®åŒ…äº¤ç»™æœ¬åœ°ä¸»æœºçš„åº”ç”¨ç¨‹åºè¿›è¡Œå¤„ç†ã€‚<br>
10.åº”ç”¨ç¨‹åºå¤„ç†å®Œæ¯•åå‘é€çš„æ•°æ®åŒ…è¿›è¡Œè·¯ç”±å‘é€å†³å®šã€‚<br>
11.è¿›å…¥ raw è¡¨çš„ OUTPUT é“¾ã€‚<br>
è¿›å…¥ mangle è¡¨çš„ OUTPUT é“¾ï¼Œ<br>
è¿›å…¥ nat è¡¨çš„ OUTPUT é“¾ï¼Œ<br>
è¿›å…¥ filter è¡¨çš„ OUTPUT é“¾ã€‚<br>
12.è¿›å…¥ mangle è¡¨çš„ POSTROUTING é“¾ï¼Œ<br>
è¿›å…¥ nat è¡¨çš„ POSTROUTING é“¾ã€‚<br>
13.è¿›å…¥å‡ºå»çš„ç½‘ç»œæ¥å£ï¼Œå‘é€å¾€network outã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬è¦è¿‡æ»¤æ§åˆ¶åŒ…çš„è¿›å‡ºï¼Œåªéœ€è¦æŠŠinput chainå’Œforward chainè¿™ä¸¤ä¸ªå…³å£æŠŠæ§ä½å°±å¥½äº†ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦æŠŠinput chainå’Œforward chainé»˜è®¤è®¾ç½®ä¸ºdropçš„åŸå› ã€‚</p>
<ul>
<li>
<p>å›¾ä¸€</p>
<p><img src="https://img.mubu.com/document_image/c1b9ef44-0c8d-4818-a18b-83b527e8d0e4-1235096.jpg" alt="img"></p>
</li>
<li>
<p>å›¾äºŒ</p>
<p><img src="https://img.mubu.com/document_image/bcb89f30-1a57-4967-9a41-3cb6e2c8a5bc-1235096.jpg" alt="img"></p>
</li>
</ul>
<h2 id="iptablesæ“ä½œ">iptablesæ“ä½œ</h2>
<pre><code>iptables [-t è¡¨å] é€‰é¡¹ [é“¾å] [æ¡ä»¶] [-j æ§åˆ¶ç±»å‹]

-P è®¾ç½®é»˜è®¤ç­–ç•¥:iptables
 
-P INPUT (DROP|ACCEPT)
 
-F æ¸…ç©ºè§„åˆ™é“¾
 
-L æŸ¥çœ‹è§„åˆ™é“¾
 
-A åœ¨è§„åˆ™é“¾çš„æœ«å°¾åŠ å…¥æ–°è§„åˆ™
 
-I num åœ¨è§„åˆ™é“¾çš„å¤´éƒ¨åŠ å…¥æ–°è§„åˆ™
 
-D num åˆ é™¤æŸä¸€æ¡è§„åˆ™
 
-s åŒ¹é…æ¥æºåœ°å€IP/MASKï¼ŒåŠ å¹å·&quot;!&quot;è¡¨ç¤ºé™¤è¿™ä¸ªIPå¤–ã€‚
 
-d åŒ¹é…ç›®æ ‡åœ°å€
 
-i ç½‘å¡åç§° åŒ¹é…ä»è¿™å—ç½‘å¡æµå…¥çš„æ•°æ®
 
-o ç½‘å¡åç§° åŒ¹é…ä»è¿™å—ç½‘å¡æµå‡ºçš„æ•°æ®
 
-p åŒ¹é…åè®®,å¦‚tcp,udp,icmp
 
--dport num åŒ¹é…ç›®æ ‡ç«¯å£å·
 
--sport num åŒ¹é…æ¥æºç«¯å£å·
</code></pre>
<h3 id="å¸¸ç”¨iptablesçš„è¯­å¥">å¸¸ç”¨iptablesçš„è¯­å¥</h3>
<pre><code>1. åˆ é™¤å·²æœ‰è§„åˆ™
åœ¨å¼€å§‹åˆ›å»ºiptablesè§„åˆ™ä¹‹å‰ï¼Œä½ ä¹Ÿè®¸éœ€è¦åˆ é™¤å·²æœ‰è§„åˆ™ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š
iptables -F
(or)
iptables â€“flush
æŸ¥çœ‹å·²æœ‰è§„åˆ™
iptables -nL
 
 
2.è®¾ç½®é“¾çš„é»˜è®¤ç­–ç•¥
é“¾çš„é»˜è®¤æ”¿ç­–è®¾ç½®ä¸ºâ€ACCEPTâ€ï¼ˆæ¥å—ï¼‰ï¼Œè‹¥è¦å°†INPUT,FORWARD,OUTPUTé“¾è®¾ç½®æˆâ€DROPâ€ï¼ˆæ‹’ç»ï¼‰ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP
å½“INPUTé“¾å’ŒOUTPUTé“¾éƒ½è®¾ç½®æˆDROPæ—¶ï¼Œå¯¹äºæ¯ä¸€ä¸ªé˜²ç«å¢™è§„åˆ™ï¼Œæˆ‘ä»¬éƒ½åº”è¯¥å®šä¹‰ä¸¤ä¸ªè§„åˆ™ã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªä¼ å…¥å¦ä¸€ä¸ªä¼ å‡ºã€‚åœ¨ä¸‹é¢æ‰€æœ‰çš„ä¾‹å­ä¸­ï¼Œç”±äºæˆ‘ä»¬å·²å°†DROPè®¾ç½®æˆINPUTé“¾å’ŒOUTPUTé“¾çš„é»˜è®¤ç­–ç•¥ï¼Œæ¯ç§æƒ…å†µæˆ‘ä»¬éƒ½å°†åˆ¶å®šä¸¤æ¡è§„åˆ™ã€‚
å½“ç„¶ï¼Œå¦‚æœä½ ç›¸ä¿¡ä½ çš„å†…éƒ¨ç”¨æˆ·,åˆ™å¯ä»¥çœç•¥ä¸Šé¢çš„æœ€åä¸€è¡Œã€‚ä¾‹å¦‚ï¼šé»˜è®¤ä¸ä¸¢å¼ƒæ‰€æœ‰å‡ºç«™çš„æ•°æ®åŒ…ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹,å¯¹äºæ¯ä¸€ä¸ªé˜²ç«å¢™è§„åˆ™è¦æ±‚,ä½ åªéœ€è¦åˆ¶å®šä¸€ä¸ªè§„åˆ™â€”â€”åªå¯¹è¿›ç«™çš„æ•°æ®åŒ…åˆ¶å®šè§„åˆ™ã€‚
 
 
3. é˜»æ­¢æŒ‡å®šIPåœ°å€
ä¾‹ï¼šä¸¢å¼ƒæ¥è‡ªIPåœ°å€x.x.x.xçš„åŒ…
BLOCK_THIS_IP=&quot;x.x.x.x&quot;
iptables -A INPUT -s &quot;$BLOCK_THIS_IP&quot; -j DROP
æ³¨ï¼šå½“ä½ åœ¨logé‡Œå‘ç°æ¥è‡ªæŸipåœ°å€çš„å¼‚å¸¸è®°å½•ï¼Œå¯ä»¥é€šè¿‡æ­¤å‘½ä»¤æš‚æ—¶é˜»æ­¢è¯¥åœ°å€çš„è®¿é—®ä»¥åšæ›´æ·±å…¥åˆ†æ
ä¾‹ï¼šé˜»æ­¢æ¥è‡ªIPåœ°å€x.x.x.x eth0 tcpçš„åŒ…
iptables -A INPUT -i eth0 -s &quot;$BLOCK_THIS_IP&quot; -j DROP
iptables -A INPUT -i eth0 -p tcp -s &quot;$BLOCK_THIS_IP&quot; -j DROP
 
 
4. å…è®¸æ‰€æœ‰SSHçš„è¿æ¥è¯·æ±‚
ä¾‹ï¼šå…è®¸æ‰€æœ‰æ¥è‡ªå¤–éƒ¨çš„SSHè¿æ¥è¯·æ±‚ï¼Œå³åªå…è®¸è¿›å…¥eth0æ¥å£ï¼Œå¹¶ä¸”ç›®æ ‡ç«¯å£ä¸º22çš„æ•°æ®åŒ…
iptables -A INPUT -i eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
 
 
5. ä»…å…è®¸æ¥è‡ªæŒ‡å®šç½‘ç»œçš„SSHè¿æ¥è¯·æ±‚
ä¾‹ï¼šä»…å…è®¸æ¥è‡ªäº192.168.100.0/24åŸŸçš„ç”¨æˆ·çš„sshè¿æ¥è¯·æ±‚
iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
 
 
6.å…è®¸httpå’Œhttpsçš„è¿æ¥è¯·æ±‚
ä¾‹ï¼šå…è®¸æ‰€æœ‰æ¥è‡ªweb - httpçš„è¿æ¥è¯·æ±‚
iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT
ä¾‹ï¼šå…è®¸æ‰€æœ‰æ¥è‡ªweb - httpsçš„è¿æ¥è¯·æ±‚
iptables -A INPUT -i eth0 -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
 
 
7. ä½¿ç”¨multiport å°†å¤šä¸ªè§„åˆ™ç»“åˆåœ¨ä¸€èµ·
å…è®¸å¤šä¸ªç«¯å£ä»å¤–ç•Œè¿å…¥ï¼Œé™¤äº†ä¸ºæ¯ä¸ªç«¯å£éƒ½å†™ä¸€æ¡ç‹¬ç«‹çš„è§„åˆ™å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨multiportå°†å…¶ç»„åˆæˆä¸€æ¡è§„åˆ™ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
ä¾‹ï¼šå…è®¸æ‰€æœ‰ssh,http,httpsçš„æµé‡è®¿é—®
iptables -A INPUT -i eth0 -p tcp -m multiport --dports 22,80,443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp -m multiport --sports 22,80,443 -m state --state ESTABLISHED -j ACCEPT
 
 
8. å…è®¸ä»æœ¬åœ°å‘èµ·çš„SSHè¯·æ±‚
iptables -A OUTPUT -o eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
è¯·æ³¨æ„,è¿™ä¸å…è®¸sshè¿å…¥çš„è§„åˆ™ç•¥æœ‰ä¸åŒã€‚æœ¬ä¾‹åœ¨OUTPUTé“¾ä¸Šï¼Œæˆ‘ä»¬å…è®¸NEWå’ŒESTABLISHEDçŠ¶æ€ã€‚åœ¨INPUTé“¾ä¸Šï¼Œæˆ‘ä»¬åªå…è®¸ESTABLISHEDçŠ¶æ€ã€‚sshè¿å…¥çš„è§„åˆ™ä¸ä¹‹ç›¸åã€‚
 
 
9. ä»…å…è®¸ä»æœ¬åœ°å‘èµ·åˆ°ä¸€ä¸ªæŒ‡å®šçš„ç½‘ç»œåŸŸçš„SSHè¯·æ±‚
ä¾‹ï¼šä»…å…è®¸ä»å†…éƒ¨è¿æ¥åˆ°ç½‘åŸŸ192.168.100.0/24
iptables -A OUTPUT -o eth0 -p tcp -d 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
 
 
10. å…è®¸ä»æœ¬åœ°å‘èµ·çš„HTTPSè¿æ¥è¯·æ±‚
ä¸‹é¢çš„è§„åˆ™å…è®¸è¾“å‡ºå®‰å…¨çš„ç½‘ç»œæµé‡ã€‚å¦‚æœä½ æƒ³å…è®¸ç”¨æˆ·è®¿é—®äº’è”ç½‘ï¼Œè¿™æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚åœ¨æœåŠ¡å™¨ä¸Šï¼Œè¿™äº›è§„åˆ™èƒ½è®©ä½ ä½¿ç”¨wgetä»å¤–éƒ¨ä¸‹è½½ä¸€äº›æ–‡ä»¶
iptables -A OUTPUT -o eth0 -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
æ³¨ï¼šå¯¹äºHTTP webæµé‡çš„å¤–è”è¯·æ±‚ï¼Œåªéœ€è¦å°†ä¸Šè¿°å‘½ä»¤ä¸­çš„ç«¯å£ä»443æ”¹æˆ80å³å¯ã€‚
 
 
11. è´Ÿè½½å¹³è¡¡ä¼ å…¥çš„ç½‘ç»œæµé‡
ä½¿ç”¨iptableså¯ä»¥å®ç°ä¼ å…¥webæµé‡çš„è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥webæµé‡è´Ÿè½½å¹³è¡¡ä½¿ç”¨iptablesé˜²ç«å¢™è§„åˆ™ã€‚
ä¾‹ï¼šä½¿ç”¨iptables nthå°†HTTPSæµé‡è´Ÿè½½å¹³è¡¡è‡³ä¸‰ä¸ªä¸åŒçš„ipåœ°å€ã€‚
iptables -A PREROUTING -i eth0 -p tcp --dport 443 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.101:443
iptables -A PREROUTING -i eth0 -p tcp --dport 443 -m state --state NEW -m nth --counter 0 --every 3 --packet 1 -j DNAT --to-destination 192.168.1.102:443
iptables -A PREROUTING -i eth0 -p tcp --dport 443 -m state --state NEW -m nth --counter 0 --every 3 --packet 2 -j DNAT --to-destination 192.168.1.103:443
 
 
12. å…è®¸å¤–éƒ¨ä¸»æœºpingå†…éƒ¨ä¸»æœº
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT
 
 
13. å…è®¸å†…éƒ¨ä¸»æœºpingå¤–éƒ¨ä¸»æœº
iptables -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT
 
 
14. å…è®¸å›ç¯è®¿é—® ä¾‹ï¼šåœ¨æœåŠ¡å™¨ä¸Šå…è®¸127.0.0.1å›ç¯è®¿é—®ã€‚
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
 
 
15. å…è®¸å†…éƒ¨ç½‘ç»œåŸŸå¤–éƒ¨ç½‘ç»œçš„é€šä¿¡
é˜²ç«å¢™æœåŠ¡å™¨ä¸Šçš„å…¶ä¸­ä¸€ä¸ªç½‘å¡è¿æ¥åˆ°å¤–éƒ¨ï¼Œå¦ä¸€ä¸ªç½‘å¡è¿æ¥åˆ°å†…éƒ¨æœåŠ¡å™¨ï¼Œä½¿ç”¨ä»¥ä¸‹è§„åˆ™å…è®¸å†…éƒ¨ç½‘ç»œä¸å¤–éƒ¨ç½‘ç»œçš„é€šä¿¡ã€‚æ­¤ä¾‹ä¸­ï¼Œeth1è¿æ¥åˆ°å¤–éƒ¨ç½‘ç»œ(äº’è”ç½‘)ï¼Œeth0è¿æ¥åˆ°å†…éƒ¨ç½‘ç»œ(ä¾‹å¦‚:192.168.1.x)ã€‚
iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT
 
 
16. å…è®¸å‡ºç«™çš„DNSè¿æ¥
iptables -A OUTPUT -p udp -o eth0 --dport 53 -j ACCEPT
iptables -A INPUT -p udp -i eth0 --sport 53 -j ACCEPT
 
 
17. å…è®¸NISè¿æ¥
å¦‚æœä½ ä½¿ç”¨NISç®¡ç†ç”¨æˆ·å¸æˆ·ï¼Œä½ éœ€è¦å…è®¸NISè¿æ¥ã€‚å¦‚æœä½ ä¸å…è®¸NISç›¸å…³çš„ypbindè¿æ¥è¯·æ±‚ï¼Œå³ä½¿SSHè¿æ¥è¯·æ±‚å·²è¢«å…è®¸ï¼Œç”¨æˆ·ä»ç„¶æ— æ³•ç™»å½•ã€‚NISçš„ç«¯å£æ˜¯åŠ¨æ€çš„ï¼Œå…ˆä½¿ç”¨å‘½ä»¤rpcinfo â€“pæ¥çŸ¥é“ç«¯å£å·ï¼Œæ­¤ä¾‹ä¸­ä¸º853å’Œ850ç«¯å£ã€‚
rpcinfo -p | grep ypbind
ä¾‹ï¼šå…è®¸æ¥è‡ª111ç«¯å£ä»¥åŠypbindä½¿ç”¨ç«¯å£çš„è¿æ¥è¯·æ±‚
iptables -A INPUT -p tcp --dport 111 -j ACCEPT
iptables -A INPUT -p udp --dport 111 -j ACCEPT
iptables -A INPUT -p tcp --dport 853 -j ACCEPT
iptables -A INPUT -p udp --dport 853 -j ACCEPT
iptables -A INPUT -p tcp --dport 850 -j ACCEPT
iptables -A INPUT -p udp --dport 850 -j ACCEPT
æ³¨ï¼šå½“ä½ é‡å¯ypbindä¹‹åç«¯å£å°†ä¸åŒï¼Œä¸Šè¿°å‘½ä»¤å°†æ— æ•ˆã€‚æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š
1ï¼‰ä½¿ç”¨ä½ NISçš„é™æ€IP
2ï¼‰ç¼–å†™shellè„šæœ¬é€šè¿‡â€œrpcinfo - pâ€å‘½ä»¤è‡ªåŠ¨è·å–åŠ¨æ€ç«¯å£å·,å¹¶åœ¨ä¸Šè¿°iptablesè§„åˆ™ä¸­ä½¿ç”¨ã€‚
 
 
18. å…è®¸æ¥è‡ªæŒ‡å®šç½‘ç»œçš„rsyncè¿æ¥è¯·æ±‚
ä¾‹ï¼šå…è®¸æ¥è‡ªç½‘ç»œ192.168.101.0/24çš„rsyncè¿æ¥è¯·æ±‚
iptables -A INPUT -i eth0 -p tcp -s 192.168.101.0/24 --dport 873 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 873 -m state --state ESTABLISHED -j ACCEPT
 
 
19. å…è®¸æ¥è‡ªæŒ‡å®šç½‘ç»œçš„MySQLè¿æ¥è¯·æ±‚
å¾ˆå¤šæƒ…å†µä¸‹ï¼ŒMySQLæ•°æ®åº“ä¸webæœåŠ¡è·‘åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šã€‚æœ‰æ—¶å€™æˆ‘ä»¬ä»…å¸Œæœ›DBAå’Œå¼€å‘äººå‘˜ä»å†…éƒ¨ç½‘ç»œï¼ˆ192.168.100.0/24ï¼‰ç›´æ¥ç™»å½•æ•°æ®åº“ï¼Œå¯å°è¯•ä»¥ä¸‹å‘½ä»¤ï¼š
iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 3306 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 3306 -m state --state ESTABLISHED -j ACCEPT
 
 
20. å…è®¸Sendmail, Postfixé‚®ä»¶æœåŠ¡
Sendmailå’Œpostfixéƒ½ä½¿ç”¨äº†25ç«¯å£ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å…è®¸æ¥è‡ª25ç«¯å£çš„è¿æ¥è¯·æ±‚å³å¯ã€‚
iptables -A INPUT -i eth0 -p tcp --dport 25 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 25 -m state --state ESTABLISHED -j ACCEPT
 
 
21. å…è®¸IMAPå’ŒIMAPS ä¾‹ï¼šå…è®¸IMAP/IMAP2æµé‡ï¼Œç«¯å£ä¸º143
iptables -A INPUT -i eth0 -p tcp --dport 143 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 143 -m state --state ESTABLISHED -j ACCEPT
ä¾‹ï¼šå…è®¸IMAPSæµé‡ï¼Œç«¯å£ä¸º993
iptables -A INPUT -i eth0 -p tcp --dport 993 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 993 -m state --state ESTABLISHED -j ACCEPT
 
 
22. å…è®¸POP3å’ŒPOP3S ä¾‹ï¼šå…è®¸POP3è®¿é—®
iptables -A INPUT -i eth0 -p tcp --dport 110 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 110 -m state --state ESTABLISHED -j ACCEPT
ä¾‹ï¼šå…è®¸POP3Sè®¿é—®
iptables -A INPUT -i eth0 -p tcp --dport 995 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 995 -m state --state ESTABLISHED -j ACCEPT
 
 
23. é˜²æ­¢DoSæ”»å‡»
iptables -A INPUT -p tcp --dport 80 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT
ä¸Šè¿°ä¾‹å­ä¸­ï¼š -m limit: å¯ç”¨limitæ‰©å±• â€“limit 25/minute: å…è®¸æœ€å¤šæ¯åˆ†é’Ÿ25ä¸ªè¿æ¥ï¼ˆæ ¹æ®éœ€æ±‚æ›´æ”¹ï¼‰ã€‚ â€“limit-burst 100: åªæœ‰å½“è¿æ¥è¾¾åˆ°limit-burstæ°´å¹³(æ­¤ä¾‹ä¸º100)æ—¶æ‰å¯ç”¨ä¸Šè¿°limit/minuteé™åˆ¶ã€‚
 
 
24. ç«¯å£è½¬å‘ ä¾‹ï¼šå°†æ¥è‡ª422ç«¯å£çš„æµé‡å…¨éƒ¨è½¬åˆ°22ç«¯å£ã€‚
è¿™æ„å‘³ç€æˆ‘ä»¬æ—¢èƒ½é€šè¿‡422ç«¯å£åˆèƒ½é€šè¿‡22ç«¯å£è¿›è¡Œsshè¿æ¥ã€‚å¯ç”¨DNATè½¬å‘ã€‚
iptables -t nat -A PREROUTING -p tcp -d 192.168.102.37 --dport 422 -j DNAT --to 192.168.102.37:22
é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦å…è®¸è¿æ¥åˆ°422ç«¯å£çš„è¯·æ±‚
iptables -A INPUT -i eth0 -p tcp --dport 422 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 422 -m state --state ESTABLISHED -j ACCEPT
 
 
25. è®°å½•ä¸¢å¼ƒçš„æ•°æ®è¡¨ ç¬¬ä¸€æ­¥ï¼šæ–°å»ºåä¸ºLOGGINGçš„é“¾
iptables -N LOGGING
ç¬¬äºŒæ­¥ï¼šå°†æ‰€æœ‰æ¥è‡ªINPUTé“¾ä¸­çš„æ•°æ®åŒ…è·³è½¬åˆ°LOGGINGé“¾ä¸­
iptables -A INPUT -j LOGGING
ç¬¬ä¸‰æ­¥ï¼šä¸ºè¿™äº›åŒ…è‡ªå®šä¹‰ä¸ªå‰ç¼€ï¼Œå‘½åä¸ºâ€IPTables Packet Droppedâ€
iptables -A LOGGING -m limit --limit 2/min -j LOG --log-prefix &quot;IPTables Packet Dropped: &quot; --log-level 7
ç¬¬å››æ­¥ï¼šä¸¢å¼ƒè¿™äº›æ•°æ®åŒ…
iptables -A LOGGING -j DROP
 
 
26. ipæ˜ å°„(NAT)
å‡è®¾æœ‰ä¸€å®¶ISPæä¾›å›­åŒºInternetæ¥å…¥æœåŠ¡ï¼Œä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œè¯¥ISPåˆ†é…ç»™å›­åŒºç”¨æˆ·çš„IPåœ°å€éƒ½æ˜¯ä¼ªIPï¼Œä½†æ˜¯éƒ¨åˆ†ç”¨æˆ·è¦æ±‚å»ºç«‹è‡ªå·±çš„WWWæœåŠ¡å™¨å¯¹å¤–å‘å¸ƒä¿¡æ¯ã€‚
æˆ‘ä»¬å¯ä»¥å†é˜²ç«å¢™çš„å¤–éƒ¨ç½‘å¡ä¸Šç»‘å®šå¤šä¸ªåˆæ³•IPåœ°å€ï¼Œç„¶åé€šè¿‡ipæ˜ å°„ä½¿å‘ç»™å…¶ä¸­æŸä¸€ ä¸ªIPåœ°å€çš„åŒ…è½¬å‘è‡³å†…éƒ¨æŸä¸€ç”¨æˆ·çš„WWWæœåŠ¡å™¨ä¸Šï¼Œç„¶åå†å°†è¯¥å†…éƒ¨WWWæœåŠ¡å™¨å“åº”åŒ…ä¼ªè£…æˆè¯¥åˆæ³•IPå‘å‡ºçš„åŒ…ã€‚
 
æˆ‘ä»¬å‡è®¾ä»¥ä¸‹æƒ…æ™¯:
è¯¥ISPåˆ†é…ç»™Aå•ä½wwwæœåŠ¡å™¨çš„ipä¸º:
ä¼ªip:192.168.1.100
çœŸå®ip:202.110.123.100
è¯¥ISPåˆ†é…ç»™Bå•ä½wwwæœåŠ¡å™¨çš„ipä¸º:
ä¼ªip:192.168.1.200
çœŸå®ip:202.110.123.200
linuxé˜²ç«å¢™çš„ipåœ°å€åˆ†åˆ«ä¸º:
å†…ç½‘æ¥å£eth1:192.168.1.1
å¤–ç½‘æ¥å£eth0:202.110.123.1
ç„¶åæˆ‘ä»¬å°†åˆ†é…ç»™Aã€Bå•ä½çš„çœŸå®ipç»‘å®šåˆ°é˜²ç«å¢™çš„å¤–ç½‘æ¥å£ï¼Œä»¥rootæƒé™æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:
ifconfig eth0 add 202.110.123.100 netmask 255.255.255.0
ifconfig eth0 add 202.110.123.200 netmask 255.255.255.0
 
é¦–å…ˆï¼Œå¯¹é˜²ç«å¢™æ¥æ”¶åˆ°çš„ç›®çš„ipä¸º202.110.123.100å’Œ202.110.123.200çš„æ‰€æœ‰æ•°æ®åŒ…è¿›è¡Œç›®çš„NAT(DNAT):
iptables -A PREROUTING -i eth0 -d 202.110.123.100 -j DNAT --to 192.168.1.100
iptables -A PREROUTING -i eth0 -d 202.110.123.200 -j DNAT --to 192.168.1.200
 
å…¶æ¬¡ï¼Œå¯¹é˜²ç«å¢™æ¥æ”¶åˆ°çš„æºipåœ°å€ä¸º192.168.1.100å’Œ192.168.1.200çš„æ•°æ®åŒ…è¿›è¡ŒæºNAT(SNAT):
iptables -A POSTROUTING -o eth0 -s 192.168.1.100 -j SNAT --to 202.110.123.100
iptables -A POSTROUTING -o eth0 -s 192.168.1.200 -j SNAT --to 202.110.123.200
 
è¿™æ ·ï¼Œæ‰€æœ‰ç›®çš„ipä¸º202.110.123.100å’Œ202.110.123.200çš„æ•°æ®åŒ…éƒ½å°†åˆ†åˆ«è¢«è½¬å‘ç»™192.168.1.100å’Œ192.168.1.200;è€Œæ‰€æœ‰æ¥è‡ª192.168.1.100å’Œ192.168.1.200çš„æ•°æ®åŒ…éƒ½å°†åˆ† åˆ«è¢«ä¼ªè£…æˆç”±202.110.123.100å’Œ202.110.123.200ï¼Œä»è€Œä¹Ÿå°±å®ç°äº†ipæ˜ å°„ã€‚
</code></pre>
<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2>
<p>https://www.cnblogs.com/zejin2008/p/5919550.html<br>
https://blog.csdn.net/skc361/article/details/20481521<br>
https://www.cnblogs.com/zhujingzhi/p/9706664.html</p>
]]></content>
    </entry>
</feed>
<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://p.guipulp.top/</id>
    <title>PeterPan</title>
    <updated>2019-08-02T06:27:21.801Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://p.guipulp.top/"/>
    <link rel="self" href="https://p.guipulp.top//atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://p.guipulp.top//images/avatar.png</logo>
    <icon>https://p.guipulp.top//favicon.ico</icon>
    <rights>All rights reserved 2019, PeterPan</rights>
    <entry>
        <title type="html"><![CDATA[kubernetesä½¿ç”¨PodPresetç‰¹æ€§é¢„è®¾æ•´ä¸ªé›†ç¾¤]]></title>
        <id>https://p.guipulp.top//post/t-I_dB2CB</id>
        <link href="https://p.guipulp.top//post/t-I_dB2CB">
        </link>
        <updated>2019-06-24T07:25:54.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ ¹æ®æƒ…å†µ,é¢„å…ˆé…ç½®é›†ç¾¤é‡Œé¢çš„å®¹å™¨çš„æŸäº›å±æ€§,åˆ™å¯ä»¥é€šè¿‡podpreseté…ç½®å®ç°.</p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ ¹æ®æƒ…å†µ,é¢„å…ˆé…ç½®é›†ç¾¤é‡Œé¢çš„å®¹å™¨çš„æŸäº›å±æ€§,åˆ™å¯ä»¥é€šè¿‡podpreseté…ç½®å®ç°.</p>
<!-- more -->
<h3 id="é…ç½®apiserver">é…ç½®apiserver</h3>
<blockquote>
<p>é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å®Œæˆå¯¹ç‰¹å®špodçš„éƒ¨åˆ†å±æ€§é¢„è®¾</p>
</blockquote>
<pre><code># å¼€å¯settings.k8s.io/v1alpha1api
- --runtime-config=settings.k8s.io/v1alpha1=true
# å¼€å¯adminssion controller
- --enable-admission-plugins=PodPreset
# å¯é…ç½®é€‰é¡¹ Initializers,NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,MutatingAdmissionWebhook,Validating
</code></pre>
<h3 id="é…ç½®æµ‹è¯•yaml">é…ç½®æµ‹è¯•yaml</h3>
<pre><code>root@ubuntu4:~/podpreset# cat preset-time.yaml
kind: PodPreset
apiVersion: settings.k8s.io/v1alpha1
metadata:
  name: timezone
spec:
  selector:
    matchLabels:
      app: nginx
  volumeMounts:
    - name: host-time
      mountPath: /etc/localtime
  volumes:
    - name: host-time
      hostPath:
        path: /etc/localtime

</code></pre>
<pre><code>root@ubuntu4:~/podpreset# kubectl  create deploy nginx --image nginx -o yaml --dry-run
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: nginx
  name: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx
        name: nginx
        resources: {}
status: {}

</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetesé…ç½®å¤–ç½‘dns]]></title>
        <id>https://p.guipulp.top//post/9yPSD7pfq</id>
        <link href="https://p.guipulp.top//post/9yPSD7pfq">
        </link>
        <updated>2019-06-21T02:36:34.000Z</updated>
        <summary type="html"><![CDATA[<p>é€šè¿‡æ›´æ–°coredns configmapï¼Œè®¾ç½®upstreamå­—æ®µå®ç°æŒ‡å®šä¸Šæ¸¸è§£ææœåŠ¡å™¨</p>
]]></summary>
        <content type="html"><![CDATA[<p>é€šè¿‡æ›´æ–°coredns configmapï¼Œè®¾ç½®upstreamå­—æ®µå®ç°æŒ‡å®šä¸Šæ¸¸è§£ææœåŠ¡å™¨</p>
<!-- more -->
<h1 id="ç¼–è¾‘coredns-configmap">ç¼–è¾‘coredns configmap</h1>
<pre><code>[root@k8s-node1 ~]# cat setdns.yaml 
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
  labels:
      addonmanager.kubernetes.io/mode: EnsureExists
data:
  Corefile: |
    .:53 {
        errors
        health
        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            upstream 114.114.114.114
            fallthrough in-addr.arpa ip6.arpa
        }
        prometheus :9153
        proxy . /etc/resolv.conf
        cache 30
        reload
    }
</code></pre>
<h1 id="åº”ç”¨config-map">åº”ç”¨config map</h1>
<pre><code> kubectl apply -f setdns.yaml
</code></pre>
<h1 id="æ£€æŸ¥å¤–ç½‘dnsè§£æ">æ£€æŸ¥å¤–ç½‘dnsè§£æ</h1>
<pre><code>
[root@k8s-node1 ~]# kubectl run -it --rm --restart=Never --image=infoblox/dnstools:latest dnstools
If you don't see a command prompt, try pressing enter.
dnstools# host www.baidu.com
www.baidu.com is an alias for www.a.shifen.com.
www.a.shifen.com has address 220.181.111.188
www.a.shifen.com has address 220.181.112.244

</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubeadmæ­å»ºv1.10.3kubernetesé›†ç¾¤]]></title>
        <id>https://p.guipulp.top//post/jZoeyPf8e</id>
        <link href="https://p.guipulp.top//post/jZoeyPf8e">
        </link>
        <updated>2019-06-21T02:33:01.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ¬æ–‡ä½¿ç”¨kubeadmå’Œå®¹å™¨åŒ–etcdå®‰è£…kubernetesé›†ç¾¤ç”¨äºpoc</p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä½¿ç”¨kubeadmå’Œå®¹å™¨åŒ–etcdå®‰è£…kubernetesé›†ç¾¤ç”¨äºpoc</p>
<!-- more -->
<blockquote>
<p>lab è¯´æ˜ï¼š<br>
1.æ­¤labæ‰‹å†Œä¸éœ€è¦è¶Šè¿‡é•¿åŸ<br>
2.100.64.16.176 ä¸ºmasteråœ°å€ï¼Œé…ç½®æ—¶å€™éœ€è¦æ›¿æ¢è¯¥åœ°å€ä¸ºæ–°ç¯å¢ƒçš„masteråœ°å€<br>
3.labç¯å¢ƒä¸ºå•èŠ‚ç‚¹masterç¯å¢ƒ<br>
4.labç¯å¢ƒetcdè®¿é—®æ–¹å¼ä¸ºhttpæ–¹å¼</p>
</blockquote>
<table>
<thead>
<tr>
<th>clusterinfo</th>
<th>ip</th>
<th>package</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s-node1(master)</td>
<td>100.64.16.176</td>
<td>kubeadm, etcd, kubelet, kubectl, docker</td>
</tr>
<tr>
<td>k8s-node2(node)</td>
<td>100.64.16.177</td>
<td>kubeadm, kubelet, kubectl, docker</td>
</tr>
<tr>
<td>k8s-node3(node)</td>
<td>100.64.16.178</td>
<td>kubeadm, kubelet, kubectl, docker</td>
</tr>
</tbody>
</table>
<h3 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡</h3>
<h4 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h4>
<p>è¯¥éƒ¨åˆ†å†…å®¹éœ€è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ</p>
<h4 id="å…³é—­é˜²ç«å¢™">å…³é—­é˜²ç«å¢™</h4>
<pre><code>systemctl stop firewalld &amp;&amp; systemctl disable firewalld
</code></pre>
<h4 id="å…³é—­äº¤æ¢">å…³é—­äº¤æ¢</h4>
<pre><code>swapoff -a
</code></pre>
<h4 id="è®¾ç½®ç³»ç»Ÿè·¯ç”±å‚æ•°">è®¾ç½®ç³»ç»Ÿè·¯ç”±å‚æ•°</h4>
<p>ç³»ç»Ÿè·¯ç”±å‚æ•°,é˜²æ­¢kubeadmæŠ¥è·¯ç”±è­¦å‘Š</p>
<pre><code>cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
vm.swappiness=0
EOF
sysctl --system
</code></pre>
<h4 id="å…³é—­selinux">å…³é—­selinux</h4>
<pre><code>sed -i 's/SELINUX=permissive/SELINUX=disabled/' /etc/sysconfig/selinux
setenforce 0
</code></pre>
<h4 id="å®‰è£…docker">å®‰è£…docker</h4>
<ol>
<li>å®‰è£…</li>
</ol>
<pre><code>yum install -y docker
systemctl enable docker
systemctl start docker
</code></pre>
<ol start="2">
<li>é…ç½®docker daemon(ä¸éœ€è¦åŠ é€Ÿå™¨å¯çœç•¥)</li>
</ol>
<pre><code>vim /etc/docker/daemon.json 
{
  &quot;registry-mirrors&quot;: [&quot;https://v5d7kh0f.mirror.aliyuncs.com&quot;]
}
</code></pre>
<ol start="3">
<li>ä¿®æ”¹dockerå¯åŠ¨æ–‡ä»¶</li>
</ol>
<pre><code>vim /usr/lib/systemd/system/docker.service
# æ·»åŠ ä¸‹é¢è¡Œ
ExecStartPost=/sbin/iptables -P FORWARD ACCEPT
</code></pre>
<ol start="4">
<li>é‡æ–°åŠ è½½dockeræœåŠ¡</li>
</ol>
<pre><code>systemctl daemon-reload
service docker restart
</code></pre>
<h3 id="å®‰è£…k8s">å®‰è£…k8s</h3>
<h4 id="è½¯ä»¶åŒ…å‡†å¤‡">è½¯ä»¶åŒ…å‡†å¤‡</h4>
<p><strong>æ³¨æ„ï¼šè¯¥éƒ¨åˆ†å†…å®¹æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ</strong></p>
<ol>
<li>ä¸Šä¼ è½¯ä»¶åŒ…åˆ°æ‰€æœ‰èŠ‚ç‚¹</li>
</ol>
<p><a href="https://pan.baidu.com/s/1LPDoy5QHan77QKj8s8nz1w">è½¯ä»¶åŒ…ä¸‹è½½åœ°å€</a></p>
<blockquote>
<p>è‹¥æç¤ºèµ„æºä¸å­˜åœ¨ï¼Œè¯·å¤åˆ¶æµè§ˆå™¨é‡Œçš„åœ°å€ï¼Œé‡æ–°è®¿é—®ã€‚</p>
</blockquote>
<pre><code># æ‰€æœ‰èŠ‚ç‚¹è§£å‹å¹¶å®‰è£…è½¯ä»¶åŒ…
tar xf k8s-*.tgz &amp;&amp; cd k8s-* &amp;&amp; yum localinstall -y *.rpm
</code></pre>
<ol start="2">
<li>é…ç½®æ‰€æœ‰èŠ‚ç‚¹çš„kubelet</li>
</ol>
<pre><code># ä¿®æ”¹/etc/systemd/system/kubelet.service.d/10-kubeadm.conf
# æ·»åŠ å¦‚ä¸‹é…ç½® 
Environment=&quot;KUBELET_EXTRA_ARGS=--pod-infra-container-image=registry.cn-shanghai.aliyuncs.com/gcr-k8s/pause-amd64:3.0&quot;
</code></pre>
<ol start="3">
<li>æ‰€æœ‰èŠ‚ç‚¹é‡æ–°è½½å…¥é…ç½®</li>
</ol>
<pre><code>systemctl daemon-reload
systemctl enable kubelet
</code></pre>
<h4 id="masterå®‰è£…">masterå®‰è£…</h4>
<h5 id="å®‰è£…etcd">å®‰è£…etcd</h5>
<ol>
<li>é…ç½®å¯åŠ¨etcd</li>
</ol>
<pre><code>docker stop etcd &amp;&amp; docker rm etcd
rm -rf /data/etcd
mkdir -p /data/etcd
docker run -d \
--restart always \
-v /etc/etcd/ssl/certs:/etc/ssl/certs \
-v /data/etcd:/var/lib/etcd \
-p 2380:2380 \
-p 2379:2379 \
--name etcd \
registry.cn-hangzhou.aliyuncs.com/google_containers/etcd-amd64:3.1.12 \
etcd --name=etcd0 \
--advertise-client-urls=http://100.64.16.176:2379 \
--listen-client-urls=http://0.0.0.0:2379 \
--initial-advertise-peer-urls=http://100.64.16.176:2380 \
--listen-peer-urls=http://0.0.0.0:2380 \
--initial-cluster-token=9477af68bbee1b9ae037d6fd9e7efefd \
--initial-cluster=etcd0=http://100.64.16.176:2380 \
--initial-cluster-state=new \
--auto-tls \
--peer-auto-tls \
--data-dir=/var/lib/etcd
</code></pre>
<ol start="2">
<li>éªŒè¯etcd</li>
</ol>
<pre><code>docker exec -ti etcd ash
etcdctl member list
etcdctl cluster-health
exit
</code></pre>
<h5 id="ç”Ÿæˆkubeadminæ–‡ä»¶">ç”Ÿæˆkubeadminæ–‡ä»¶</h5>
<pre><code># ç”Ÿæˆtoken
# ä¿ç•™tokenåé¢è¿˜è¦ä½¿ç”¨
token=$(kubeadm token generate)
echo $token

# ç”Ÿæˆé…ç½®æ–‡ä»¶
# advertiseAddress é…ç½®ä¸ºmasteråœ°å€
cat &gt;kubeadm-master.config&lt;&lt;EOF
apiVersion: kubeadm.k8s.io/v1alpha1
kind: MasterConfiguration
kubernetesVersion: v1.10.3
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers

api:
  advertiseAddress: 100.64.16.176

apiServerExtraArgs:
  endpoint-reconciler-type: lease

controllerManagerExtraArgs:
  node-monitor-grace-period: 10s
  pod-eviction-timeout: 10s

networking:
  podSubnet: 10.244.0.0/16

etcd:
  endpoints:
  - &quot;http://100.64.16.176:2379&quot;

apiServerCertSANs:
- &quot;node1&quot;
- &quot;100.64.16.176&quot;
- &quot;127.0.0.1&quot;

token: $token
tokenTTL: &quot;0&quot;

featureGates:
  CoreDNS: true
EOF
</code></pre>
<h5 id="åˆå§‹åŒ–masterèŠ‚ç‚¹">åˆå§‹åŒ–masterèŠ‚ç‚¹</h5>
<pre><code>kubeadm init --config kubeadm-master.config
systemctl enable kubelet
</code></pre>
<h5 id="é…ç½®kubectl">é…ç½®kubectl</h5>
<pre><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<h5 id="å®‰è£…ç½‘ç»œæ’ä»¶">å®‰è£…ç½‘ç»œæ’ä»¶</h5>
<ol>
<li>ä¸‹è½½é…ç½®</li>
</ol>
<pre><code>mkdir flannel &amp;&amp; cd flannel
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre>
<ol start="2">
<li>ä¿®æ”¹é…ç½®</li>
</ol>
<pre><code># æ­¤å¤„çš„ipé…ç½®è¦ä¸ä¸Šé¢kubeadmçš„pod-networkä¸€è‡´
  net-conf.json: |
    {
      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,
      &quot;Backend&quot;: {
        &quot;Type&quot;: &quot;vxlan&quot;
      }
    }

# ä¿®æ”¹é•œåƒ
image: registry.cn-shanghai.aliyuncs.com/gcr-k8s/flannel:v0.10.0-amd64
</code></pre>
<ol start="3">
<li>å¯åŠ¨</li>
</ol>
<pre><code>kubectl apply -f kube-flannel.yml
</code></pre>
<ol start="4">
<li>æ£€æŸ¥master</li>
</ol>
<pre><code>kubectl get pods -n kube-system
kubectl get svc -n kube-system
</code></pre>
<h4 id="nodeèŠ‚ç‚¹å®‰è£…">nodeèŠ‚ç‚¹å®‰è£…</h4>
<ol>
<li>é…ç½®node kubeletå¼€æœºå¯åŠ¨</li>
</ol>
<pre><code>systemctl enable kubelet
systemctl start kubelet
</code></pre>
<ol start="2">
<li>åˆå§‹åŒ–node</li>
</ol>
<pre><code># è¿™ä¸ªå‘½ä»¤æ˜¯ä¹‹å‰åˆå§‹åŒ–masterå®Œæˆæ—¶ï¼Œè¾“å‡ºçš„å‘½ä»¤
kubeadm join 100.64.16.176:6443 --token i2ha18.euygiv9g922b5fkf --discovery-token-ca-cert-hash sha256:1c8fe595a95e2daed035ba89f9604ef6ad5fb0d589b89adbff80ea8c09db567e
</code></pre>
<ol start="3">
<li>åœ¨masterä¸Šæ£€æŸ¥é›†ç¾¤çŠ¶æ€</li>
</ol>
<pre><code>kubectl get nodes
</code></pre>
<h3 id="k8sé›†ç¾¤æ£€æŸ¥">k8sé›†ç¾¤æ£€æŸ¥</h3>
<pre><code>kubectl run nginx --replicas=2 --labels=&quot;run=load-balancer-example&quot; --image=nginx  --port=80
kubectl get pods --all-namespaces -o wide 
</code></pre>
<p><a href="https://asciinema.org/a/bnyI5J6IcupDM5SV2eglMtJKu"><img src="https://asciinema.org/a/bnyI5J6IcupDM5SV2eglMtJKu.png" alt="asciicast"></a></p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ç»è¿‡è¿™ç¯‡åšå®¢, æˆ‘ä»¬æˆåŠŸéƒ¨ç½²äº†ä¸€ä¸ª3ä¸ªèŠ‚ç‚¹çš„kubernetes 1.10.3çš„é›†ç¾¤, ä½†æ˜¯æ­¤æ—¶é›†ç¾¤DashBoard, ç›‘æ§éƒ½è¿˜æ²¡å®Œæˆ, åœ¨æ¥ä¸‹æ¥çš„<a href="https://p.fengjingblog.top/2018/06/11/kubernetes-Addons%E5%AE%89%E8%A3%85/">kubernetes Addonså®‰è£…</a>ä¸­å°†è¿›è¡Œè¿™äº›ç»„ä»¶çš„éƒ¨ç½²ã€‚</p>
<h3 id="æ’é”™">æ’é”™</h3>
<p>å¦‚æœå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š</p>
<pre><code>Jun 14 12:33:30 k8s-node1 kubelet: E0614 12:33:30.265135   12998 summary.go:102] Failed to get system container stats for &quot;/system.slice/kubelet.service&quot;: failed to get cgroup stats for &quot;/system.slice/kubelet.service&quot;: failed to get container info for &quot;/system.slice/kubelet.service&quot;: unknown container &quot;/system.slice/kubelet.service&quot;
Jun 14 12:33:30 k8s-node1 etcd: rejected connection from &quot;100.64.16.176:54174&quot; (error &quot;EOF&quot;, ServerName &quot;&quot;)
</code></pre>
<ul>
<li>é’ˆå¯¹etcdçš„æŠ¥é”™å¯ä»¥å°è¯•é™ä½etcdçš„ç‰ˆæœ¬ï¼Œæœ¬äººä½¿ç”¨<code>https://github.com/coreos/etcd/releases/download/v3.1.15/etcd-v3.1.15-linux-amd64.tar.gz</code>è¯¥ç‰ˆæœ¬çš„etcdåè§£å†³ã€‚</li>
<li>é’ˆå¯¹kubeletçš„é”™è¯¯å¯ä»¥åœ¨<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> æ–‡ä»¶æœ€åä¸€è¡Œæœ«å°¾è¿½åŠ <code>--runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice</code>,å®Œæ•´æ–‡æ¡£å¦‚ä¸‹ï¼š</li>
</ul>
<pre><code>[Service]
Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;
Environment=&quot;KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests --allow-privileged=true&quot;
Environment=&quot;KUBELET_NETWORK_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;
Environment=&quot;KUBELET_DNS_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local&quot;
Environment=&quot;KUBELET_AUTHZ_ARGS=--authorization-mode=Webhook --client-ca-file=/etc/kubernetes/pki/ca.crt&quot;
Environment=&quot;KUBELET_CADVISOR_ARGS=--cadvisor-port=0&quot;
Environment=&quot;KUBELET_CGROUP_ARGS=--cgroup-driver=systemd&quot;
Environment=&quot;KUBELET_CERTIFICATE_ARGS=--rotate-certificates=true --cert-dir=/var/lib/kubelet/pki&quot;
Environment=&quot;KUBELET_EXTRA_ARGS=--pod-infra-container-image=registry.cn-shanghai.aliyuncs.com/gcr-k8s/pause-amd64:3.0&quot;
ExecStart=
ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_SYSTEM_PODS_ARGS $KUBELET_NETWORK_ARGS $KUBELET_DNS_ARGS $KUBELET_AUTHZ_ARGS $KUBELET_CADVISOR_ARGS $KUBELET_CGROUP_ARGS $KUBELET_CERTIFICATE_ARGS $KUBELET_EXTRA_ARGS --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Centos 7 install nfs]]></title>
        <id>https://p.guipulp.top//post/vo3IdA9w1</id>
        <link href="https://p.guipulp.top//post/vo3IdA9w1">
        </link>
        <updated>2019-06-21T02:32:06.000Z</updated>
        <summary type="html"><![CDATA[<p>ä½¿ç”¨centos7 å®‰è£…NFSç”¨äºç¯å¢ƒPOC</p>
]]></summary>
        <content type="html"><![CDATA[<p>ä½¿ç”¨centos7 å®‰è£…NFSç”¨äºç¯å¢ƒPOC</p>
<!-- more -->
<h1 id="å®‰è£…nfså’Œrpcbind">å®‰è£…nfså’Œrpcbind</h1>
<p><strong>labç¯å¢ƒä»…é€‚ç”¨äºæµ‹è¯•</strong><br>
<strong>labç¯å¢ƒéœ€è¦å…³é—­é˜²ç«å¢™</strong></p>
<pre><code>yum -y install nfs-utils ,rpcbind
</code></pre>
<h1 id="å¯åŠ¨nfså’Œrpcbind">å¯åŠ¨nfså’Œrpcbind</h1>
<pre><code># nfséœ€è¦å‘rpcæ³¨å†Œï¼Œrpcä¸€æ—¦é‡å¯ï¼Œæ³¨å†Œçš„æ–‡ä»¶éƒ½ä¸¢å¤±ï¼Œå‘ä»–æ³¨å†Œçš„æœåŠ¡éƒ½éœ€è¦é‡å¯ï¼Œæ³¨æ„å¯åŠ¨é¡ºåº
systemctl start rpcbind.service &amp;&amp; systemctl start nfs.service
systemctl enable  rpcbind.service &amp;&amp; systemctl enable nfs.service
</code></pre>
<h1 id="é…ç½®nfs">é…ç½®nfs</h1>
<blockquote>
<p>é…ç½®æ–‡ä»¶/etc/exports</p>
</blockquote>
<pre><code>/nfsdata  *(rw,sync,no_root_squash)
systemctl restart rpcbind.service &amp;&amp; systemctl restart nfs.service
</code></pre>
<ul>
<li>nfsdata ä¸ºå­˜æ”¾æ•°æ®çš„ç›®å½•,éœ€è¦å…ˆåˆ›å»º</li>
<li>'*':ä»»ä½•äºº</li>
<li>rw:è¯»å†™æƒé™</li>
<li>sync:èµ„æ–™ä¼šå…ˆæš‚å­˜äºå†…å­˜ä¸­ï¼Œè€Œéç›´æ¥å†™å…¥ç¡¬ç›˜ã€‚</li>
<li>no_root_squash:å½“ç™»å½•NFSä¸»æœºä½¿ç”¨å…±äº«ç›®å½•çš„ä½¿ç”¨è€…æ˜¯rootæ—¶ï¼Œå…¶æƒé™å°†è¢«è½¬æ¢æˆä¸ºåŒ¿åä½¿ç”¨è€…ï¼Œé€šå¸¸å®ƒçš„UIDä¸GIDéƒ½ä¼šå˜æˆnobodyèº«ä»½ã€‚</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å…¨æ‰‹åŠ¨ç”ŸæˆæœåŠ¡è¯ä¹¦]]></title>
        <id>https://p.guipulp.top//post/vdXFKNARf</id>
        <link href="https://p.guipulp.top//post/vdXFKNARf">
        </link>
        <updated>2019-06-21T02:26:40.000Z</updated>
        <summary type="html"><![CDATA[<p>ä½¿ç”¨cfsslç”ŸæˆæœåŠ¡è¯ä¹¦,ç”¨äºkubernetesæ­å»ºå’Œetcdé›†ç¾¤æ­å»º</p>
]]></summary>
        <content type="html"><![CDATA[<p>ä½¿ç”¨cfsslç”ŸæˆæœåŠ¡è¯ä¹¦,ç”¨äºkubernetesæ­å»ºå’Œetcdé›†ç¾¤æ­å»º</p>
<!-- more -->
<h1 id="è¯ä¹¦ç”Ÿæˆæ­¥éª¤">è¯ä¹¦ç”Ÿæˆæ­¥éª¤</h1>
<p>ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>å®‰è£…è¯ä¹¦å·¥å…·</li>
<li>åˆ›å»ºç­¾åè¯·æ±‚æ–‡ä»¶</li>
<li>ç”Ÿæˆç›¸åº”çš„caè¯ä¹¦å’Œå¯¹åº”æœåŠ¡è¯ä¹¦</li>
</ul>
<blockquote>
<p>ä¸‹é¢ä»¥ä¸ºharboræœåŠ¡ä¸ºä¾‹ï¼Œç”ŸæˆharboræœåŠ¡è¯ä¹¦</p>
</blockquote>
<h1 id="å®‰è£…è¯ä¹¦å·¥å…·">å®‰è£…è¯ä¹¦å·¥å…·</h1>
<pre><code>wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
chmod +x cfssl_linux-amd64
mv cfssl_linux-amd64 /usr/local/bin/cfssl

wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
chmod +x cfssljson_linux-amd64
mv cfssljson_linux-amd64 /usr/local/bin/cfssljson

wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
chmod +x cfssl-certinfo_linux-amd64
mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo

</code></pre>
<h1 id="åˆ›å»ºç­¾åè¯·æ±‚æ–‡ä»¶">åˆ›å»ºç­¾åè¯·æ±‚æ–‡ä»¶</h1>
<ol>
<li>ç”Ÿæˆcaé…ç½®æ–‡ä»¶</li>
</ol>
<pre><code>mkdir /root/ssl &amp;&amp; cd /root/ssl

cat &gt; ca-config.json &lt;&lt;EOF
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;87600h&quot;
    },
    &quot;profiles&quot;: {
      &quot;harbor&quot;: {
        &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ],
        &quot;expiry&quot;: &quot;87600h&quot;
      }
    }
  }
}
EOF
</code></pre>
<ul>
<li>å¯ä»¥å®šä¹‰å¤šä¸ªprofilesï¼Œç”Ÿæˆè¯ä¹¦æ—¶å€™è‡ªåŠ¨åº”ç”¨å®šä¹‰çš„profileså±æ€§</li>
<li>signing è¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼›ç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUE</li>
<li>server auth è¡¨ç¤ºclientå¯ä»¥ç”¨è¯¥ CA å¯¹serveræä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯</li>
<li>client auth è¡¨ç¤ºserverå¯ä»¥ç”¨è¯¥CAå¯¹clientæä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯</li>
</ul>
<ol start="2">
<li>ç”Ÿæˆcaç­¾åè¯·æ±‚æ–‡ä»¶</li>
</ol>
<pre><code>cat &gt; ca-csr.json &lt;&lt;EOF
{
  &quot;CN&quot;: &quot;harbor&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ],
    &quot;ca&quot;: {
       &quot;expiry&quot;: &quot;87600h&quot;
    }
}
EOF
</code></pre>
<ul>
<li>å¯æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ›´æ”¹å¯¹åº”çš„å€¼</li>
</ul>
<ol start="3">
<li>ç”ŸæˆæœåŠ¡ç­¾åè¯·æ±‚æ–‡ä»¶</li>
</ol>
<blockquote>
<p>åˆ›å»ºæœåŠ¡ç­¾åæ–‡ä»¶ servicename-csr.json</p>
</blockquote>
<pre><code>cat &gt; harbor-csr.json &lt;&lt;EOF
{
    &quot;CN&quot;: &quot;harbor&quot;,
    &quot;hosts&quot;: [
      &quot;127.0.0.1&quot;,
      &quot;100.64.16.179&quot;
    ],
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;ST&quot;: &quot;BeiJing&quot;,
            &quot;L&quot;: &quot;BeiJing&quot;,
            &quot;O&quot;: &quot;k8s&quot;,
            &quot;OU&quot;: &quot;System&quot;
        }
    ]
}
EOF
</code></pre>
<ul>
<li>æ›¿æ¢å’Œå¢åŠ hostså­—æ®µä¸ºè‡ªå·±æœåŠ¡çš„ipåœ°å€æˆ–è€…åŸŸå</li>
<li>æ›¿æ¢CNç­‰å­—æ®µä¸ºè‡ªå·±çš„æœåŠ¡å</li>
</ul>
<h1 id="ç”Ÿæˆcaå’Œharborè¯ä¹¦">ç”Ÿæˆcaå’Œharborè¯ä¹¦</h1>
<pre><code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=harbor harbor-csr.json | cfssljson -bare harbor
</code></pre>
<ul>
<li>æ›¿æ¢profileä¸ºè‡ªå·±åœ¨ca-config.jsonå®šä¹‰çš„profiles</li>
<li>æ›¿æ¢harbor-csr.jsonä¸ºè‡ªå·±åˆ›å»ºçš„service-csr.json</li>
<li>æ›¿æ¢harborä¸ºè‡ªå·±çš„æœåŠ¡å</li>
</ul>
<h1 id="å¯¼å…¥è¯ä¹¦åˆ°å®¢æˆ·ç«¯">å¯¼å…¥è¯ä¹¦åˆ°å®¢æˆ·ç«¯</h1>
<blockquote>
<p>æ‹·è´ca.pemè¯ä¹¦åˆ°å®¢æˆ·ç«¯èŠ‚ç‚¹ï¼ŒåŒºåˆ†ç¯å¢ƒæ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
</blockquote>
<ol>
<li>Red Hat (CentOS etc)</li>
</ol>
<pre><code>cat ca.pem &gt;&gt; ca.crt 
cp ca.crt /etc/pki/ca-trust/source/anchors/ca.crt
update-ca-trust

</code></pre>
<ol start="2">
<li>Ubuntu</li>
</ol>
<pre><code>cat ca.pem &gt;&gt; ca.crt 
cp ca.crt  /usr/local/share/ca-certificates/ca.crt 
update-ca-certificates
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetes é«˜å¯ç”¨é›†ç¾¤ç‰ˆå®‰è£…]]></title>
        <id>https://p.guipulp.top//post/kubernetes-gao-ke-yong-ji-qun-ban-an-zhuang</id>
        <link href="https://p.guipulp.top//post/kubernetes-gao-ke-yong-ji-qun-ban-an-zhuang">
        </link>
        <updated>2019-06-21T01:44:15.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ¬æ‰‹å†Œé€‚ç”¨äºå®‰è£…kubernetes1.14.xç‰ˆæœ¬<br>
éœ€è¦å¯¹centoså’Œkubernetesæœ‰ä¸€å®šäº†è§£<br>
å½“ç„¶å¦‚æœä½ ä»€ä¹ˆéƒ½ä¸æ‡‚ä¹Ÿå¯ä»¥æŒ‰ç…§æ‰‹å†Œå®Œæˆå®‰è£…<br>
æœ¬æ–‡ä½¿ç”¨kubeadmå®‰è£…,è¿½æ±‚äºŒè¿›åˆ¶å®‰è£…çš„è¯·å‡ºé—¨å³è½¬æ‰“è½¦</p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ¬æ‰‹å†Œé€‚ç”¨äºå®‰è£…kubernetes1.14.xç‰ˆæœ¬<br>
éœ€è¦å¯¹centoså’Œkubernetesæœ‰ä¸€å®šäº†è§£<br>
å½“ç„¶å¦‚æœä½ ä»€ä¹ˆéƒ½ä¸æ‡‚ä¹Ÿå¯ä»¥æŒ‰ç…§æ‰‹å†Œå®Œæˆå®‰è£…<br>
æœ¬æ–‡ä½¿ç”¨kubeadmå®‰è£…,è¿½æ±‚äºŒè¿›åˆ¶å®‰è£…çš„è¯·å‡ºé—¨å³è½¬æ‰“è½¦</p>
<!-- more -->
<h1 id="å‰ç½®æ¡ä»¶">å‰ç½®æ¡ä»¶</h1>
<ul>
<li>ç³»ç»Ÿè¦æ±‚:64ä½centos7.6</li>
<li>å…³é—­é˜²ç«å¢™å’Œselinux</li>
<li>å…³é—­æ“ä½œç³»ç»Ÿswapåˆ†åŒº(ä½¿ç”¨k8sä¸æ¨èæ‰“å¼€)</li>
<li>è¯·é¢„é…ç½®å¥½æ¯ä¸ªèŠ‚ç‚¹çš„hostnameä¿è¯ä¸é‡åå³å¯</li>
<li>è¯·é…ç½®ç¬¬ä¸€ä¸ªmasterèƒ½ç§˜é’¥å…å¯†ç™»å…¥æ‰€æœ‰èŠ‚ç‚¹(åŒ…æ‹¬è‡ªèº«)</li>
</ul>
<h1 id="ç¯å¢ƒè¯´æ˜">ç¯å¢ƒè¯´æ˜</h1>
<p>æœ¬æ‰‹å†Œå®‰è£…æ–¹å¼é€‚ç”¨äºå°è§„æ¨¡ä½¿ç”¨</p>
<p>å¤šä¸»æ¨¡å¼(æœ€å°‘ä¸‰ä¸ª), æ¯ä¸ªmasterèŠ‚ç‚¹ä¸Šéœ€è¦å®‰è£…keepalived</p>
<h1 id="å‡†å¤‡å·¥ä½œæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ">å‡†å¤‡å·¥ä½œ(æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ)</h1>
<h2 id="dockerå’Œkubernetesè½¯ä»¶æºé…ç½®">Dockerå’Œkubernetesè½¯ä»¶æºé…ç½®</h2>
<pre><code># åˆ‡æ¢åˆ°é…ç½®ç›®å½•
cd /etc/yum.repos.d/
# é…ç½®docker-ceé˜¿é‡Œæº
wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# é…ç½®kubernetesé˜¿é‡Œæº
cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
</code></pre>
<h2 id="é…ç½®å†…æ ¸ç›¸å…³å‚æ•°">é…ç½®å†…æ ¸ç›¸å…³å‚æ•°</h2>
<pre><code>cat &lt;&lt;EOF &gt;  /etc/sysctl.d/ceph.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
</code></pre>
<h2 id="å®‰è£…ç›¸åº”è½¯ä»¶åŒ…">å®‰è£…ç›¸åº”è½¯ä»¶åŒ…</h2>
<pre><code># å®‰è£…kubeadm kubelet kubectl
yum install docker-ce kubeadm kubectl kubelet -y

# å¼€æœºå¯åŠ¨kubeletå’Œdocker
systemctl enable docker kubelet

# å¯åŠ¨docker
systemctl start docker
</code></pre>
<h1 id="éƒ¨ç½²">éƒ¨ç½²</h1>
<h2 id="å®‰è£…keepalivedåœ¨æ‰€æœ‰masterä¸Šæ‰§è¡Œ">å®‰è£…keepalived(åœ¨æ‰€æœ‰masterä¸Šæ‰§è¡Œ)</h2>
<pre><code># æ­¤å¤„å¦‚æœæœ‰Lbå¯çœç•¥ ç›´æ¥ä½¿ç”¨LBåœ°å€
# å®‰è£…æ—¶å€™è¯·å…ˆåœ¨åˆå§‹åŒ–masterä¸Šæ‰§è¡Œ,ä¿è¯VIPé™„ç€åœ¨åˆå§‹åŒ–masterä¸Š,å¦åˆ™è¯·å…³é—­å…¶ä»–keepalived

# å®‰è£…å®Œæˆåå¯æ ¹æ®è‡ªå·±ä¸šåŠ¡éœ€è¦å®ç°å¥åº·ç›‘æµ‹
yum install keepalived -y

# å¤‡ä»½keepalivedåŸå§‹æ–‡ä»¶
mv /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak

# ç”Ÿæˆæ–°çš„keepalivedé…ç½®æ–‡ä»¶,æ–‡ä¸­æ³¨é‡Šéƒ¨åˆ†å¯¹æ¯å°masterè¯·è¿›è¡Œä¿®æ”¹
cat &lt;&lt;EOF &gt; /etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id k8s-master1                      #ä¸»è°ƒåº¦å™¨çš„ä¸»æœºå
   vrrp_mcast_group4 224.26.1.1         

}

vrrp_instance VI_1 {
    state BACKUP                          
    interface eth0
    virtual_router_id 66              
    nopreempt                             
    priority 90                         
    advert_int 1
    authentication {
        auth_type PASS                     
        auth_pass 123456                 
    }
    virtual_ipaddress {
        10.20.1.8                            #VIPåœ°å€å£°æ˜
    }
}
EOF

# é…ç½®keepalivedå¼€æœºå¯åŠ¨å’Œå¯åŠ¨keepalived
systemctl enable keepalived
systemctl start keepalived

</code></pre>
<h2 id="ç”Ÿæˆkubeadm-master-é…ç½®æ–‡ä»¶">ç”Ÿæˆkubeadm master é…ç½®æ–‡ä»¶</h2>
<pre><code>cd &amp;&amp; cat &lt;&lt;EOF &gt; kubeadm.yaml
apiVersion: kubeadm.k8s.io/v1beta1
kind: ClusterConfiguration
kubernetesVersion: stable
apiServer:
  certSANs:
  - &quot;172.29.2.188&quot;  #è¯·æ±‚æ”¹ä¸ºä½ çš„vipåœ°å€
controlPlaneEndpoint: &quot;172.29.2.188:6443&quot;  #è¯·æ±‚æ”¹ä¸ºä½ çš„vipåœ°å€
imageRepository: registry.cn-hangzhou.aliyuncs.com/peter1009
networking:
  dnsDomain: cluster.local
  podSubnet: &quot;10.244.0.0/16&quot;
  serviceSubnet: 10.96.0.0/12
EOF
</code></pre>
<h2 id="åˆå§‹åŒ–ç¬¬ä¸€ä¸ªmaster">åˆå§‹åŒ–ç¬¬ä¸€ä¸ªmaster</h2>
<pre><code># ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„kubeadm.yaml
kubeadm init --config kubeadm.yaml
</code></pre>
<pre><code># æ‰§è¡Œå®Œä¸Šä¸€æ­¥è¾“å‡ºå¦‚ä¸‹
root@k8s4:~# kubeadm  init --config kubeadm.yaml
I0522 06:20:13.352644    2622 version.go:96] could not fetch a Kubernetes version from 
......... æ­¤å¤„çœç•¥
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of control-plane nodes by copying certificate authorities
and service account keys on each node and then running the following as root:

  kubeadm join 172.16.10.114:6443 --token v2lv3k.aysjlmg3ylcl3498 \
    --discovery-token-ca-cert-hash sha256:87b69e590e9d59055c5a9c6651e333044c402dba877beb29906eddfeb0998d72 \
    --experimental-control-plane

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 172.16.10.114:6443 --token v2lv3k.aysjlmg3ylcl3498 \
    --discovery-token-ca-cert-hash sha256:87b69e590e9d59055c5a9c6651e333044c402dba877beb29906eddfeb0998d72

</code></pre>
<h2 id="å®‰è£…é›†ç¾¤">å®‰è£…é›†ç¾¤</h2>
<pre><code>cat &lt;&lt;EOF &gt; copy.sh
CONTROL_PLANE_IPS=&quot;172.16.10.101 172.16.10.102&quot;  # ä¿®æ”¹è¿™ä¸¤ä¸ªipåœ°å€ä¸ºä½ ç¬¬äºŒ/ç¬¬ä¸‰masteripåœ°å€
for host in ${CONTROL_PLANE_IPS}; do
    ssh $host mkdir -p /etc/kubernetes/pki/etcd
    scp /etc/kubernetes/pki/ca.crt &quot;${USER}&quot;@$host:/etc/kubernetes/pki/
    scp /etc/kubernetes/pki/ca.key &quot;${USER}&quot;@$host:/etc/kubernetes/pki/
    scp /etc/kubernetes/pki/sa.key &quot;${USER}&quot;@$host:/etc/kubernetes/pki/
    scp /etc/kubernetes/pki/sa.pub &quot;${USER}&quot;@$host:/etc/kubernetes/pki/
    scp /etc/kubernetes/pki/front-proxy-ca.crt &quot;${USER}&quot;@$host:/etc/kubernetes/pki/
    scp /etc/kubernetes/pki/front-proxy-ca.key &quot;${USER}&quot;@$host:/etc/kubernetes/pki/
    scp /etc/kubernetes/pki/etcd/ca.crt &quot;${USER}&quot;@$host:/etc/kubernetes/pki/etcd/ca.crt
    scp /etc/kubernetes/pki/etcd/ca.key &quot;${USER}&quot;@$host:/etc/kubernetes/pki/etcd/ca.key
    scp /etc/kubernetes/admin.conf &quot;${USER}&quot;@$host:/etc/kubernetes/
done
EOF

# å¦‚æœæœªé…ç½®å…å¯†ç™»å½•,è¯¥æ­¥éª¤è®²å¤±è´¥
bash -x copy.sh
</code></pre>
<pre><code># åœ¨å½“å‰èŠ‚ç‚¹æ‰§è¡Œinitè¾“å‡ºç¬¬ä¸€éƒ¨åˆ†å†…å®¹,ä½¿kubectlèƒ½è®¿é—®é›†ç¾¤
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

# åœ¨å…¶ä»–masterèŠ‚ç‚¹ä¸Šé…ç½®æ‰§è¡Œinitè¾“å‡ºç¬¬äºŒéƒ¨åˆ†å†…å®¹(å¿…é¡»è¦copy.shæ–‡ä»¶æ‰§è¡ŒæˆåŠŸä»¥å)
kubeadm join 172.16.10.114:6443 --token v2lv3k.aysjlmg3ylcl3498 \
    --discovery-token-ca-cert-hash sha256:87b69e590e9d59055c5a9c6651e333044c402dba877beb29906eddfeb0998d72 \
    --experimental-control-plane
</code></pre>
<pre><code># åœ¨å…¶ä»–émasterçš„èŠ‚ç‚¹ä¸Šé…ç½®æ‰§è¡Œinitè¾“å‡ºç¬¬ä¸‰éƒ¨åˆ†å†…å®¹
kubeadm join 172.16.10.114:6443 --token v2lv3k.aysjlmg3ylcl3498 \
    --discovery-token-ca-cert-hash sha256:87b69e590e9d59055c5a9c6651e333044c402dba877beb29906eddfeb0998d72
</code></pre>
<h2 id="å®‰è£…flannel">å®‰è£…flannel</h2>
<pre><code>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre>
<h2 id="æ£€æŸ¥æ˜¯å¦å®‰è£…å®Œæˆ">æ£€æŸ¥æ˜¯å¦å®‰è£…å®Œæˆ</h2>
<pre><code>root@k8s4:~# kubectl  get nodes
NAME   STATUS   ROLES    AGE   VERSION
k8s4   Ready    master   20m   v1.14.2
root@k8s4:~# kubectl  get nodes
NAME   STATUS   ROLES    AGE   VERSION
k8s4   Ready    master   20m   v1.14.2
root@k8s4:~# kubectl  get pods --all-namespaces
NAMESPACE     NAME                           READY   STATUS    RESTARTS   AGE
kube-system   coredns-8cc96f57d-cfr4j        1/1     Running   0          20m
kube-system   coredns-8cc96f57d-stcz6        1/1     Running   0          20m
kube-system   etcd-k8s4                      1/1     Running   0          19m
kube-system   kube-apiserver-k8s4            1/1     Running   0          19m
kube-system   kube-controller-manager-k8s4   1/1     Running   0          19m
kube-system   kube-flannel-ds-amd64-k4q6q    1/1     Running   0          50s
kube-system   kube-proxy-lhjsf               1/1     Running   0          20m
kube-system   kube-scheduler-k8s4            1/1     Running   0          19m
</code></pre>
<h2 id="æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨é›†ç¾¤">æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨é›†ç¾¤</h2>
<pre><code># å–æ¶ˆèŠ‚ç‚¹æ±¡ç‚¹,ä½¿masterèƒ½è¢«æ­£å¸¸è°ƒåº¦, k8s4è¯·æ›´æ”¹ä¸ºä½ è‡ªæœ‰é›†ç¾¤çš„nodename
kubectl  taint node k8s4 node-role.kubernetes.io/master:NoSchedule-

# åˆ›å»ºnginx deploy
root@k8s4:~# kubectl  create deploy nginx --image nginx
deployment.apps/nginx created

root@k8s4:~# kubectl  get pods
NAME                     READY   STATUS    RESTARTS   AGE
nginx-65f88748fd-9sk6z   1/1     Running   0          2m44s

# æš´éœ²nginxåˆ°é›†ç¾¤å¤–
root@k8s4:~# kubectl  expose deploy nginx --port=80 --type=NodePort
service/nginx exposed
root@k8s4:~# kubectl  get svc
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP        25m
nginx        NodePort    10.104.109.234   &lt;none&gt;        80:32129/TCP   5s
root@k8s4:~# curl 127.0.0.1:32129
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[é€šè¿‡configmapæ§åˆ¶kubelet]]></title>
        <id>https://p.guipulp.top//post/tong-guo-configmap-kong-zhi-kubelet</id>
        <link href="https://p.guipulp.top//post/tong-guo-configmap-kong-zhi-kubelet">
        </link>
        <updated>2019-06-20T09:12:04.000Z</updated>
        <summary type="html"><![CDATA[<p>åœ¨ Kubernetes 1.8 ç‰ˆæœ¬ä¸Šï¼Œé™¤äº†å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ä¿å­˜åœ¨ç¡¬ç›˜çš„é…ç½®æ–‡ä»¶è®¾ç½® Kubelet çš„é…ç½®å­é›†ã€‚ å°†æ¥ï¼Œå¤§éƒ¨åˆ†ç°å­˜çš„å‘½ä»¤è¡Œå‚æ•°éƒ½å°†è¢«åºŸå¼ƒï¼Œå–è€Œä»£ä¹‹ä»¥é…ç½®æ–‡ä»¶çš„æ–¹å¼æä¾›å‚æ•°ï¼Œä»¥ç®€åŒ–èŠ‚ç‚¹éƒ¨ç½²è¿‡ç¨‹ã€‚å¦å¤–åŠ¨æ€é…ç½®kubeletåœ¨1.11å·²è¿›å…¥betaç‰ˆæœ¬</p>
]]></summary>
        <content type="html"><![CDATA[<p>åœ¨ Kubernetes 1.8 ç‰ˆæœ¬ä¸Šï¼Œé™¤äº†å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ä¿å­˜åœ¨ç¡¬ç›˜çš„é…ç½®æ–‡ä»¶è®¾ç½® Kubelet çš„é…ç½®å­é›†ã€‚ å°†æ¥ï¼Œå¤§éƒ¨åˆ†ç°å­˜çš„å‘½ä»¤è¡Œå‚æ•°éƒ½å°†è¢«åºŸå¼ƒï¼Œå–è€Œä»£ä¹‹ä»¥é…ç½®æ–‡ä»¶çš„æ–¹å¼æä¾›å‚æ•°ï¼Œä»¥ç®€åŒ–èŠ‚ç‚¹éƒ¨ç½²è¿‡ç¨‹ã€‚å¦å¤–åŠ¨æ€é…ç½®kubeletåœ¨1.11å·²è¿›å…¥betaç‰ˆæœ¬</p>
<!-- more -->
<h2 id="æ“ä½œ">æ“ä½œ</h2>
<h3 id="é…ç½®kubelet">é…ç½®kubelet</h3>
<pre><code># æŒ‡å®škubelet ä¿å­˜åŠ¨æ€é…ç½®æ–‡ä»¶å†…å®¹çš„ç›®å½•
--dynamic-config-dir='path/to/kubelet/dynamic-config'
</code></pre>
<h3 id="ç”Ÿæˆkubelet-configmap">ç”Ÿæˆkubelet  configmap</h3>
<pre><code># ç”Ÿæˆæ–‡ä»¶
kubectl proxy --port=8001 &amp;

# ç”ŸæˆèŠ‚ç‚¹åŸºå‡†æ–‡ä»¶,æ›¿æ¢NODE_NAMEå˜é‡
NODE_NAME=&quot;the-name-of-the-node-you-are-reconfiguring&quot;; curl -sSL &quot;http://localhost:8001/api/v1/nodes/${NODE_NAME}/proxy/configz&quot; | jq '.kubeletconfig|.kind=&quot;KubeletConfiguration&quot;|.apiVersion=&quot;kubelet.config.k8s.io/v1beta1&quot;' &gt; kubelet_configz_${NODE_NAME}

# ç¼–è¾‘æ–‡ä»¶æŒ‡å®šå…·ä½“å‚æ•°,å¦‚ä¿®æ”¹å¿½ç•¥swapé”™è¯¯
&quot;failSwapOn&quot;: false,

# ç”Ÿæˆkubelet çš„configmap
kubectl -n kube-system create configmap my-node-config --from-file=kubelet=kubelet_configz_${NODE_NAME} --append-hash -o yaml
</code></pre>
<h3 id="åº”ç”¨configmapåˆ°node">åº”ç”¨configmapåˆ°node</h3>
<pre><code># æ–¹æ³•ä¸€:ä½¿ç”¨patchæ–¹å¼,æ›¿æ¢CONFIG_MAP_NAMEä¸ºconfigmap name
kubectl patch node ${NODE_NAME} -p &quot;{\&quot;spec\&quot;:{\&quot;configSource\&quot;:{\&quot;configMap\&quot;:{\&quot;name\&quot;:\&quot;${CONFIG_MAP_NAME}\&quot;,\&quot;namespace\&quot;:\&quot;kube-system\&quot;,\&quot;kubeletConfigKey\&quot;:\&quot;kubelet\&quot;}}}}&quot;

# æ–¹æ³•äºŒ:ç¼–è¾‘èŠ‚ç‚¹specéƒ¨åˆ†é…ç½®å¹¶æŒ‡å®šcm
kubectl edit node ${NODE_NAME}
configSource:
    configMap:
        name: CONFIG_MAP_NAME
        namespace: kube-system
        kubeletConfigKey: kubelet
</code></pre>
<h3 id="æ£€æŸ¥é…ç½®æ˜¯å¦æˆåŠŸ">æ£€æŸ¥é…ç½®æ˜¯å¦æˆåŠŸ</h3>
<ul>
<li>The <code>active</code> configuration is the version the Kubelet is currently running with.</li>
<li>The <code>assigned</code> configuration is the latest version the Kubelet has resolved based on <code>Node.Spec.ConfigSource</code>.</li>
<li>The <code>lastKnownGood</code> configuration is the version the Kubelet will fall back to if an invalid config is assigned in <code>Node.Spec.ConfigSource</code>.</li>
</ul>
<pre><code># æ–¹æ³•ä¸€
kubectl get no ${NODE_NAME} -o json | jq '.status.config'

# æ–¹æ³•äºŒ æŸ¥çœ‹Node.Status.Configéƒ¨åˆ†çŠ¶æ€
kubectl get node ${NODE_NAME} -o yaml 
</code></pre>
<h2 id="é”™è¯¯ä¿¡æ¯è¯´æ˜">é”™è¯¯ä¿¡æ¯è¯´æ˜</h2>
<table>
<thead>
<tr>
<th style="text-align:left">Error Message</th>
<th style="text-align:left">Possible Causes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">failed to load config, see Kubelet log for details</td>
<td style="text-align:left">The Kubelet likely could not parse the downloaded config payload, or encountered a filesystem error attempting to load the payload from disk.</td>
</tr>
<tr>
<td style="text-align:left">failed to validate config, see Kubelet log for details</td>
<td style="text-align:left">The configuration in the payload, combined with any command-line flag overrides, and the sum of feature gates from flags, the config file, and the remote payload, was determined to be invalid by the Kubelet.</td>
</tr>
<tr>
<td style="text-align:left">invalid NodeConfigSource, exactly one subfield must be non-nil, but all were nil</td>
<td style="text-align:left">Since Node.Spec.ConfigSource is validated by the API server to contain at least one non-nil subfield, this likely means that the Kubelet is older than the API server and does not recognize a newer source type.</td>
</tr>
<tr>
<td style="text-align:left">failed to sync: failed to download config, see Kubelet log for details</td>
<td style="text-align:left">The Kubelet could not download the config. It is possible that Node.Spec.ConfigSource could not be resolved to a concrete API object, or that network errors disrupted the download attempt. The Kubelet will retry the download when in this error state.</td>
</tr>
<tr>
<td style="text-align:left">failed to sync: internal failure, see Kubelet log for details</td>
<td style="text-align:left">The Kubelet encountered some internal problem and failed to update its config as a result. Examples include filesystem errors and reading objects from the internal informer cache.</td>
</tr>
<tr>
<td style="text-align:left">internal failure, see Kubelet log for details</td>
<td style="text-align:left">The Kubelet encountered some internal problem while manipulating config, outside of the configuration sync loop.</td>
</tr>
</tbody>
</table>
<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2>
<p><a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/kubelet-config-file/">https://kubernetes.io/zh/docs/tasks/administer-cluster/kubelet-config-file/</a></p>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/">https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello Gridea]]></title>
        <id>https://p.guipulp.top//post/hello-gridea</id>
        <link href="https://p.guipulp.top//post/hello-gridea">
        </link>
        <updated>2018-12-11T16:00:00.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
<!-- more -->
<p><a href="https://github.com/getgridea/gridea">Github</a><br>
<a href="http://hvenotes.fehey.com/">Gridea ä¸»é¡µ</a><br>
<a href="http://fehey.com/">ç¤ºä¾‹ç½‘ç«™</a></p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§ğŸ‘‡</h2>
<p>ğŸ“  ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ <strong>Markdown</strong> è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ</p>
<p>ğŸŒ‰  ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡</p>
<p>ğŸ·ï¸  ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„</p>
<p>ğŸ“‹  ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå•</p>
<p>ğŸ’»  ä½ å¯ä»¥åœ¨ <strong>ğ–¶ğ—‚ğ—‡ğ–½ğ—ˆğ—ğ—Œ</strong> æˆ– <strong>ğ–¬ğ–ºğ–¼ğ–®ğ–²</strong> è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯</p>
<p>ğŸŒ  ä½ å¯ä»¥ä½¿ç”¨ <strong>ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ</strong> æˆ– <strong>Coding Pages</strong> å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å°</p>
<p>ğŸ’¬  ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ <a href="https://github.com/gitalk/gitalk">Gitalk</a> æˆ– <a href="https://github.com/SukkaW/DisqusJS">DisqusJS</a> è¯„è®ºç³»ç»Ÿ</p>
<p>ğŸ‡¬ğŸ‡§  ä½ å¯ä»¥ä½¿ç”¨<strong>ä¸­æ–‡ç®€ä½“</strong>æˆ–<strong>è‹±è¯­</strong></p>
<p>ğŸŒ  ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ›</p>
<p>ğŸ–¥  ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥</p>
<p>ğŸŒ± å½“ç„¶ <strong>Gridea</strong> è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ğŸƒ</p>
<p>æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´</p>
<p>å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼</p>
<p>ğŸ˜˜ Enjoy~</p>
]]></content>
    </entry>
</feed>
<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://p.guipulp.top/</id>
    <title>PeterPan</title>
    <updated>2019-09-02T07:55:46.542Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://p.guipulp.top/"/>
    <link rel="self" href="https://p.guipulp.top//atom.xml"/>
    <subtitle>è´µæœ‰æ’ï¼Œä½•å¿…ä¸‰æ›´èµ·äº”æ›´ç¡ï¼›æœ€æ— ç›Šï¼Œåªæ€•ä¸€æ—¥æš´åå¯’ã€‚</subtitle>
    <logo>https://p.guipulp.top//images/avatar.png</logo>
    <icon>https://p.guipulp.top//favicon.ico</icon>
    <rights>All rights reserved 2019, PeterPan</rights>
    <entry>
        <title type="html"><![CDATA[linux cgroupsç®€ä»‹]]></title>
        <id>https://p.guipulp.top//post/2019090202</id>
        <link href="https://p.guipulp.top//post/2019090202">
        </link>
        <updated>2019-09-02T07:54:27.000Z</updated>
        <content type="html"><![CDATA[<p>https://blog.csdn.net/ahilll/article/details/82109008<br>
https://blog.csdn.net/chenleiking/article/details/87988851</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetes æ¸…ç†å­¤å„¿POD]]></title>
        <id>https://p.guipulp.top//post/2019090201</id>
        <link href="https://p.guipulp.top//post/2019090201">
        </link>
        <updated>2019-09-02T07:53:25.000Z</updated>
        <content type="html"><![CDATA[<h3 id="å­¤å„¿podçš„äº§ç”Ÿ">å­¤å„¿podçš„äº§ç”Ÿ</h3>
<p>èŠ‚ç‚¹OOMä»¥åæˆ–è€…èŠ‚ç‚¹å¼‚å¸¸å´©æºƒçš„æƒ…å†µä¸‹ï¼Œpodæœªèƒ½è¢«æ­£å¸¸çš„æ¸…ç†è€Œå¯¼è‡´çš„å­¤å„¿è¿›ç¨‹ã€‚</p>
<p><strong>æç¤ºå¦‚ä¸‹</strong></p>
<pre><code>Orphaned pod found - but volume paths are still present on disk
</code></pre>
<p><strong>è¿›å…¥k8sçš„podç›®å½•</strong></p>
<pre><code>cd /var/lib/kubelet/pods/
</code></pre>
<h3 id="è§£å†³é—®é¢˜">è§£å†³é—®é¢˜</h3>
<p>è¿‡æ»¤æ—¥å¿—ä¸­çš„å­¤å„¿podï¼Œåˆ é™¤podã€‚</p>
<pre><code class="language-js">#!/bin/bash
num=$(grep &quot;errors similar to this. Turn up verbosity to see them.&quot;  /var/log/messages |tail -1 | awk '{print $12}' |sed 's/&quot;//g')
echo $num

while [ $num ]
do
   [ -d &quot;/var/lib/kubelet/pods/${num}&quot; ] &amp;&amp; rm -rf /var/lib/kubelet/pods/${num}

  sleep 2s
  num=$(grep &quot;errors similar to this. Turn up verbosity to see them.&quot;  /var/log/messages |tail -1 | awk '{print $12}' |sed 's/&quot;//g')
  [ -d &quot;/var/lib/kubelet/pods/${num}&quot; ] || num=

  echo &quot;$num remaining&quot;

done
</code></pre>
<p>ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æœ‰ä¸€å®šçš„<code>å±é™©æ€§</code>ï¼Œè¿˜ä¸ç¡®è®¤æ˜¯å¦æœ‰<code>æ•°æ®ä¸¢å¤±</code>çš„é£é™©ï¼Œå¦‚æœå¯ä»¥ç¡®è®¤ï¼Œå†æ‰§è¡Œã€‚</p>
<p>å¦‚æœå·²ç»æŒ‚è½½äº†PVCç­‰ç›¸å…³å­˜å‚¨ï¼Œå…ˆæ‰§è¡Œumountå†æ‰§è¡Œåˆ é™¤ã€‚</p>
<p>å†å»æŸ¥çœ‹æ—¥å¿—ï¼Œå°±ä¼šå‘ç°syslogä¸ä¼šå†åˆ·ç±»ä¼¼çš„æ—¥å¿—äº†ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetesèµ„æºé¢„ç•™]]></title>
        <id>https://p.guipulp.top//post/2019083002</id>
        <link href="https://p.guipulp.top//post/2019083002">
        </link>
        <updated>2019-08-30T09:25:37.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>ä¸‹é¢å†…å®¹è¿˜å¤„äºæµ‹è¯•é˜¶æ®µï¼Œç”Ÿäº§ä¸Šæ˜¯å¦èƒ½ä¿è¯é›†ç¾¤ç¨³å®šæš‚æ—¶è¿˜ä¸æ¸…æ¥šã€‚ğŸ˜ğŸ˜</p>
</blockquote>
<h2 id="äº‹æ•…">äº‹æ•…</h2>
<p>ä»Šå¤©æˆ‘ä»¬çš„å¼€å‘ç¯å¢ƒç”±äºjavaåº”ç”¨å†…å­˜æŠ¢å åŸå› å¯¼è‡´k8sé›†ç¾¤workerèŠ‚ç‚¹å…¨éƒ¨å®•æœºï¼Œä¸»è¦åŸå› æ˜¯ç¨‹åºå’Œèµ„æºæ²¡è¿›è¡Œé™åˆ¶è§„åˆ’ï¼Œä¸”kubeletä¹Ÿæ²¡é…ç½®èµ„æºé¢„ç•™ï¼Œé‚£hostä¸Šæ‰€æœ‰èµ„æºéƒ½æ˜¯å¯ä»¥ç»™podè°ƒé…ä½¿ç”¨çš„ï¼Œè¿™æ ·å°±å¼•èµ·é›†ç¾¤é›ªå´©æ•ˆåº”ï¼Œæ¯”å¦‚é›†ç¾¤å†…æœ‰ä¸€å°ä¸Šè·‘çš„podæ²¡åšresource limtå¯¼è‡´å ç”¨èµ„æºè¿‡å¤§å¯¼è‡´å°†å®¿ä¸»æœºå‹æ­»äº†ï¼Œæ­¤æ—¶è¿™ä¸ªèŠ‚ç‚¹åœ¨kuberneteså†…å°±æ˜¯ä¸€ä¸ªno readyçš„çŠ¶æ€äº†ï¼Œkubernetesä¼šå°†è¿™å°hostä¸Šæ‰€æœ‰çš„podåœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šé‡å»ºï¼Œä¹Ÿå°±æ„å‘³ç€é‚£ä¸ªæœ‰é—®é¢˜çš„podé‡æ–°è·‘åœ¨å…¶ä»–æ­£å¸¸çš„èŠ‚ç‚¹ä¸Šï¼Œå°†å¦å¤–æ­£å¸¸çš„èŠ‚ç‚¹å‹è·¨ã€‚å¾ªæ€€ä¸‹å»ç›´åˆ°é›†ç¾¤å†…æ‰€æœ‰ä¸»æœºéƒ½æŒ‚äº†ï¼Œè¿™å°±æ˜¯é›†ç¾¤é›ªå´©æ•ˆåº”ã€‚</p>
<h2 id="è§£å†³åŠæ³•">è§£å†³åŠæ³•</h2>
<p>åœ¨kubernetesä¸­å¯ä»¥é€šè¿‡ç»™kubeleté…ç½®å‚æ•°é¢„ç•™èµ„æºç»™ç³»ç»Ÿè¿›ç¨‹å’Œkubernetesè¿›ç¨‹ä¿è¯å®ƒä»¬ç¨³å®šè¿è¡Œã€‚ç›®å‰èƒ½å®ç°åˆ°cpuã€memoryã€ephemeral-storageå±‚é¢çš„èµ„æºé¢„ç•™ã€‚<br>
é‡ç‚¹æä¸¤ç‚¹<br>
cpuï¼šcpuæ˜¯é…ç½®cpu shareså®é™…ä¸Šå¯¹åº”çš„æ˜¯cpuçš„ä¼˜å…ˆçº§ï¼Œç®€å•æ¥è¯´ï¼Œè¿™ä¸ªåœ¨cpuç¹å¿™æ—¶ï¼Œå®ƒèƒ½æœ‰æ›´é«˜ä¼˜å…ˆçº§è·å–æ›´å¤šcpuèµ„æºã€‚</p>
<p>ephemeral-storageæ˜¯kubernetes1.8å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªèµ„æºé™åˆ¶çš„å¯¹è±¡ï¼Œkubernetes 1.10ç‰ˆæœ¬ä¸­kubeleté»˜è®¤å·²ç»æ‰“å¼€çš„äº†,ä¸»è¦æ˜¯ç”¨äºå¯¹æœ¬åœ°ä¸´æ—¶å­˜å‚¨ä½¿ç”¨ç©ºé—´å¤§å°çš„é™åˆ¶ï¼Œå¦‚å¯¹podçš„empty dirã€/var/lib/kubeletã€æ—¥å¿—ã€å®¹å™¨å¯è¯»å†™å±‚çš„ä½¿ç”¨å¤§å°çš„é™åˆ¶ã€‚</p>
<h2 id="é…ç½®">é…ç½®</h2>
<h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3>
<p>åœ¨è®²é…ç½®ä¹‹å‰æˆ‘ä»¬å…ˆäº†è§£å‡ ä¸ªæ¦‚å¿µï¼š</p>
<p>Node capacityï¼šèŠ‚ç‚¹æ€»å…±çš„èµ„æº<br>
kube-reservedï¼šç»™kubernetesè¿›ç¨‹é¢„ç•™çš„èµ„æº<br>
system-reservedï¼šç»™æ“ä½œç³»ç»Ÿé¢„ç•™çš„èµ„æº<br>
eviction-thresholdï¼škubelet evictionçš„é˜€å€¼<br>
allocatableï¼šç•™ç»™podä½¿ç”¨çš„èµ„æº</p>
<pre><code>node_allocatable=Node_capacity-(kube-reserved+system-reserved+hard-eviction)
</code></pre>
<pre><code>      Node Capacity
---------------------------
|     kube-reserved       |
|-------------------------|
|     system-reserved     |
|-------------------------|
|    eviction-threshold   |
|-------------------------|
|                         |
|      allocatable        |
|   (available for pods)  |
|                         |
|                         |
---------------------------
</code></pre>
<p>Kubernetes èŠ‚ç‚¹ä¸Šçš„ <code>Allocatable</code> è¢«å®šä¹‰ä¸º pod å¯ç”¨è®¡ç®—èµ„æºé‡ã€‚è°ƒåº¦å™¨ä¸ä¼šè¶…é¢ç”³è¯· <code>Allocatable</code>ã€‚ç›®å‰æ”¯æŒ <code>CPU</code>, <code>memory</code> å’Œ <code>storage</code> è¿™å‡ ä¸ªå‚æ•°ã€‚</p>
<p>Node Allocatable æš´éœ²ä¸º API ä¸­ <code>v1.Node</code> å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯ CLI ä¸­ <code>kubectl describe node</code> çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>åœ¨ <code>kubelet</code> ä¸­ï¼Œå¯ä»¥ä¸ºä¸¤ç±»ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹é¢„ç•™èµ„æºã€‚</p>
<h3 id="ä½¿ç”¨kubeletå‚æ•°è¿›è¡Œé™åˆ¶">ä½¿ç”¨kubeletå‚æ•°è¿›è¡Œé™åˆ¶</h3>
<p>æ­¤æ–¹æ³•é€‚ç”¨äºè€ç‰ˆæœ¬çš„kubernetesé›†ç¾¤ï¼Œåœ¨æ–°ç‰ˆæœ¬(1.11ä¹‹å‰)ä¸­å·²ç»ä¸é€‚ç”¨äº†ã€‚</p>
<p>https://k8smeetup.github.io/docs/tasks/administer-cluster/reserve-compute-resources/</p>
<p>https://www.bladewan.com/2018/01/26/k8s_resource_resver/</p>
<h3 id="ä½¿ç”¨kubelet-configè¿›è¡Œé™åˆ¶">ä½¿ç”¨kubelet configè¿›è¡Œé™åˆ¶</h3>
<p>kubelet è¾ƒæ–°çš„ç‰ˆæœ¬éƒ½é‡‡ç”¨kubelet configå¯¹é›†ç¾¤çš„kubeletè¿›è¡Œé…ç½®ï¼Œæ­¤å¤„é‡‡ç”¨é™æ€é…ç½®æ–¹å¼ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨åŠ¨æ€é…ç½®æ–¹å¼ã€‚</p>
<pre><code># ç¼–è¾‘æ–‡æ¡£kubelet config æ–‡ä»¶
vim /var/lib/kubelet/config
</code></pre>
<p><strong>é…ç½®èµ„æºé¢„ç•™</strong></p>
<pre><code># æ‰¾åˆ°enforceNodeAllocatable æ³¨é‡Šæ‰
#enforceNodeAllocatable:
#- pods

# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œç³»ç»Ÿå’Œkubeletå‡é¢„ç•™CPU500må†…å­˜500Miç£ç›˜5G
systemReserved:
  cpu: &quot;500m&quot;
  memory: &quot;500Mi&quot;
  ephemeral-storage: &quot;5Gi&quot;
kubeReserved:
  cpu: &quot;500m&quot;
  memory: &quot;500Mi&quot;
  ephemeral-storage: &quot;5Gi&quot;
systemReservedCgroup: /system.slice
kubeReservedCgroup: /kubelet.service
EnforceNodeAllocatable:
- pods
- kube-reserved
- system-reserved

</code></pre>
<p><strong>é…ç½®è½¯é©±é€ï¼ˆé»˜è®¤ä¸ºç¡¬é©±é€ï¼‰</strong></p>
<p>è½¯é©±é€æœ‰èµ„æºé©±é€ç­‰å¾…æ—¶é—´ï¼Œç¡¬é©±é€ä¸ºç«‹åˆ»é©±é€ã€‚</p>
<pre><code># evictionHard æ³¨é‡Šæ‰ï¼Œå¹¶åœ¨åé¢æ–°å¢ä»¥ä¸‹å†…å®¹

#evictionHard:
EvictionSoft:
  imagefs.available: 15%
  memory.available: 10%
  nodefs.available: 10%
  nodefs.inodesFree: 5%
EvictionSoftGracePeriod:
  memory.available: &quot;5m&quot;
  nodefs.available: &quot;2m&quot;
  nodefs.inodesFree: &quot;2m&quot;
  imagefs.available: &quot;2m&quot;
</code></pre>
<pre><code># å¦‚æœä½ ä½¿ç”¨çš„cgroup driveræ˜¯croupè¿˜éœ€è¦è¿›è¡Œä»¥ä¸‹æ“ä½œ
# cpusetå’Œhugetlb subsystemæ˜¯é»˜è®¤æ²¡æœ‰åˆå§‹åŒ–system.sliceæ‰‹åŠ¨åˆ›å»º,
mkdir -p /sys/fs/cgroup/hugetlb/system.slice/kubelet.service/
mkdir -p /sys/fs/cgroup/cpuset/system.slice/kubelet.service/

# é…ç½®åœ¨kubeletä¸­é¿å…é‡å¯å¤±æ•ˆ
ExecStartPre=/usr/bin/mkdir -p /sys/fs/cgroup/cpuset/system.slice/kubelet.service
ExecStartPre=/usr/bin/mkdir -p /sys/fs/cgroup/hugetlb/system.slice/kubelet.service
</code></pre>
<p><strong>é‡å¯kubelet</strong></p>
<pre><code>service kubelet restart
</code></pre>
<h2 id="éªŒè¯">éªŒè¯</h2>
<pre><code>[root@m3 pki]# kubectl  describe node m1
Name:               m1
Roles:              master
Labels:             beta.kubernetes.io/arch=amd64
....
CreationTimestamp:  Mon, 26 Aug 2019 20:35:35 -0400
...
Addresses:
  InternalIP:  172.27.100.13
  Hostname:    m1
Capacity:
 cpu:                4
 ephemeral-storage:  36678148Ki
 hugepages-1Gi:      0
 hugepages-2Mi:      0
 memory:             8010576Ki
 pods:               110
Allocatable:
 cpu:                3
 ephemeral-storage:  23065162901
 hugepages-1Gi:      0
 hugepages-2Mi:      0
 memory:             6884176Ki
 pods:               110
</code></pre>
<ul>
<li>å¯ä»¥çœ‹åˆ°é¢„ç•™åï¼Œå¯ç”¨CPUä¸º3ï¼Œä¸é¢„ç•™ä¸º4ï¼Œå†…å­˜æ˜¯ä¸€æ ·çš„è®¡ç®—æ–¹å¼ï¼Œæ­¤å¤„é¢„ç•™äº†1Gï¼ˆ500Mi+500Miï¼‰</li>
</ul>
<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2>
<p>https://github.com/rootsongjc/qa/issues/3</p>
<p>https://cloud.tencent.com/developer/article/1097002</p>
<p>https://blog.csdn.net/ahilll/article/details/82109008</p>
<p>http://dockone.io/article/4797</p>
<p>https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/</p>
<p>https://kubernetes.io/zh/docs/tasks/administer-cluster/kubelet-config-file/</p>
<p>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubelet/config/v1beta1/types.go</p>
<p>https://www.bladewan.com/2018/01/26/k8s_resource_resver/</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä¿®æ”¹kubernetesè¯ä¹¦è¿‡æœŸæ—¶é—´çš„éªšæ“ä½œ]]></title>
        <id>https://p.guipulp.top//post/2019083001</id>
        <link href="https://p.guipulp.top//post/2019083001">
        </link>
        <updated>2019-08-30T08:50:14.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>ç®€å•éªŒè¯ï¼ˆéšæœºä¿®æ”¹ç³»ç»Ÿæ—¶é—´ï¼‰æ˜¯æœ‰æ•ˆçš„ï¼ˆ10å¹´å†…ï¼‰ï¼Œå…·ä½“ç”¨èµ·æ¥æ€æ ·ï¼Œè‡ªå·±å»æµ‹è¯•å§ã€‚</p>
</blockquote>
<p>æœ€è¿‘å…¬å¸æ—©æœŸéƒ¨ç½²çš„kubernetesçš„é›†ç¾¤è¯ä¹¦è¿‡æœŸï¼Œç ”ç©¶äº†ä¸‹kubernetesçš„è¯ä¹¦æ—¶é—´ï¼Œå¤§è‡´ä¸Šæ˜¯è¯´ä¿®æ”¹kubeadmçš„æºä»£ç ï¼Œè‡ªå·±ç¼–è¯‘kubeadmï¼Œå®ç°è¯ä¹¦99å¹´ã€‚</p>
<p>kubernetesé»˜è®¤CAè¯ä¹¦10å¹´ï¼Œå¾ˆå°‘æœ‰ä¼ä¸šçš„ä¸€ä¸ªæœåŠ¡èƒ½è·‘10å¹´ä¸æ›´æ¢ï¼Œå› æ­¤æƒ³åˆ°ä»¥ä¸‹æ–¹æ³•è¿›è¡Œäº†ä»¥ä¸‹å®éªŒã€‚æµ‹è¯•æš‚æ—¶æ²¡å‘ç°ä»€ä¹ˆé—®é¢˜ã€‚</p>
<p>å¦‚æœæœ‰å¤šmasterï¼Œéœ€è¦åœ¨æ¯ä¸ªmasterä¸Šè¿›è¡Œä»¥ä¸‹æ“ä½œã€‚</p>
<pre><code>[root@m2 pki]# date -s 8/30/2028
2028å¹´ 08æœˆ 30æ—¥ æ˜ŸæœŸä¸‰ 00:00:00 EDT
[root@m2 pki]# kubectl get pods
Unable to connect to the server: x509: certificate has expired or is not yet valid
[root@m2 pki]# kubectl get pods
Unable to connect to the server: x509: certificate has expired or is not yet valid
[root@m2 pki]# kubeadm alpha certs renew all
certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed
certificate for serving the Kubernetes API renewed
certificate the apiserver uses to access etcd renewed
certificate for the API server to connect to kubelet renewed
certificate embedded in the kubeconfig file for the controller manager to use renewed
certificate for liveness probes to healtcheck etcd renewed
certificate for etcd nodes to communicate with each other renewed
certificate for serving etcd renewed
certificate for the front proxy client renewed
certificate embedded in the kubeconfig file for the scheduler manager to use renewed
[root@m2 pki]# ntpdate 0.cn.pool.ntp.org
30 Aug 04:51:35 ntpdate[9983]: step time server 203.107.6.88 offset -284065763.328437 sec
[root@m2 pki]# cp /etc/kubernetes/admin.conf ~/.kube/config
cpï¼šæ˜¯å¦è¦†ç›–&quot;/root/.kube/config&quot;ï¼Ÿ y
[root@m2 pki]# openssl x509 -in apiserver.crt -noout -text
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 6495439138002669247 (0x5a246f7b50d18ebf)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=kubernetes
        Validity
            Not Before: Aug 27 00:34:59 2019 GMT
            Not After : Aug 30 04:00:30 2029 GMT
        Subject: CN=kube-apiserver
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:d5:c5:1a:60:e3:dd:5c:68:c6:a0:38:df:06:54:
                    7b:87:73:3f:6d:1b:bc:65:4e:8e:1a:e0:a7:13:a9:
                    df:a6:67:65:13:cb:c6:e7:c8:5e:60:3e:14:7d:c4:
                    e0:91:d5:de:8b:91:bd:9c:59:2b:35:87:62:87:c9:
                    97:c4:f6:c6:41:b4:6a:80:25:34:1a:d2:b4:ad:e0:
                    bc:d0:af:18:35:68:b9:46:7b:1e:af:da:24:ce:79:
                    94:75:77:3d:ae:67:ac:b9:08:5a:74:87:fd:c0:33:
                    ec:d9:d5:ba:71:ee:23:9e:39:69:fa:2f:76:3f:e1:
                    80:a4:89:a3:39:40:f9:ef:a6:f5:4c:27:3a:7c:60:
                    aa:83:ce:cf:48:2a:e9:6c:15:88:21:8b:fb:53:f8:
                    05:15:bf:35:10:9d:4e:63:f9:09:ae:9c:45:b2:75:
                    4f:8f:4e:a9:9f:bc:f8:c0:9f:29:bc:5d:a3:8f:a9:
                    c7:d1:ea:85:d4:79:32:e1:e3:b7:2f:08:eb:47:99:
                    af:db:b4:5d:a7:d9:c0:7f:29:63:ec:f4:bb:ba:9b:
                    16:f4:c1:11:28:37:7c:c8:f9:13:7b:38:86:83:ba:
                    f7:e8:dd:fd:05:9e:7c:46:4a:1e:d9:9e:8e:0c:ad:
                    86:09:70:da:40:46:e7:e8:5c:82:26:08:3a:4e:ad:
                    8a:a3
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Extended Key Usage:
                TLS Web Server Authentication
            X509v3 Subject Alternative Name:
                DNS:m2, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:10.96.0.1, IP Address:172.27.100.14, IP Address:172.27.100.211, IP Address:172.29.100.211
    Signature Algorithm: sha256WithRSAEncryption
         ab:31:c7:2a:a2:52:40:e2:b5:c6:a4:fc:d7:f5:35:2c:c9:28:
         8d:ba:6a:1d:c3:06:d0:85:4e:bf:43:0c:27:a2:2f:13:62:97:
         89:cc:4e:0c:17:86:11:ef:21:2a:01:9d:1c:25:f2:48:c5:31:
         95:63:41:2c:57:2a:1c:1f:40:00:2f:1a:b1:90:7b:3d:6a:2b:
         7c:6f:33:9a:c8:09:44:4d:a4:ff:fa:06:de:77:66:e1:0f:59:
         29:bd:76:d1:52:b9:63:81:b4:ae:27:0f:ed:54:93:b1:21:8b:
         bf:4f:16:9e:b2:4d:dd:2f:ac:81:e8:86:38:c8:2d:d9:38:1b:
         ac:56:23:5e:8c:dc:96:ae:24:3f:dd:7f:ce:ba:97:b5:e7:07:
         05:df:f2:fd:ba:51:6d:94:13:c5:2d:a8:75:32:21:ad:e9:07:
         13:04:64:e9:c5:f9:3c:46:39:9a:16:59:3b:ff:91:af:7b:fb:
         14:6d:2e:66:2d:52:0d:1b:45:ba:e4:0c:42:23:1c:2c:ea:53:
         6a:20:88:87:24:b1:55:39:d0:93:7b:44:46:bc:46:16:37:d6:
         ff:e6:2f:dd:05:53:03:bc:d6:ba:32:1c:8a:7c:74:4b:cc:4d:
         3b:20:b6:80:a0:a8:28:a5:da:fb:0b:3a:43:c3:b7:79:86:a8:
         2e:cc:91:48

</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[iptablesçš„å››è¡¨äº”é“¾]]></title>
        <id>https://p.guipulp.top//post/2019082802</id>
        <link href="https://p.guipulp.top//post/2019082802">
        </link>
        <updated>2019-08-28T04:44:56.000Z</updated>
        <content type="html"><![CDATA[<h2 id="netfilterä»‹ç»">netfilterä»‹ç»</h2>
<ul>
<li>å®ƒæ˜¯iptablesçš„ä¸»è¦çš„å·¥ä½œæ¨¡å—ï¼Œä½äºå†…æ ¸ä¸­ï¼Œåœ¨ç½‘ç»œå±‚çš„äº”ä¸ªä½ç½®ï¼ˆä¹Ÿå°±æ˜¯é˜²ç«å¢™å››è¡¨äº”é“¾ä¸­çš„äº”é“¾ï¼‰æ³¨å†Œäº†ä¸€äº›é’©å­å‡½æ•°ï¼Œç”¨æ¥æŠ“å–æ•°æ®åŒ…ï¼›</li>
<li>æŠŠæ•°æ®åŒ…çš„ä¿¡æ¯æ‹¿å‡ºæ¥åŒ¹é…å„ä¸ªé“¾ä½ç½®åœ¨å¯¹åº”è¡¨ä¸­çš„è§„åˆ™ï¼›</li>
<li>åŒ¹é…ä¹‹åï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ACCEPTã€DROPç­‰ç­‰ï¼›</li>
</ul>
<h3 id="netfilterå’Œiptablesçš„å…³ç³»å›¾">netfilterå’Œiptablesçš„å…³ç³»å›¾</h3>
<p><img src="https://img.mubu.com/document_image/e0653c59-e432-40d9-a8bd-38558599a4da-1235096.jpg" alt="img"></p>
<h2 id="å››è¡¨äº”é“¾">å››è¡¨äº”é“¾</h2>
<ul>
<li>é“¾å°±æ˜¯ä½ç½®ï¼šå…±æœ‰äº”ä¸ªï¼Œè¿›è·¯ç”±(PREROUTING)ã€è¿›ç³»ç»Ÿ(INPUT) ã€è½¬å‘(FORWARD)ã€å‡ºç³»ç»Ÿ(OUTPUT)ã€å‡ºè·¯ç”±(POSTROUTING)ï¼›</li>
<li>è¡¨å°±æ˜¯å­˜å‚¨çš„è§„åˆ™ï¼›æ•°æ®åŒ…åˆ°äº†è¯¥é“¾å¤„ï¼Œä¼šå»å¯¹åº”è¡¨ä¸­æŸ¥è¯¢è®¾ç½®çš„è§„åˆ™ï¼Œç„¶åå†³å®šæ˜¯å¦æ”¾è¡Œã€ä¸¢å¼ƒã€è½¬å‘è¿˜æ˜¯ä¿®æ”¹ç­‰ç­‰æ“ä½œã€‚</li>
</ul>
<h3 id="å››è¡¨">å››è¡¨</h3>
<ul>
<li>filterè¡¨â€”â€”è¿‡æ»¤æ•°æ®åŒ…</li>
<li>Natè¡¨â€”â€”ç”¨äºç½‘ç»œåœ°å€è½¬æ¢ï¼ˆIPã€ç«¯å£ï¼‰</li>
<li>Mangleè¡¨â€”â€”ä¿®æ”¹æ•°æ®åŒ…çš„æœåŠ¡ç±»å‹ã€TTLã€å¹¶ä¸”å¯ä»¥é…ç½®è·¯ç”±å®ç°QOS</li>
<li>Rawè¡¨â€”â€”å†³å®šæ•°æ®åŒ…æ˜¯å¦è¢«çŠ¶æ€è·Ÿè¸ªæœºåˆ¶å¤„ç†</li>
</ul>
<h3 id="äº”é“¾">äº”é“¾</h3>
<ul>
<li>INPUTé“¾â€”â€”è¿›æ¥çš„æ•°æ®åŒ…åº”ç”¨æ­¤è§„åˆ™é“¾ä¸­çš„ç­–ç•¥</li>
<li>OUTPUTé“¾â€”â€”å¤–å‡ºçš„æ•°æ®åŒ…åº”ç”¨æ­¤è§„åˆ™é“¾ä¸­çš„ç­–ç•¥</li>
<li>FORWARDé“¾â€”â€”è½¬å‘æ•°æ®åŒ…æ—¶åº”ç”¨æ­¤è§„åˆ™é“¾ä¸­çš„ç­–ç•¥</li>
<li>PREROUTINGé“¾â€”â€”å¯¹æ•°æ®åŒ…ä½œè·¯ç”±é€‰æ‹©å‰åº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™ï¼ˆæ‰€æœ‰çš„æ•°æ®åŒ…è¿›æ¥çš„æ—¶ä¾¯éƒ½å…ˆç”±è¿™ä¸ªé“¾å¤„ç†ï¼‰</li>
<li>POSTROUTINGé“¾â€”â€”å¯¹æ•°æ®åŒ…ä½œè·¯ç”±é€‰æ‹©ååº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™ï¼ˆæ‰€æœ‰çš„æ•°æ®åŒ…å‡ºæ¥çš„æ—¶ä¾¯éƒ½å…ˆç”±è¿™ä¸ªé“¾å¤„ç†ï¼‰</li>
</ul>
<h3 id="é“¾è¡¨å…³ç³»å›¾">é“¾è¡¨å…³ç³»å›¾</h3>
<p><img src="https://img2018.cnblogs.com/blog/1479220/201809/1479220-20180926150504012-1967719887.png" alt="image-20190828125115128"></p>
<h3 id="æ•°æ®å¤„ç†æµç¨‹">æ•°æ®å¤„ç†æµç¨‹</h3>
<p>æˆ‘ä»¬ç»“åˆä¸‹é¢çš„å›¾ä¸¾ä¸ªä¾‹å­ï¼š<br>
å‡å¦‚æœ‰æ•°æ®åŒ…ä»Network INè¦é€šè¿‡iptablesï¼Œæ•°æ®åŒ…æµå‘å¦‚ä¸‹ï¼š<br>
1.Network INæ•°æ®åŒ…åˆ°è¾¾æœåŠ¡å™¨çš„ç½‘ç»œæ¥å£<br>
2.è¿›å…¥rawè¡¨çš„ PREROUTING é“¾ï¼Œè¿™ä¸ªé“¾çš„ä½œç”¨æ˜¯å†³å®šæ•°æ®åŒ…æ˜¯å¦è¢«çŠ¶æ€è·Ÿè¸ªã€‚<br>
è¿›å…¥ mangle è¡¨çš„ PREROUTING é“¾ï¼Œåœ¨æ­¤å¯ä»¥ä¿®æ”¹æ•°æ®åŒ…ï¼Œæ¯”å¦‚ TOS ç­‰ã€‚<br>
è¿›å…¥ nat è¡¨çš„ PREROUTING é“¾ï¼Œå¯ä»¥åœ¨æ­¤åšDNAT(ç›®æ ‡åœ°å€è½¬æ¢)<br>
3.å†³å®šè·¯ç”±ï¼ŒæŸ¥çœ‹ç›®æ ‡åœ°å€æ˜¯äº¤ç»™æœ¬åœ°ä¸»æœºè¿˜æ˜¯è½¬å‘ç»™å…¶å®ƒä¸»æœºã€‚</p>
<p>4.åˆ°è¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æƒ…å†µæ˜¯æ•°æ®åŒ…è¦è½¬å‘ç»™å…¶å®ƒä¸»æœºï¼ˆä¸€èˆ¬æƒ…å†µä¸‹å®ƒæ˜¯åœ¨æ‹…ä»»ç½‘å…³æœåŠ¡å™¨ï¼‰ï¼Œæ•°æ®åŒ…ä¼šä¾æ¬¡ç»è¿‡ï¼š<br>
5.è¿›å…¥ mangle è¡¨çš„ FORWARD é“¾ï¼Œ<br>
è¿›å…¥ filter è¡¨çš„ FORWARD é“¾ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¯¹æ‰€æœ‰è½¬å‘çš„æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤ã€‚<br>
6.è¿›å…¥ mangle è¡¨çš„ POSTROUTING é“¾<br>
è¿›å…¥ nat è¡¨çš„ POSTROUTING é“¾ï¼Œåœ¨è¿™é‡Œä¸€èˆ¬éƒ½æ˜¯ç”¨æ¥åš SNAT ï¼ˆæºåœ°å€è½¬æ¢ï¼‰<br>
7.æ•°æ®åŒ…æµå‡ºç½‘ç»œæ¥å£ï¼Œå‘å¾€network outã€‚</p>
<p>8.å¦ä¸€ç§æƒ…å†µï¼Œæ•°æ®åŒ…çš„ç›®æ ‡åœ°å€å°±æ˜¯å‘ç»™æœ¬åœ°ä¸»æœºçš„ï¼Œå®ƒä¼šä¾æ¬¡ç©¿è¿‡ï¼š<br>
9.è¿›å…¥ mangle è¡¨çš„ INPUT é“¾ï¼Œ<br>
è¿›å…¥ filter è¡¨çš„ INPUT é“¾ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¯¹æµå…¥çš„æ‰€æœ‰æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤ï¼Œ<br>
æ•°æ®åŒ…äº¤ç»™æœ¬åœ°ä¸»æœºçš„åº”ç”¨ç¨‹åºè¿›è¡Œå¤„ç†ã€‚<br>
10.åº”ç”¨ç¨‹åºå¤„ç†å®Œæ¯•åå‘é€çš„æ•°æ®åŒ…è¿›è¡Œè·¯ç”±å‘é€å†³å®šã€‚<br>
11.è¿›å…¥ raw è¡¨çš„ OUTPUT é“¾ã€‚<br>
è¿›å…¥ mangle è¡¨çš„ OUTPUT é“¾ï¼Œ<br>
è¿›å…¥ nat è¡¨çš„ OUTPUT é“¾ï¼Œ<br>
è¿›å…¥ filter è¡¨çš„ OUTPUT é“¾ã€‚<br>
12.è¿›å…¥ mangle è¡¨çš„ POSTROUTING é“¾ï¼Œ<br>
è¿›å…¥ nat è¡¨çš„ POSTROUTING é“¾ã€‚<br>
13.è¿›å…¥å‡ºå»çš„ç½‘ç»œæ¥å£ï¼Œå‘é€å¾€network outã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬è¦è¿‡æ»¤æ§åˆ¶åŒ…çš„è¿›å‡ºï¼Œåªéœ€è¦æŠŠinput chainå’Œforward chainè¿™ä¸¤ä¸ªå…³å£æŠŠæ§ä½å°±å¥½äº†ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦æŠŠinput chainå’Œforward chainé»˜è®¤è®¾ç½®ä¸ºdropçš„åŸå› ã€‚</p>
<ul>
<li>
<p>å›¾ä¸€</p>
<p><img src="https://img.mubu.com/document_image/c1b9ef44-0c8d-4818-a18b-83b527e8d0e4-1235096.jpg" alt="img"></p>
</li>
<li>
<p>å›¾äºŒ</p>
<p><img src="https://img.mubu.com/document_image/bcb89f30-1a57-4967-9a41-3cb6e2c8a5bc-1235096.jpg" alt="img"></p>
</li>
</ul>
<h2 id="iptablesæ“ä½œ">iptablesæ“ä½œ</h2>
<pre><code>iptables [-t è¡¨å] é€‰é¡¹ [é“¾å] [æ¡ä»¶] [-j æ§åˆ¶ç±»å‹]

-P è®¾ç½®é»˜è®¤ç­–ç•¥:iptables
 
-P INPUT (DROP|ACCEPT)
 
-F æ¸…ç©ºè§„åˆ™é“¾
 
-L æŸ¥çœ‹è§„åˆ™é“¾
 
-A åœ¨è§„åˆ™é“¾çš„æœ«å°¾åŠ å…¥æ–°è§„åˆ™
 
-I num åœ¨è§„åˆ™é“¾çš„å¤´éƒ¨åŠ å…¥æ–°è§„åˆ™
 
-D num åˆ é™¤æŸä¸€æ¡è§„åˆ™
 
-s åŒ¹é…æ¥æºåœ°å€IP/MASKï¼ŒåŠ å¹å·&quot;!&quot;è¡¨ç¤ºé™¤è¿™ä¸ªIPå¤–ã€‚
 
-d åŒ¹é…ç›®æ ‡åœ°å€
 
-i ç½‘å¡åç§° åŒ¹é…ä»è¿™å—ç½‘å¡æµå…¥çš„æ•°æ®
 
-o ç½‘å¡åç§° åŒ¹é…ä»è¿™å—ç½‘å¡æµå‡ºçš„æ•°æ®
 
-p åŒ¹é…åè®®,å¦‚tcp,udp,icmp
 
--dport num åŒ¹é…ç›®æ ‡ç«¯å£å·
 
--sport num åŒ¹é…æ¥æºç«¯å£å·
</code></pre>
<h3 id="å¸¸ç”¨iptablesçš„è¯­å¥">å¸¸ç”¨iptablesçš„è¯­å¥</h3>
<pre><code>1. åˆ é™¤å·²æœ‰è§„åˆ™
åœ¨å¼€å§‹åˆ›å»ºiptablesè§„åˆ™ä¹‹å‰ï¼Œä½ ä¹Ÿè®¸éœ€è¦åˆ é™¤å·²æœ‰è§„åˆ™ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š
iptables -F
(or)
iptables â€“flush
æŸ¥çœ‹å·²æœ‰è§„åˆ™
iptables -nL
 
 
2.è®¾ç½®é“¾çš„é»˜è®¤ç­–ç•¥
é“¾çš„é»˜è®¤æ”¿ç­–è®¾ç½®ä¸ºâ€ACCEPTâ€ï¼ˆæ¥å—ï¼‰ï¼Œè‹¥è¦å°†INPUT,FORWARD,OUTPUTé“¾è®¾ç½®æˆâ€DROPâ€ï¼ˆæ‹’ç»ï¼‰ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP
å½“INPUTé“¾å’ŒOUTPUTé“¾éƒ½è®¾ç½®æˆDROPæ—¶ï¼Œå¯¹äºæ¯ä¸€ä¸ªé˜²ç«å¢™è§„åˆ™ï¼Œæˆ‘ä»¬éƒ½åº”è¯¥å®šä¹‰ä¸¤ä¸ªè§„åˆ™ã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªä¼ å…¥å¦ä¸€ä¸ªä¼ å‡ºã€‚åœ¨ä¸‹é¢æ‰€æœ‰çš„ä¾‹å­ä¸­ï¼Œç”±äºæˆ‘ä»¬å·²å°†DROPè®¾ç½®æˆINPUTé“¾å’ŒOUTPUTé“¾çš„é»˜è®¤ç­–ç•¥ï¼Œæ¯ç§æƒ…å†µæˆ‘ä»¬éƒ½å°†åˆ¶å®šä¸¤æ¡è§„åˆ™ã€‚
å½“ç„¶ï¼Œå¦‚æœä½ ç›¸ä¿¡ä½ çš„å†…éƒ¨ç”¨æˆ·,åˆ™å¯ä»¥çœç•¥ä¸Šé¢çš„æœ€åä¸€è¡Œã€‚ä¾‹å¦‚ï¼šé»˜è®¤ä¸ä¸¢å¼ƒæ‰€æœ‰å‡ºç«™çš„æ•°æ®åŒ…ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹,å¯¹äºæ¯ä¸€ä¸ªé˜²ç«å¢™è§„åˆ™è¦æ±‚,ä½ åªéœ€è¦åˆ¶å®šä¸€ä¸ªè§„åˆ™â€”â€”åªå¯¹è¿›ç«™çš„æ•°æ®åŒ…åˆ¶å®šè§„åˆ™ã€‚
 
 
3. é˜»æ­¢æŒ‡å®šIPåœ°å€
ä¾‹ï¼šä¸¢å¼ƒæ¥è‡ªIPåœ°å€x.x.x.xçš„åŒ…
BLOCK_THIS_IP=&quot;x.x.x.x&quot;
iptables -A INPUT -s &quot;$BLOCK_THIS_IP&quot; -j DROP
æ³¨ï¼šå½“ä½ åœ¨logé‡Œå‘ç°æ¥è‡ªæŸipåœ°å€çš„å¼‚å¸¸è®°å½•ï¼Œå¯ä»¥é€šè¿‡æ­¤å‘½ä»¤æš‚æ—¶é˜»æ­¢è¯¥åœ°å€çš„è®¿é—®ä»¥åšæ›´æ·±å…¥åˆ†æ
ä¾‹ï¼šé˜»æ­¢æ¥è‡ªIPåœ°å€x.x.x.x eth0 tcpçš„åŒ…
iptables -A INPUT -i eth0 -s &quot;$BLOCK_THIS_IP&quot; -j DROP
iptables -A INPUT -i eth0 -p tcp -s &quot;$BLOCK_THIS_IP&quot; -j DROP
 
 
4. å…è®¸æ‰€æœ‰SSHçš„è¿æ¥è¯·æ±‚
ä¾‹ï¼šå…è®¸æ‰€æœ‰æ¥è‡ªå¤–éƒ¨çš„SSHè¿æ¥è¯·æ±‚ï¼Œå³åªå…è®¸è¿›å…¥eth0æ¥å£ï¼Œå¹¶ä¸”ç›®æ ‡ç«¯å£ä¸º22çš„æ•°æ®åŒ…
iptables -A INPUT -i eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
 
 
5. ä»…å…è®¸æ¥è‡ªæŒ‡å®šç½‘ç»œçš„SSHè¿æ¥è¯·æ±‚
ä¾‹ï¼šä»…å…è®¸æ¥è‡ªäº192.168.100.0/24åŸŸçš„ç”¨æˆ·çš„sshè¿æ¥è¯·æ±‚
iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
 
 
6.å…è®¸httpå’Œhttpsçš„è¿æ¥è¯·æ±‚
ä¾‹ï¼šå…è®¸æ‰€æœ‰æ¥è‡ªweb - httpçš„è¿æ¥è¯·æ±‚
iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT
ä¾‹ï¼šå…è®¸æ‰€æœ‰æ¥è‡ªweb - httpsçš„è¿æ¥è¯·æ±‚
iptables -A INPUT -i eth0 -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
 
 
7. ä½¿ç”¨multiport å°†å¤šä¸ªè§„åˆ™ç»“åˆåœ¨ä¸€èµ·
å…è®¸å¤šä¸ªç«¯å£ä»å¤–ç•Œè¿å…¥ï¼Œé™¤äº†ä¸ºæ¯ä¸ªç«¯å£éƒ½å†™ä¸€æ¡ç‹¬ç«‹çš„è§„åˆ™å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨multiportå°†å…¶ç»„åˆæˆä¸€æ¡è§„åˆ™ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
ä¾‹ï¼šå…è®¸æ‰€æœ‰ssh,http,httpsçš„æµé‡è®¿é—®
iptables -A INPUT -i eth0 -p tcp -m multiport --dports 22,80,443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp -m multiport --sports 22,80,443 -m state --state ESTABLISHED -j ACCEPT
 
 
8. å…è®¸ä»æœ¬åœ°å‘èµ·çš„SSHè¯·æ±‚
iptables -A OUTPUT -o eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
è¯·æ³¨æ„,è¿™ä¸å…è®¸sshè¿å…¥çš„è§„åˆ™ç•¥æœ‰ä¸åŒã€‚æœ¬ä¾‹åœ¨OUTPUTé“¾ä¸Šï¼Œæˆ‘ä»¬å…è®¸NEWå’ŒESTABLISHEDçŠ¶æ€ã€‚åœ¨INPUTé“¾ä¸Šï¼Œæˆ‘ä»¬åªå…è®¸ESTABLISHEDçŠ¶æ€ã€‚sshè¿å…¥çš„è§„åˆ™ä¸ä¹‹ç›¸åã€‚
 
 
9. ä»…å…è®¸ä»æœ¬åœ°å‘èµ·åˆ°ä¸€ä¸ªæŒ‡å®šçš„ç½‘ç»œåŸŸçš„SSHè¯·æ±‚
ä¾‹ï¼šä»…å…è®¸ä»å†…éƒ¨è¿æ¥åˆ°ç½‘åŸŸ192.168.100.0/24
iptables -A OUTPUT -o eth0 -p tcp -d 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
 
 
10. å…è®¸ä»æœ¬åœ°å‘èµ·çš„HTTPSè¿æ¥è¯·æ±‚
ä¸‹é¢çš„è§„åˆ™å…è®¸è¾“å‡ºå®‰å…¨çš„ç½‘ç»œæµé‡ã€‚å¦‚æœä½ æƒ³å…è®¸ç”¨æˆ·è®¿é—®äº’è”ç½‘ï¼Œè¿™æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚åœ¨æœåŠ¡å™¨ä¸Šï¼Œè¿™äº›è§„åˆ™èƒ½è®©ä½ ä½¿ç”¨wgetä»å¤–éƒ¨ä¸‹è½½ä¸€äº›æ–‡ä»¶
iptables -A OUTPUT -o eth0 -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
æ³¨ï¼šå¯¹äºHTTP webæµé‡çš„å¤–è”è¯·æ±‚ï¼Œåªéœ€è¦å°†ä¸Šè¿°å‘½ä»¤ä¸­çš„ç«¯å£ä»443æ”¹æˆ80å³å¯ã€‚
 
 
11. è´Ÿè½½å¹³è¡¡ä¼ å…¥çš„ç½‘ç»œæµé‡
ä½¿ç”¨iptableså¯ä»¥å®ç°ä¼ å…¥webæµé‡çš„è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥webæµé‡è´Ÿè½½å¹³è¡¡ä½¿ç”¨iptablesé˜²ç«å¢™è§„åˆ™ã€‚
ä¾‹ï¼šä½¿ç”¨iptables nthå°†HTTPSæµé‡è´Ÿè½½å¹³è¡¡è‡³ä¸‰ä¸ªä¸åŒçš„ipåœ°å€ã€‚
iptables -A PREROUTING -i eth0 -p tcp --dport 443 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.101:443
iptables -A PREROUTING -i eth0 -p tcp --dport 443 -m state --state NEW -m nth --counter 0 --every 3 --packet 1 -j DNAT --to-destination 192.168.1.102:443
iptables -A PREROUTING -i eth0 -p tcp --dport 443 -m state --state NEW -m nth --counter 0 --every 3 --packet 2 -j DNAT --to-destination 192.168.1.103:443
 
 
12. å…è®¸å¤–éƒ¨ä¸»æœºpingå†…éƒ¨ä¸»æœº
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT
 
 
13. å…è®¸å†…éƒ¨ä¸»æœºpingå¤–éƒ¨ä¸»æœº
iptables -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT
 
 
14. å…è®¸å›ç¯è®¿é—® ä¾‹ï¼šåœ¨æœåŠ¡å™¨ä¸Šå…è®¸127.0.0.1å›ç¯è®¿é—®ã€‚
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
 
 
15. å…è®¸å†…éƒ¨ç½‘ç»œåŸŸå¤–éƒ¨ç½‘ç»œçš„é€šä¿¡
é˜²ç«å¢™æœåŠ¡å™¨ä¸Šçš„å…¶ä¸­ä¸€ä¸ªç½‘å¡è¿æ¥åˆ°å¤–éƒ¨ï¼Œå¦ä¸€ä¸ªç½‘å¡è¿æ¥åˆ°å†…éƒ¨æœåŠ¡å™¨ï¼Œä½¿ç”¨ä»¥ä¸‹è§„åˆ™å…è®¸å†…éƒ¨ç½‘ç»œä¸å¤–éƒ¨ç½‘ç»œçš„é€šä¿¡ã€‚æ­¤ä¾‹ä¸­ï¼Œeth1è¿æ¥åˆ°å¤–éƒ¨ç½‘ç»œ(äº’è”ç½‘)ï¼Œeth0è¿æ¥åˆ°å†…éƒ¨ç½‘ç»œ(ä¾‹å¦‚:192.168.1.x)ã€‚
iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT
 
 
16. å…è®¸å‡ºç«™çš„DNSè¿æ¥
iptables -A OUTPUT -p udp -o eth0 --dport 53 -j ACCEPT
iptables -A INPUT -p udp -i eth0 --sport 53 -j ACCEPT
 
 
17. å…è®¸NISè¿æ¥
å¦‚æœä½ ä½¿ç”¨NISç®¡ç†ç”¨æˆ·å¸æˆ·ï¼Œä½ éœ€è¦å…è®¸NISè¿æ¥ã€‚å¦‚æœä½ ä¸å…è®¸NISç›¸å…³çš„ypbindè¿æ¥è¯·æ±‚ï¼Œå³ä½¿SSHè¿æ¥è¯·æ±‚å·²è¢«å…è®¸ï¼Œç”¨æˆ·ä»ç„¶æ— æ³•ç™»å½•ã€‚NISçš„ç«¯å£æ˜¯åŠ¨æ€çš„ï¼Œå…ˆä½¿ç”¨å‘½ä»¤rpcinfo â€“pæ¥çŸ¥é“ç«¯å£å·ï¼Œæ­¤ä¾‹ä¸­ä¸º853å’Œ850ç«¯å£ã€‚
rpcinfo -p | grep ypbind
ä¾‹ï¼šå…è®¸æ¥è‡ª111ç«¯å£ä»¥åŠypbindä½¿ç”¨ç«¯å£çš„è¿æ¥è¯·æ±‚
iptables -A INPUT -p tcp --dport 111 -j ACCEPT
iptables -A INPUT -p udp --dport 111 -j ACCEPT
iptables -A INPUT -p tcp --dport 853 -j ACCEPT
iptables -A INPUT -p udp --dport 853 -j ACCEPT
iptables -A INPUT -p tcp --dport 850 -j ACCEPT
iptables -A INPUT -p udp --dport 850 -j ACCEPT
æ³¨ï¼šå½“ä½ é‡å¯ypbindä¹‹åç«¯å£å°†ä¸åŒï¼Œä¸Šè¿°å‘½ä»¤å°†æ— æ•ˆã€‚æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š
1ï¼‰ä½¿ç”¨ä½ NISçš„é™æ€IP
2ï¼‰ç¼–å†™shellè„šæœ¬é€šè¿‡â€œrpcinfo - pâ€å‘½ä»¤è‡ªåŠ¨è·å–åŠ¨æ€ç«¯å£å·,å¹¶åœ¨ä¸Šè¿°iptablesè§„åˆ™ä¸­ä½¿ç”¨ã€‚
 
 
18. å…è®¸æ¥è‡ªæŒ‡å®šç½‘ç»œçš„rsyncè¿æ¥è¯·æ±‚
ä¾‹ï¼šå…è®¸æ¥è‡ªç½‘ç»œ192.168.101.0/24çš„rsyncè¿æ¥è¯·æ±‚
iptables -A INPUT -i eth0 -p tcp -s 192.168.101.0/24 --dport 873 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 873 -m state --state ESTABLISHED -j ACCEPT
 
 
19. å…è®¸æ¥è‡ªæŒ‡å®šç½‘ç»œçš„MySQLè¿æ¥è¯·æ±‚
å¾ˆå¤šæƒ…å†µä¸‹ï¼ŒMySQLæ•°æ®åº“ä¸webæœåŠ¡è·‘åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šã€‚æœ‰æ—¶å€™æˆ‘ä»¬ä»…å¸Œæœ›DBAå’Œå¼€å‘äººå‘˜ä»å†…éƒ¨ç½‘ç»œï¼ˆ192.168.100.0/24ï¼‰ç›´æ¥ç™»å½•æ•°æ®åº“ï¼Œå¯å°è¯•ä»¥ä¸‹å‘½ä»¤ï¼š
iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 3306 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 3306 -m state --state ESTABLISHED -j ACCEPT
 
 
20. å…è®¸Sendmail, Postfixé‚®ä»¶æœåŠ¡
Sendmailå’Œpostfixéƒ½ä½¿ç”¨äº†25ç«¯å£ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å…è®¸æ¥è‡ª25ç«¯å£çš„è¿æ¥è¯·æ±‚å³å¯ã€‚
iptables -A INPUT -i eth0 -p tcp --dport 25 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 25 -m state --state ESTABLISHED -j ACCEPT
 
 
21. å…è®¸IMAPå’ŒIMAPS ä¾‹ï¼šå…è®¸IMAP/IMAP2æµé‡ï¼Œç«¯å£ä¸º143
iptables -A INPUT -i eth0 -p tcp --dport 143 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 143 -m state --state ESTABLISHED -j ACCEPT
ä¾‹ï¼šå…è®¸IMAPSæµé‡ï¼Œç«¯å£ä¸º993
iptables -A INPUT -i eth0 -p tcp --dport 993 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 993 -m state --state ESTABLISHED -j ACCEPT
 
 
22. å…è®¸POP3å’ŒPOP3S ä¾‹ï¼šå…è®¸POP3è®¿é—®
iptables -A INPUT -i eth0 -p tcp --dport 110 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 110 -m state --state ESTABLISHED -j ACCEPT
ä¾‹ï¼šå…è®¸POP3Sè®¿é—®
iptables -A INPUT -i eth0 -p tcp --dport 995 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 995 -m state --state ESTABLISHED -j ACCEPT
 
 
23. é˜²æ­¢DoSæ”»å‡»
iptables -A INPUT -p tcp --dport 80 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT
ä¸Šè¿°ä¾‹å­ä¸­ï¼š -m limit: å¯ç”¨limitæ‰©å±• â€“limit 25/minute: å…è®¸æœ€å¤šæ¯åˆ†é’Ÿ25ä¸ªè¿æ¥ï¼ˆæ ¹æ®éœ€æ±‚æ›´æ”¹ï¼‰ã€‚ â€“limit-burst 100: åªæœ‰å½“è¿æ¥è¾¾åˆ°limit-burstæ°´å¹³(æ­¤ä¾‹ä¸º100)æ—¶æ‰å¯ç”¨ä¸Šè¿°limit/minuteé™åˆ¶ã€‚
 
 
24. ç«¯å£è½¬å‘ ä¾‹ï¼šå°†æ¥è‡ª422ç«¯å£çš„æµé‡å…¨éƒ¨è½¬åˆ°22ç«¯å£ã€‚
è¿™æ„å‘³ç€æˆ‘ä»¬æ—¢èƒ½é€šè¿‡422ç«¯å£åˆèƒ½é€šè¿‡22ç«¯å£è¿›è¡Œsshè¿æ¥ã€‚å¯ç”¨DNATè½¬å‘ã€‚
iptables -t nat -A PREROUTING -p tcp -d 192.168.102.37 --dport 422 -j DNAT --to 192.168.102.37:22
é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦å…è®¸è¿æ¥åˆ°422ç«¯å£çš„è¯·æ±‚
iptables -A INPUT -i eth0 -p tcp --dport 422 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 422 -m state --state ESTABLISHED -j ACCEPT
 
 
25. è®°å½•ä¸¢å¼ƒçš„æ•°æ®è¡¨ ç¬¬ä¸€æ­¥ï¼šæ–°å»ºåä¸ºLOGGINGçš„é“¾
iptables -N LOGGING
ç¬¬äºŒæ­¥ï¼šå°†æ‰€æœ‰æ¥è‡ªINPUTé“¾ä¸­çš„æ•°æ®åŒ…è·³è½¬åˆ°LOGGINGé“¾ä¸­
iptables -A INPUT -j LOGGING
ç¬¬ä¸‰æ­¥ï¼šä¸ºè¿™äº›åŒ…è‡ªå®šä¹‰ä¸ªå‰ç¼€ï¼Œå‘½åä¸ºâ€IPTables Packet Droppedâ€
iptables -A LOGGING -m limit --limit 2/min -j LOG --log-prefix &quot;IPTables Packet Dropped: &quot; --log-level 7
ç¬¬å››æ­¥ï¼šä¸¢å¼ƒè¿™äº›æ•°æ®åŒ…
iptables -A LOGGING -j DROP
 
 
26. ipæ˜ å°„(NAT)
å‡è®¾æœ‰ä¸€å®¶ISPæä¾›å›­åŒºInternetæ¥å…¥æœåŠ¡ï¼Œä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œè¯¥ISPåˆ†é…ç»™å›­åŒºç”¨æˆ·çš„IPåœ°å€éƒ½æ˜¯ä¼ªIPï¼Œä½†æ˜¯éƒ¨åˆ†ç”¨æˆ·è¦æ±‚å»ºç«‹è‡ªå·±çš„WWWæœåŠ¡å™¨å¯¹å¤–å‘å¸ƒä¿¡æ¯ã€‚
æˆ‘ä»¬å¯ä»¥å†é˜²ç«å¢™çš„å¤–éƒ¨ç½‘å¡ä¸Šç»‘å®šå¤šä¸ªåˆæ³•IPåœ°å€ï¼Œç„¶åé€šè¿‡ipæ˜ å°„ä½¿å‘ç»™å…¶ä¸­æŸä¸€ ä¸ªIPåœ°å€çš„åŒ…è½¬å‘è‡³å†…éƒ¨æŸä¸€ç”¨æˆ·çš„WWWæœåŠ¡å™¨ä¸Šï¼Œç„¶åå†å°†è¯¥å†…éƒ¨WWWæœåŠ¡å™¨å“åº”åŒ…ä¼ªè£…æˆè¯¥åˆæ³•IPå‘å‡ºçš„åŒ…ã€‚
 
æˆ‘ä»¬å‡è®¾ä»¥ä¸‹æƒ…æ™¯:
è¯¥ISPåˆ†é…ç»™Aå•ä½wwwæœåŠ¡å™¨çš„ipä¸º:
ä¼ªip:192.168.1.100
çœŸå®ip:202.110.123.100
è¯¥ISPåˆ†é…ç»™Bå•ä½wwwæœåŠ¡å™¨çš„ipä¸º:
ä¼ªip:192.168.1.200
çœŸå®ip:202.110.123.200
linuxé˜²ç«å¢™çš„ipåœ°å€åˆ†åˆ«ä¸º:
å†…ç½‘æ¥å£eth1:192.168.1.1
å¤–ç½‘æ¥å£eth0:202.110.123.1
ç„¶åæˆ‘ä»¬å°†åˆ†é…ç»™Aã€Bå•ä½çš„çœŸå®ipç»‘å®šåˆ°é˜²ç«å¢™çš„å¤–ç½‘æ¥å£ï¼Œä»¥rootæƒé™æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:
ifconfig eth0 add 202.110.123.100 netmask 255.255.255.0
ifconfig eth0 add 202.110.123.200 netmask 255.255.255.0
 
é¦–å…ˆï¼Œå¯¹é˜²ç«å¢™æ¥æ”¶åˆ°çš„ç›®çš„ipä¸º202.110.123.100å’Œ202.110.123.200çš„æ‰€æœ‰æ•°æ®åŒ…è¿›è¡Œç›®çš„NAT(DNAT):
iptables -A PREROUTING -i eth0 -d 202.110.123.100 -j DNAT --to 192.168.1.100
iptables -A PREROUTING -i eth0 -d 202.110.123.200 -j DNAT --to 192.168.1.200
 
å…¶æ¬¡ï¼Œå¯¹é˜²ç«å¢™æ¥æ”¶åˆ°çš„æºipåœ°å€ä¸º192.168.1.100å’Œ192.168.1.200çš„æ•°æ®åŒ…è¿›è¡ŒæºNAT(SNAT):
iptables -A POSTROUTING -o eth0 -s 192.168.1.100 -j SNAT --to 202.110.123.100
iptables -A POSTROUTING -o eth0 -s 192.168.1.200 -j SNAT --to 202.110.123.200
 
è¿™æ ·ï¼Œæ‰€æœ‰ç›®çš„ipä¸º202.110.123.100å’Œ202.110.123.200çš„æ•°æ®åŒ…éƒ½å°†åˆ†åˆ«è¢«è½¬å‘ç»™192.168.1.100å’Œ192.168.1.200;è€Œæ‰€æœ‰æ¥è‡ª192.168.1.100å’Œ192.168.1.200çš„æ•°æ®åŒ…éƒ½å°†åˆ† åˆ«è¢«ä¼ªè£…æˆç”±202.110.123.100å’Œ202.110.123.200ï¼Œä»è€Œä¹Ÿå°±å®ç°äº†ipæ˜ å°„ã€‚
</code></pre>
<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2>
<p>https://www.cnblogs.com/zejin2008/p/5919550.html<br>
https://blog.csdn.net/skc361/article/details/20481521<br>
https://www.cnblogs.com/zhujingzhi/p/9706664.html</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä½¿ç”¨iptableså®ç°ç½‘ç»œäº’è”]]></title>
        <id>https://p.guipulp.top//post/2019082702</id>
        <link href="https://p.guipulp.top//post/2019082702">
        </link>
        <updated>2019-08-27T15:34:48.000Z</updated>
        <content type="html"><![CDATA[<h2 id="iptableså®ç°ç½‘ç»œåŠŸèƒ½çš„æ–¹å¼">iptableså®ç°ç½‘ç»œåŠŸèƒ½çš„æ–¹å¼</h2>
<p>SNATï¼šä»£ç†ä¸Šç½‘å®ç°åŸåœ°å€è½¬æ¢</p>
<p>DNATï¼šç”¨äºç«¯å£è½¬å‘å®ç°ç›®æ ‡åœ°å€è½¬æ¢</p>
<p>å®ç°ä»¥ä¸Šä¸¤ç§åŠŸèƒ½å‡è¦æ‰“å¼€å†…æ ¸è·¯ç”±è½¬å‘åŠŸèƒ½</p>
<pre><code>[root@xuegod63 ~]# vim /etc/sysctl.conf
#æ”¹ï¼š#net.ipv4.ip_forward = 0
#ä¸ºï¼š net.ipv4.ip_forward = 1
#æ”¹å®Œä½¿é…ç½®ç”Ÿæ•ˆï¼š
[root@xuegod63 ~]# sysctl -p
</code></pre>
<h2 id="iptablesçš„æºåœ°å€è½¬æ¢snat">iptablesçš„æºåœ°å€è½¬æ¢(SNAT)</h2>
<h3 id="åŒç½‘å¡å®ç°snat">åŒç½‘å¡å®ç°SNAT</h3>
<p><strong>ç¤ºä¾‹ä¸€</strong></p>
<p><img src="https://img-blog.csdn.net/20171117145802662?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvd2hlYXRfZ3JvdW5k/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="Ã¨Â¿Â™Ã©Â‡ÂŒÃ¥Â†Â™Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°"></p>
<pre><code># å·¦è¾¹çš„æœºå™¨ä¸ºAï¼Œå³è¾¹çš„æœºå™¨ä¸ºB ï¼ŒAå’ŒBåœ¨åŒä¸€ä¸ªè‡ªç½‘è·¯ï¼ŒBæœ‰ä¸¤ä¸ªç½‘å¡ã€‚ä¸€ä¸ªç½‘å¡å’ŒAåŒåœ¨ä¸€ä¸ªç½‘ç»œï¼Œå¦å¤–ä¸€ä¸ªç½‘å¡å¯ä»¥è¿æ¥å¤–ç½‘ã€‚ 
# é…ç½®æ–¹å¼
[root@xuegod63 ~]# iptables -t nat -A POSTROUTING -s 192.168.240.0/24   -j  SNAT  --to 192.168.1.250
æˆ–ï¼š
[root@xuegod63 ~]#iptables -t nat -A POSTROUTING -s 192.168.2.0/24  -o eth0  -j MASQUERADE
# æ‹’ç»è®¿é—®è½¬å‘æœºå™¨æœ¬èº«
[root@xuegod63 ~]# iptables -A INPUT -s 192.168.2.2 -j DROP
</code></pre>
<p><strong>ç¤ºä¾‹äºŒ</strong></p>
<pre><code>åœºæ™¯ï¼š
æœ‰ä¸€å°AæœåŠ¡å™¨ä¸èƒ½ä¸Šç½‘ï¼Œå’ŒBæœåŠ¡å™¨é€šè¿‡å†…ç½‘æ¥è¿æ¥ï¼ŒBæœåŠ¡å™¨å¯ä»¥ä¸Šç½‘ï¼Œè¦å®ç°AæœåŠ¡å™¨ä¹Ÿå¯ä»¥ä¸Šç½‘ã€‚
A IP:192.168.0.35
B IP:192.168.0.146ï¼ˆ123.196.112.146ä¸ºå¤–ç½‘ipï¼‰

SNAT:æ”¹å˜æ•°æ®åŒ…çš„æºåœ°å€ã€‚é˜²ç«å¢™ä¼šä½¿ç”¨å¤–éƒ¨åœ°å€ï¼Œæ›¿æ¢æ•°æ®åŒ…çš„æœ¬åœ°ç½‘ç»œåœ°å€ã€‚è¿™æ ·ä½¿ç½‘ç»œå†…éƒ¨ä¸»æœºèƒ½å¤Ÿä¸ç½‘ç»œå¤–éƒ¨é€šä¿¡ã€‚

1.åœ¨å¯ä»¥ä¸Šç½‘é‚£å°æœåŠ¡å™¨Bä¸Šï¼Œå¼€å¯å†…æ ¸è·¯ç”±è½¬å‘åŠŸèƒ½
echo 1 &gt; /proc/sys/net/ipv4/ip_forward

2.åœ¨éœ€è¦é€šè¿‡ä»£ç†ä¸Šç½‘æœåŠ¡å™¨Aä¸Šï¼ŒæŸ¥çœ‹è·¯ç”±è¡¨ã€‚å¹¶æ·»åŠ é»˜è®¤ç½‘å…³ã€‚route add default gw 192.168.0.146
[root@localhost ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.0.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
169.254.0.0     0.0.0.0         255.255.0.0     U     0      0        0 eth0
0.0.0.0         192.168.0.146   0.0.0.0         UG    0      0        0 eth0

3.åœ¨å¯ä»¥ä¸Šç½‘é‚£å°æœåŠ¡å™¨Bä¸Šæ·»åŠ SNATè§„åˆ™
iptables -t nat -A POSTROUTING -o eth0 -s 192.168.0.0/24 -j SNAT â€“-to 123.196.112.146

4.ä¿å­˜
service iptables save

5.éªŒè¯æ˜¯å¦å¯ä»¥æ­£å¸¸ä¸Šç½‘ã€‚
</code></pre>
<h3 id="å•ç½‘å¡å®ç°snat">å•ç½‘å¡å®ç°SNAT</h3>
<p><strong>ç¤ºä¾‹</strong></p>
<pre><code>åœºæ™¯ï¼š
ç»™è½¬å‘æœºå™¨ç½‘å¡ç»‘å®šä¸¤ä¸ªIPã€‚ä¸€ä¸ªå†…ç½‘IPï¼Œæ— éœ€è®¾ç½®ç½‘å…³ï¼Œå¦ä¸€ä¸ªæ¥å£ï¼ŒIPè¦å¯ä»¥è¿æ¥internetã€‚
ç›´æ¥å°†ä¸‹é¢å†…å®¹åŠ åœ¨ /etc/rc.local å¯åŠ¨è„šæœ¬å†…ï¼ˆæŠŠ192.168.51.250æ¢æˆå¤–ç½‘IPï¼ŒæŠŠ192.168.151.1æ¢å†…ç½‘çš„ç½‘ç»œåœ°å€ï¼‰

echo 1 &gt; /proc/sys/net/ipv4/ip_forward
ifconfig eth0:1 192.168.151.1 netmask 255.255.255.0
iptables -F
iptables -F -t nat
iptables -P FORWARD DROP
iptables -A FORWARD -s 192.168.151.0/24 -j ACCEPT
iptables -A FORWARD -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -t nat -A POSTROUTING -o eth0 -s 192.168.151.0/24 -j SNAT --to 192.168.51.250
</code></pre>
<h2 id="iptablesçš„ç›®æ ‡åœ°å€è½¬æ¢dnat">iptablesçš„ç›®æ ‡åœ°å€è½¬æ¢ï¼ˆDNATï¼‰</h2>
<h3 id="åŒç½‘å¡å®ç°dnat">åŒç½‘å¡å®ç°DNAT</h3>
<pre><code># ä»£ç†192.168.0.10çš„80ç«¯å£åˆ°NATæœåŠ¡å™¨
# NATæœåŠ¡å™¨IPï¼š 172.16.0.1  192.168.0.1
# æœåŠ¡ç«¯IPï¼š 192.168.0.10 éœ€è¦å°†æœåŠ¡ç«¯çš„ç½‘å…³æŒ‡å‘NATæœåŠ¡å™¨
# åšDNATè½¬å‘ï¼š
iptables -t nat -A PREROUTING -i ens33 -d 172.16.0.1 -p tcp --dport  80 -j DNAT --to-destination 192.168.0.10
</code></pre>
<h3 id="å•ç½‘å¡å®ç°dnat">å•ç½‘å¡å®ç°DNAT</h3>
<p><strong>è¯´æ˜</strong></p>
<pre><code>A)å°†æœ¬æœºç«¯å£è½¬å‘è‡³ç›®æ ‡æœºå™¨
iptables -t nat -A PREROUTING -p tcp -d [æœ¬åœ°æœåŠ¡å™¨ä¸»ç½‘å¡ç»‘å®šIP] â€“dport [æœ¬åœ°ç«¯å£] -j DNAT â€“to-destination [ç›®æ ‡IP:ç›®æ ‡ç«¯å£]
iptables -t nat -A PREROUTING -p udp -d [æœ¬åœ°æœåŠ¡å™¨ä¸»ç½‘å¡ç»‘å®šIP] â€“dport [æœ¬åœ°ç«¯å£] -j DNAT â€“to-destination [ç›®æ ‡IP:ç›®æ ‡ç«¯å£]

B)å°†ç›®æ ‡æœºå™¨è¿”å›çš„æ•°æ®è½¬å‘è‡³æœ¬æœº
iptables -t nat -A POSTROUTING -p tcp -d [ç›®æ ‡IP] â€“dport [ç›®æ ‡ç«¯å£] -j SNAT â€“to-source [æœ¬åœ°æœåŠ¡å™¨ä¸»ç½‘å¡ç»‘å®šIP]
iptables -t nat -A POSTROUTING -p udp -d [ç›®æ ‡IP] â€“dport [ç›®æ ‡ç«¯å£] -j SNAT â€“to-source [æœ¬åœ°æœåŠ¡å™¨ä¸»ç½‘å¡ç»‘å®šIP]
</code></pre>
<p><strong>ç¤ºä¾‹</strong></p>
<pre><code># å•ç½‘å¡iptablesé…ç½®è·¯ç”±è½¬å‘ï¼Œéœ€è¦é…ç½®snatå’Œdnat
# pc1 ip:192.168.23.252 
# pc2 ip:192.168.23.253 

iptables -t nat -A PREROUTING -d 192.168.23.252 -p tcp --dport 80 -j DNAT --to-destination 192.168.23.253:80
# å¦‚æœè¿›æ¥çš„routeçš„è®¿é—®ç›®çš„åœ°å€æ˜¯192.168.23.252å¹¶ä¸”è®¿é—®çš„ç›®çš„ç«¯å£æ˜¯80ï¼Œå°±è¿›è¡Œdnatè½¬æ¢ï¼ŒæŠŠç›®çš„åœ°å€æ”¹ä¸º192.168.23.253 ï¼Œç«¯å£è¿˜æ˜¯80
 
iptables -t nat -A POSTROUTING -d 192.168.23.253 -p tcp --dport 80 -j SNAT --to 192.168.23.252
# å½“FORWARD å‡ºæ¥åï¼Œè®¿é—®çš„ç›®çš„åœ°å€æ˜¯192.168.23.253ï¼Œç«¯å£æ˜¯80çš„ã€‚è¿›è¡Œsnatåœ°å€è½¬æ¢ï¼ŒæŠŠåŸåœ°å€æ”¹ä¸º192.168.23.252
 
iptables -A FORWARD -o eth0 -d 192.168.23.253 -p tcp --dport 80 -j ACCEPT
# å½“ä»eth0å‡ºå»çš„è®¿é—®ç›®çš„åœ°å€æ˜¯ 192.168.23.253ä¸”ç›®çš„ç«¯å£æ˜¯80çš„routeï¼Œå…è®¸é€šè¿‡
 
iptables -A FORWARD -i eth0 -s 192.168.23.253 -p tcp --dport 80 -j ACCEPT
# å½“ä»eth0è¿›æ¥çš„åŸåœ°å€æ˜¯ 192.168.23.253ä¸”ç›®çš„ç«¯å£æ˜¯80çš„routeï¼Œå…è®¸é€šè¿‡
 
# ä¿å­˜è§„åˆ™å¯åŠ¨iptables
service iptables save
service iptables start
</code></pre>
<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>
<p>https://blog.csdn.net/wheat_ground/article/details/78561750</p>
<p>https://blog.51cto.com/jinchuang/1947052</p>
<p>http://www.flynoc.com/help/helpview_390.html</p>
<p>https://blog.51cto.com/2333657/2157070?source=dra</p>
<p>https://blog.csdn.net/weixin_42537861/article/details/81195070</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä½¿ç”¨ipvsæ¨¡å¼å®‰è£…kubernetes]]></title>
        <id>https://p.guipulp.top//post/2019082701</id>
        <link href="https://p.guipulp.top//post/2019082701">
        </link>
        <updated>2019-08-27T07:11:33.000Z</updated>
        <content type="html"><![CDATA[<h3 id="å®‰è£…ipvs">å®‰è£…ipvs</h3>
<pre><code>cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF
$ chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4

</code></pre>
<h3 id="å®‰è£…ipsetå’Œipvsadm">å®‰è£…ipsetå’Œipvsadm</h3>
<pre><code>yum install ipset
yum install ipvsadm
</code></pre>
<h3 id="å®‰è£…æ—¶é—´æœåŠ¡">å®‰è£…æ—¶é—´æœåŠ¡</h3>
<pre><code>$ yum install chrony -y
$ systemctl enable chronyd
$ systemctl start chronyd
$ chronyc sources
210 Number of sources = 4
MS Name/IP address         Stratum Poll Reach LastRx Last sample
===============================================================================
^+ sv1.ggsrv.de                  2   6    17    32   -823us[-1128us] +/-   98ms
^- montreal.ca.logiplex.net      2   6    17    32    -17ms[  -17ms] +/-  179ms
^- ntp6.flashdance.cx            2   6    17    32    -32ms[  -32ms] +/-  161ms
^* 119.28.183.184                2   6    33    32   +661us[ +357us] +/-   38ms
$ date
Tue Aug 27 09:28:41 CST 2019
</code></pre>
<h3 id="å®‰è£…ipvsæ¨¡å¼çš„kubernetesé›†ç¾¤æ¨¡æ¿">å®‰è£…ipvsæ¨¡å¼çš„kubernetesé›†ç¾¤æ¨¡æ¿</h3>
<pre><code>apiVersion: kubeadm.k8s.io/v1beta2
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 10.151.30.11  # apiserver èŠ‚ç‚¹å†…ç½‘IP
  bindPort: 6443
nodeRegistration:
  criSocket: /var/run/dockershim.sock
  name: ydzs-master
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta2
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: {}
dns:
  type: CoreDNS  # dnsç±»å‹
etcd:
  local:
    dataDir: /var/lib/etcd
imageRepository: gcr.azk8s.cn/google_containers
kind: ClusterConfiguration
kubernetesVersion: v1.15.3  # k8sç‰ˆæœ¬
networking:
  dnsDomain: cluster.local
  podSubnet: 192.168.0.0/16
  serviceSubnet: 10.96.0.0/12
scheduler: {}
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: ipvs  # kube-proxy æ¨¡å¼
</code></pre>
<h3 id="å‚è€ƒåœ°å€">å‚è€ƒåœ°å€</h3>
<p>https://mp.weixin.qq.com/s/vnriX2bTtnkv8i2UpLeNnA</p>
<p>https://www.qikqiak.com/post/use-kubeadm-install-kubernetes-1.15.3/</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetesçš„å›½å†…è½¯ä»¶æºé…ç½®]]></title>
        <id>https://p.guipulp.top//post/2019080801</id>
        <link href="https://p.guipulp.top//post/2019080801">
        </link>
        <updated>2019-08-08T06:40:52.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ubuntu-è½¯ä»¶æºé…ç½®">ubuntu è½¯ä»¶æºé…ç½®</h2>
<pre><code>add-apt-repository &quot;deb https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main&quot;
add-apt-repository &quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;
wget -q https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg -O- | sudo apt-key add -
curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
apt-get update
apt-get -y install apt-transport-https ca-certificates curl software-properties-common
apt-get -y install docker-ce kubeadm kubectl kubelet
systemctl enable docker kubelet &amp;&amp; systemctl start docker
</code></pre>
<h2 id="centos-è½¯ä»¶æºé…ç½®">centos è½¯ä»¶æºé…ç½®</h2>
<pre><code># åˆ‡æ¢åˆ°é…ç½®ç›®å½•
cd /etc/yum.repos.d/
# é…ç½®docker-ceé˜¿é‡Œæº
wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# é…ç½®kubernetesé˜¿é‡Œæº
cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[centoså¿«é€Ÿåˆ›å»ºkubernetes]]></title>
        <id>https://p.guipulp.top//post/2019090701</id>
        <link href="https://p.guipulp.top//post/2019090701">
        </link>
        <updated>2019-08-07T08:22:17.000Z</updated>
        <content type="html"><![CDATA[<h2 id="å‰ç½®æ¡ä»¶">å‰ç½®æ¡ä»¶</h2>
<ul>
<li>ç³»ç»Ÿè¦æ±‚:64ä½centos7.6</li>
<li>å…³é—­é˜²ç«å¢™å’Œselinux</li>
<li>å…³é—­æ“ä½œç³»ç»Ÿswapåˆ†åŒº(ä½¿ç”¨k8sä¸æ¨èæ‰“å¼€)</li>
</ul>
<h2 id="ç¯å¢ƒè¯´æ˜">ç¯å¢ƒè¯´æ˜</h2>
<p>æœ¬æ‰‹å†Œå®‰è£…æ–¹å¼é€‚ç”¨äºå•èŠ‚ç‚¹æµ‹è¯•éƒ¨ç½²</p>
<h2 id="å‡†å¤‡å·¥ä½œæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ">å‡†å¤‡å·¥ä½œ(æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ)</h2>
<h3 id="dockerå’Œkubernetesè½¯ä»¶æºé…ç½®">Dockerå’Œkubernetesè½¯ä»¶æºé…ç½®</h3>
<pre><code># åˆ‡æ¢åˆ°é…ç½®ç›®å½•
cd /etc/yum.repos.d/
# é…ç½®docker-ceé˜¿é‡Œæº
wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# é…ç½®kubernetesé˜¿é‡Œæº
cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
</code></pre>
<h3 id="é…ç½®å†…æ ¸ç›¸å…³å‚æ•°">é…ç½®å†…æ ¸ç›¸å…³å‚æ•°</h3>
<pre><code>cat &lt;&lt;EOF &gt;  /etc/sysctl.d/ceph.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
</code></pre>
<h3 id="å®‰è£…ç›¸åº”è½¯ä»¶åŒ…">å®‰è£…ç›¸åº”è½¯ä»¶åŒ…</h3>
<pre><code># å®‰è£…kubeadm kubelet kubectl
yum install docker-ce kubeadm kubectl kubelet -y

# å¼€æœºå¯åŠ¨kubeletå’Œdocker
systemctl enable docker kubelet

# å¯åŠ¨docker
systemctl start docker
</code></pre>
<h2 id="éƒ¨ç½²">éƒ¨ç½²</h2>
<h3 id="å®‰è£…k8s">å®‰è£…k8s</h3>
<pre><code># 30.4.241.19 éœ€è¦æ›´æ–°ä¸ºå½“å‰éƒ¨ç½²èŠ‚ç‚¹ipåœ°å€
kubeadm init --apiserver-advertise-address 30.4.241.19 --pod-network-cidr=10.244.0.0/16 --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers --ignore-preflight-errors=Swap

# åˆå§‹åŒ–å®ŒæˆåæŒ‰æç¤ºæ‰§è¡Œä»¥ä¸‹å‘½ä»¤
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<h3 id="å®‰è£…flannel">å®‰è£…flannel</h3>
<pre><code>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre>
<h3 id="æ£€æŸ¥æ˜¯å¦å®‰è£…å®Œæˆ">æ£€æŸ¥æ˜¯å¦å®‰è£…å®Œæˆ</h3>
<pre><code>root@k8s4:~# kubectl  get nodes
NAME   STATUS   ROLES    AGE   VERSION
k8s4   Ready    master   20m   v1.14.2
root@k8s4:~# kubectl  get nodes
NAME   STATUS   ROLES    AGE   VERSION
k8s4   Ready    master   20m   v1.14.2
root@k8s4:~# kubectl  get pods --all-namespaces
NAMESPACE     NAME                           READY   STATUS    RESTARTS   AGE
kube-system   coredns-8cc96f57d-cfr4j        1/1     Running   0          20m
kube-system   coredns-8cc96f57d-stcz6        1/1     Running   0          20m
kube-system   etcd-k8s4                      1/1     Running   0          19m
kube-system   kube-apiserver-k8s4            1/1     Running   0          19m
kube-system   kube-controller-manager-k8s4   1/1     Running   0          19m
kube-system   kube-flannel-ds-amd64-k4q6q    1/1     Running   0          50s
kube-system   kube-proxy-lhjsf               1/1     Running   0          20m
kube-system   kube-scheduler-k8s4            1/1     Running   0          19m
</code></pre>
<h3 id="æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨">æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨</h3>
<pre><code># å–æ¶ˆèŠ‚ç‚¹æ±¡ç‚¹,ä½¿masterèƒ½è¢«æ­£å¸¸è°ƒåº¦, k8s4è¯·æ›´æ”¹ä¸ºä½ è‡ªæœ‰é›†ç¾¤çš„nodename
kubectl  taint node k8s4 node-role.kubernetes.io/master:NoSchedule-

# åˆ›å»ºnginx deploy
root@k8s4:~# kubectl  create deploy nginx --image nginx
deployment.apps/nginx created

root@k8s4:~# kubectl  get pods
NAME                     READY   STATUS    RESTARTS   AGE
nginx-65f88748fd-9sk6z   1/1     Running   0          2m44s

# æš´éœ²nginxåˆ°é›†ç¾¤å¤–
root@k8s4:~# kubectl  expose deploy nginx --port=80 --type=NodePort
service/nginx exposed
root@k8s4:~# kubectl  get svc
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP        25m
nginx        NodePort    10.104.109.234   &lt;none&gt;        80:32129/TCP   5s
root@k8s4:~# curl 127.0.0.1:32129
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetes NVIDIA GPU å®è·µ]]></title>
        <id>https://p.guipulp.top//post/201986</id>
        <link href="https://p.guipulp.top//post/201986">
        </link>
        <updated>2019-08-06T03:36:20.000Z</updated>
        <content type="html"><![CDATA[<p>æŸ¥çœ‹æ­¤æ–‡æ¡£æ—¶å€™ï¼Œå†…å®¹å¯èƒ½å·²ç»è¿‡æ—¶ï¼Œä½†å¤§ä½“è¿‡ç¨‹ä¸ä¼šæœ‰ä»€ä¹ˆå˜åŒ–ï¼Œå»ºè®®æŒ‰ç…§å®˜ç½‘è¯´æ˜è¿›è¡Œå®‰è£…ã€‚</p>
<h3 id="å‰ç½®æ¡ä»¶">å‰ç½®æ¡ä»¶</h3>
<ol>
<li>GNU/Linux x86_64 with kernel version &gt; 3.10</li>
<li>Docker &gt;= 1.12</li>
<li>NVIDIA GPU with Architecture &gt; Fermi (2.1)</li>
<li><a href="http://www.nvidia.com/object/unix.html">NVIDIA drivers</a> ~= 361.93 (untested on older versions)</li>
</ol>
<h3 id="å®‰è£…nvidia-docker">å®‰è£…nvidia-docker</h3>
<h4 id="ubuntu-16041804-debian-jessiestretch">Ubuntu 16.04/18.04, Debian Jessie/Stretch</h4>
<pre><code># Add the package repositories
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list

sudo apt-get update &amp;&amp; sudo apt-get install -y nvidia-container-toolkit
sudo systemctl restart docker
</code></pre>
<h4 id="centos-7-docker-ce-rhel-7475-docker-ce-amazon-linux-12">CentOS 7 (docker-ce), RHEL 7.4/7.5 (docker-ce), Amazon Linux 1/2</h4>
<pre><code>distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.repo | sudo tee /etc/yum.repos.d/nvidia-docker.repo

sudo yum install -y nvidia-container-toolkit
sudo systemctl restart docker
</code></pre>
<h4 id="è®¾ç½®nvidia-docker-runtime">è®¾ç½®nvidia-docker runtime</h4>
<pre><code># vim /etc/docker/daemon.json
{
    &quot;default-runtime&quot;: &quot;nvidia&quot;,
    &quot;runtimes&quot;: {
        &quot;nvidia&quot;: {
            &quot;path&quot;: &quot;/usr/bin/nvidia-container-runtime&quot;,
            &quot;runtimeArgs&quot;: []
        }
    }
}

# restart docker
sudo systemctl restart docker
sudo systemctl restart kubelet
</code></pre>
<h4 id="æµ‹è¯•nvidia-docker">æµ‹è¯•nvidia-docker</h4>
<pre><code>#### Test nvidia-smi with the latest official CUDA image
$ docker run --gpus all nvidia/cuda:9.0-base nvidia-smi

# Start a GPU enabled container on two GPUs
$ docker run --gpus 2 nvidia/cuda:9.0-base nvidia-smi

# Starting a GPU enabled container on specific GPUs
$ docker run --gpus '&quot;device=1,2&quot;' nvidia/cuda:9.0-base nvidia-smi
$ docker run --gpus '&quot;device=UUID-ABCDEF,1'&quot; nvidia/cuda:9.0-base nvidia-smi

# Specifying a capability (graphics, compute, ...) for my container
# Note this is rarely if ever used this way
$ docker run --gpus all,capabilities=utility nvidia/cuda:9.0-base nvidia-smi
</code></pre>
<h3 id="å®‰è£…kubernetes-æ’ä»¶">å®‰è£…kubernetes æ’ä»¶</h3>
<pre><code>kubectl create -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/1.0.0-beta/nvidia-device-plugin.yml
</code></pre>
<h3 id="æµ‹è¯•è¿è¡Œgpu">æµ‹è¯•è¿è¡ŒGPU</h3>
<pre><code># é€‚ç”¨äºå¤šGPUæ ¸å¿ƒçš„å¸¦ä¼ä¸šæ˜¾å¡çš„é›†ç¾¤æµ‹è¯•
apiVersion: v1
kind: Pod
metadata:
  name: gpu-pod
spec:
  containers:
    - name: cuda-container
      image: nvidia/cuda:9.0-devel
      resources:
        limits:
          nvidia.com/gpu: 2 # requesting 2 GPUs
    - name: digits-container
      image: nvidia/digits:6.0
      resources:
        limits:
          nvidia.com/gpu: 2 # requesting 2 GPUs
</code></pre>
<pre><code># é€‚ç”¨äºä¸ªäººGPUæµ‹è¯•
kubectl  create job nvjob --image=nvidia/cuda:9.0-base -- nvidia-smi
</code></pre>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a href="https://github.com/NVIDIA/nvidia-docker">https://github.com/NVIDIA/nvidia-docker</a></p>
<p><a href="https://github.com/NVIDIA/k8s-device-plugin">https://github.com/NVIDIA/k8s-device-plugin</a></p>
<p><a href="https://kubernetes.io/docs/tasks/manage-gpus/scheduling-gpus/">https://kubernetes.io/docs/tasks/manage-gpus/scheduling-gpus/</a></p>
<p><a href="https://github.com/nvidia/nvidia-docker/wiki/Installation-(version-2.0)#prerequisites">https://github.com/nvidia/nvidia-docker/wiki/Installation-(version-2.0)#prerequisites</a></p>
]]></content>
    </entry>
</feed>